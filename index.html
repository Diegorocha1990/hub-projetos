<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Eficiência Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --success-color: #10b981;
            --bg-body: #f8fafc;
            --color-backlog: #94a3b8;
            --color-andamento: #fabd23;
            --color-finalizado: #10b981;
            --color-despriorizado: #ef4444;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
            -webkit-font-smoothing: antialiased;
        }
        .input-premium {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.65rem 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            font-weight: 600;
            font-size: 0.85rem;
            width: 100%;
        }
        .input-premium:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.08);
        }
        .label-forte {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 0.6rem;
            display: block;
        }
        .active-tab {
            color: var(--primary-color);
            border-bottom: 3px solid var(--accent-color);
            font-weight: 900;
        }
        .kpi-card {
            background: white;
            padding: 1.5rem 1rem;
            border-radius: 1.5rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            gap: 0.4rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }
        .form-section-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        @media (min-width: 768px) { .form-section-box { padding: 2.5rem; } }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 0.85rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            border: 1px solid #f1f5f9;
        }
        .checkbox-item:hover { background: #f8fafc; border-color: #e2e8f0; }
        .checkbox-item input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            background: white;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .checkbox-item input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .checkbox-item input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            color: #000a28;
            font-size: 12px;
            font-weight: 900;
            left: 50%; top: 45%; transform: translate(-50%, -50%);
        }
        .checkbox-item span { font-size: 0.8rem; font-weight: 700; color: #334155; }
        .toggle-btn {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .toggle-btn.active-risco { background: #fef3c7; border-color: #fbbf24; color: #92400e; }
        .toggle-btn.active-problema { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .toggle-btn.inactive { background: #f8fafc; color: #94a3b8; border-color: #e2e8f0; }
        .card-project { background: white; border-radius: 24px; border: 1px solid #e2e8f0; transition: all 0.3s ease; border-top-width: 12px; overflow: hidden; }
        .status-pill { 
            font-size: 0.6rem; 
            font-weight: 900; 
            padding: 4px 12px; 
            border-radius: 100px; 
            text-transform: uppercase; 
            white-space: nowrap; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            min-width: 110px;
            height: 24px;
        }
        .btn-add-item { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: #f1f5f9; color: #64748b; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-left: 8px; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 999px; height: 8px; overflow: hidden; margin-top: 4px; }
        .progress-bar-fill { height: 100%; background-color: var(--success-color); transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .history-entry p { white-space: pre-wrap; word-wrap: break-word; }
        
        .history-entry { padding: 0.75rem; background-color: #f8fafc; border-radius: 1rem; border: 1px solid #f1f5f9; margin-bottom: 0.5rem; }
        .task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: #fff; border: 1px solid #f1f5f9; border-radius: 10px; margin-bottom: 0.5rem; }
        .column-board { background: rgba(226, 232, 240, 0.3); border-radius: 1.5rem; padding: 1.25rem; min-height: 400px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 10, 40, 0.5); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 2rem; border-radius: 2rem; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .count-badge { padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 900; min-width: 24px; text-align: center; }
        
        /* Planeamento Estilos */
        .card-planning { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 20px; padding: 1.25rem; box-shadow: 0 4px 15px -5px rgba(0,0,0,0.05); }
        .cycle-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; padding: 1.5rem; position: relative; border-left: 8px solid #00e5ff; transition: all 0.2s; }
        .cycle-card:hover { transform: translateX(5px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); }
        .kpi-row { display: grid; grid-template-cols: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem; }
        .kpi-input-box { display: flex; flex-direction: column; }
        .kpi-input-box label { font-size: 9px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }

        @media print { .no-print { display: none !important; } body { background: white; padding: 0; } .form-section-box { border: 1px solid #eee; break-inside: avoid; } }
    </style>
</head>
<body class="min-h-screen">
    <div id="loading-overlay" style="position: fixed; inset: 0; background: var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: white; transition: opacity 0.5s;">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-24 md:w-32 mb-8 invert" alt="Unico">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
    </div>

    <!-- MODAIS -->
    <div id="confirm-exit-modal" class="modal-overlay">
        <div class="modal-content text-center text-slate-800">
            <h3 class="text-xl md:text-2xl font-black mb-2 uppercase tracking-tighter text-slate-800">Alterações não salvas</h3>
            <p class="text-slate-500 mb-8 font-medium text-sm">Deseja salvar o progresso antes de sair?</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.saveAndExit()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-slate-800 transition-all">Salvar e Sair</button>
                <button onclick="window.discardAndExit()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-slate-200 transition-all">Descartar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EXCLUSÃO (REATORADO PARA SER GENÉRICO) -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content text-center text-slate-800">
            <h3 id="delete-modal-title" class="text-xl md:text-2xl font-black mb-2 uppercase tracking-tighter text-slate-800">Excluir Item?</h3>
            <p class="text-slate-500 mb-8 font-medium text-sm">A remoção será permanente.</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.confirmDelete()" class="flex-1 bg-red-500 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] hover:bg-red-600 transition-all">Confirmar</button>
                <button onclick="window.closeDeleteModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px] hover:bg-slate-200 transition-all">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="add-item-title" class="text-xl font-black mb-6 uppercase tracking-tighter text-slate-800">Adicionar Opção</h3>
            <input type="text" id="new-item-input" class="input-premium mb-8" placeholder="Digite o nome...">
            <div class="flex gap-3">
                <button onclick="window.processAddItem()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] shadow-xl">Adicionar</button>
                <button onclick="window.closeAddModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">Sair</button>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL PARA ADICIONAR ANO NO PLANEAMENTO -->
    <div id="add-year-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 class="text-xl font-black mb-6 uppercase tracking-tighter text-slate-800">NOVO ANO</h3>
            <input type="number" id="new-year-input" class="input-premium mb-8 text-center text-lg" placeholder="Ex: 2028">
            <div class="flex gap-3">
                <button onclick="window.addNewYearPlanning()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] shadow-xl">ADICIONAR</button>
                <button onclick="document.getElementById('add-year-modal').style.display='none'" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">CANCELAR</button>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 md:h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 md:gap-8">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-6" alt="Unico">
                <div id="sync-indicator" class="hidden sm:flex items-center gap-2 px-3 md:px-4 py-1.5 bg-green-50 rounded-full border border-green-100">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[8px] md:text-[10px] font-black text-green-600 uppercase tracking-widest">Tempo Real</span>
                </div>
            </div>
            <nav class="flex gap-4 md:gap-10 h-full items-center text-[9px] md:text-[11px] font-bold uppercase tracking-widest text-slate-400">
                <button onclick="window.trySwitchTab('dashboard')" id="tab-dashboard" class="h-full px-1 md:px-2 active-tab">Dash</button>
                <button onclick="window.trySwitchTab('planning')" id="tab-planning" class="h-full px-1 md:px-2 hover:text-slate-900">Planeamento</button>
                <button onclick="window.trySwitchTab('form')" id="tab-form" class="h-full px-1 md:px-2 hover:text-slate-900">Novo</button>
                <button onclick="window.trySwitchTab('list')" id="tab-list" class="h-full px-1 md:px-2 hover:text-slate-900">Projetos</button>
                <button onclick="window.trySwitchTab('archive')" id="tab-archive" class="h-full px-1 md:px-2 hover:text-slate-900">Arquivo</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 mt-2 md:mt-4">
        <!-- VIEW DASHBOARD -->
        <div id="view-dashboard" class="block no-print">
            <div class="mb-8 md:mb-12 flex flex-col xl:flex-row xl:items-end justify-between gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Estratégia & Operação</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Painel de Decisões e Eficiência</p>
                </div>
                <div class="flex flex-wrap gap-2 md:gap-3 items-center">
                    <div class="flex flex-col gap-2">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="dash-search" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Buscar projeto..." oninput="window.refreshUI()">
                            <select id="dash-filter-period" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="all">Todo o Período</option>
                                <option value="mes">Mensal</option>
                                <option value="trimestre">Trimestral</option>
                                <option value="ano">Anual</option>
                            </select>
                            <select id="dash-filter-analista" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Analistas (Todos)</option>
                            </select>
                            <select id="dash-filter-area" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Áreas (Todas)</option>
                            </select>
                            <select id="dash-filter-frente" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Frentes (Todas)</option>
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <select id="dash-filter-classificacao" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Classificação (Todas)</option>
                                <option value="Eficiência Operacional">Eficiência Operacional</option>
                                <option value="Rotina">Rotina</option>
                            </select>
                            <select id="dash-filter-estrutura" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Estrutura (Todas)</option>
                                <option value="Análise">Análise</option>
                                <option value="Clientes">Clientes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6 mb-8 md:mb-12">
                <div class="kpi-card"><p class="label-forte !mb-0 text-[9px]">Total</p><h2 id="kpi-total" class="text-2xl md:text-3xl font-black">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-cyan-500 text-[9px]">SLA Geral</p><h2 id="kpi-sla" class="text-2xl md:text-3xl font-black text-cyan-500">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-green-500 text-[9px]">Aderência</p><h2 id="kpi-performance" class="text-2xl md:text-3xl font-black text-green-500">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-blue-500 text-[9px]">Riscos</p><h2 id="kpi-riscos" class="text-xl md:text-2xl font-black text-blue-500">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-red-500 text-[9px]">Problemas</p><h2 id="kpi-problemas" class="text-xl md:text-2xl font-black text-red-500">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-indigo-500 text-[9px]">Saúde</p><h2 id="kpi-saude" class="text-2xl md:text-3xl font-black text-indigo-500">100%</h2></div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8 mb-8 md:mb-12">
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Status</span><div class="w-full h-40 md:h-44"><canvas id="chartStatus"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Área</span><div class="w-full h-40 md:h-44"><canvas id="chartTime"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Frentes Ativas</span><div class="w-full h-40 md:h-44"><canvas id="chartFrente"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Lead Time Médio</span><div class="w-full h-40 md:h-44"><canvas id="chartLeadTime"></canvas></div></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="column-board">
                    <label class="label-forte text-slate-400 mb-6 flex justify-between items-center">
                        <span>Backlog</span>
                        <span id="count-backlog" class="bg-[#94a3b8] text-white px-3 py-1 rounded-full text-[10px] font-black">0</span>
                    </label>
                    <div id="grid-backlog" class="space-y-6"></div>
                </div>
                <div class="column-board">
                    <label class="label-forte text-slate-400 mb-6 flex justify-between items-center">
                        <span>Em Andamento</span>
                        <span id="count-andamento" class="bg-[#fabd23] text-[#000a28] px-3 py-1 rounded-full text-[10px] font-black">0</span>
                    </label>
                    <div id="grid-andamento" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- VIEW PLANEAMENTO -->
        <div id="view-planning" class="hidden no-print">
            <div class="mb-10">
                <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Performance Operacional</h1>
                <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Definição de metas e acompanhamento do realizado</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Inputs Left Column -->
                <div class="lg:col-span-5 space-y-6">
                    <div class="form-section-box !mb-0">
                        <div class="flex items-center gap-6 mb-8">
                            <div class="flex-1">
                                <label class="label-forte">Semestre</label>
                                <select id="planning-semester" class="input-premium font-bold">
                                    <option value="H1">H1 (Janeiro - Junho)</option>
                                    <option value="H2">H2 (Julho - Dezembro)</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="label-forte">Ano</label>
                                <div class="flex gap-2">
                                    <select id="planning-year" class="input-premium font-bold">
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                    </select>
                                    <button onclick="document.getElementById('add-year-modal').style.display='flex'" class="btn-add-item !w-10 !h-10 !rounded-xl !ml-0 text-lg">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Group: Custo Analise -->
                        <div class="mb-8 pb-6 border-b border-slate-50">
                            <h4 class="label-forte !text-slate-900 !mb-4">Custo por Análise (R$)</h4>
                            <div class="kpi-row">
                                <div class="kpi-input-box"><label>Baseline</label><input type="number" step="0.01" id="plan-ca-b" class="input-premium !py-2 !px-3" placeholder="0,00"></div>
                                <div class="kpi-input-box"><label>Meta</label><input type="number" step="0.01" id="plan-ca-m" class="input-premium !py-2 !px-3" placeholder="0,00"></div>
                                <div class="kpi-input-box"><label>Real</label><input type="number" step="0.01" id="plan-ca-r" class="input-premium !py-2 !px-3" placeholder="0,00"></div>
                            </div>
                        </div>

                        <!-- KPI Group: Custo Chamado -->
                        <div class="mb-8 pb-6 border-b border-slate-50">
                            <h4 class="label-forte !text-slate-900 !mb-4">Custo por Chamado (R$)</h4>
                            <div class="kpi-row">
                                <div class="kpi-input-box"><label>Baseline</label><input type="number" step="0.01" id="plan-cc-b" class="input-premium !py-2 !px-3" placeholder="0,00"></div>
                                <div class="kpi-input-box"><label>Meta</label><input type="number" step="0.01" id="plan-cc-m" class="input-premium !py-2 !px-3" placeholder="0,00"></div>
                                <div class="kpi-input-box"><label>Real</label><input type="number" step="0.01" id="plan-cc-r" class="input-premium !py-2 !px-3" placeholder="0,00"></div>
                            </div>
                        </div>

                        <!-- KPI Group: Qualidade -->
                        <div class="mb-8 pb-6 border-b border-slate-50">
                            <h4 class="label-forte !text-slate-900 !mb-4">Qualidade Onboarding (%)</h4>
                            <div class="kpi-row">
                                <div class="kpi-input-box"><label>Baseline</label><input type="number" step="0.1" id="plan-qo-b" class="input-premium !py-2 !px-3" placeholder="0%"></div>
                                <div class="kpi-input-box"><label>Meta</label><input type="number" step="0.1" id="plan-qo-m" class="input-premium !py-2 !px-3" placeholder="0%"></div>
                                <div class="kpi-input-box"><label>Real</label><input type="number" step="0.1" id="plan-qo-r" class="input-premium !py-2 !px-3" placeholder="0%"></div>
                            </div>
                        </div>

                        <!-- KPI Group: SLA -->
                        <div class="mb-10">
                            <h4 class="label-forte !text-slate-900 !mb-4">SLA de Operação (%)</h4>
                            <div class="kpi-row">
                                <div class="kpi-input-box"><label>Baseline</label><input type="number" step="0.1" id="plan-sla-b" class="input-premium !py-2 !px-3" placeholder="0%"></div>
                                <div class="kpi-input-box"><label>Meta</label><input type="number" step="0.1" id="plan-sla-m" class="input-premium !py-2 !px-3" placeholder="0%"></div>
                                <div class="kpi-input-box"><label>Real</label><input type="number" step="0.1" id="plan-sla-r" class="input-premium !py-2 !px-3" placeholder="0%"></div>
                            </div>
                        </div>

                        <button onclick="window.saveCyclePlanning()" id="btn-save-planning" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-2xl hover:scale-[1.01] transition-all">Salvar Ciclo e Atualizar Resultados</button>
                    </div>
                </div>

                <!-- Timeline Right Column -->
                <div class="lg:col-span-7">
                    <label class="label-forte text-slate-400 mb-6 uppercase tracking-widest">Linha do Tempo Estratégica</label>
                    <div id="planning-timeline-list" class="space-y-6">
                        <!-- Cards injetados via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW LIST -->
        <div id="view-list" class="hidden no-print">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Projetos</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Controle e Listagem Geral</p>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="window.exportToXLS()" class="bg-white border border-slate-200 px-5 py-1.5 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-50 shadow-sm h-[34px]">XLS</button>
                        <button onclick="window.exportPDF()" class="bg-slate-900 text-white px-5 py-1.5 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-800 shadow-sm h-[34px]">PDF</button>
                        <input type="text" id="list-search" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Buscar projeto..." oninput="window.refreshUI()">
                        <select id="list-filter-period" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                            <option value="all">Período</option><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="ano">Anual</option>
                        </select>
                        <select id="list-filter-analista" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Analistas</option></select>
                        <select id="list-filter-area" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Áreas</option></select>
                        <select id="list-filter-frente" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Frentes</option></select>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-end">
                        <select id="list-filter-classificacao" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Classificação</option><option value="Eficiência Operacional">Eficiência</option><option value="Rotina">Rotina</option></select>
                        <select id="list-filter-estrutura" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Estrutura</option><option value="Análise">Análise</option><option value="Clientes">Clientes</option></select>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-[1.5rem] border border-slate-100 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[1000px]">
                        <thead class="bg-slate-50 border-b border-slate-100 text-[10px] font-black uppercase tracking-widest text-slate-400">
                            <tr><th class="p-6">Iniciativa</th><th class="p-6">Área</th><th class="p-6 text-center">Responsáveis</th><th class="p-6 text-center">Estimado</th><th class="p-6 text-center">Status</th><th class="p-6 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="detailed-table-body" class="divide-y divide-slate-100 text-[11px] md:text-[13px] font-bold text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW ARQUIVO -->
        <div id="view-archive" class="hidden no-print">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Arquivo</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Controle de Projetos Concluídos</p>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex flex-wrap gap-2">
                        <input type="text" id="archive-search" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Pesquisar arquivo..." oninput="window.refreshUI()">
                        <select id="archive-filter-period" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                            <option value="all">Período</option><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="ano">Anual</option>
                        </select>
                        <select id="archive-filter-analista" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Analistas</option></select>
                        <select id="archive-filter-area" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Áreas</option></select>
                        <select id="archive-filter-frente" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Frentes</option></select>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-end">
                        <select id="archive-filter-classificacao" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Classificação</option><option value="Eficiência Operacional">Eficiência</option><option value="Rotina">Rotina</option></select>
                        <select id="archive-filter-estrutura" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Estrutura</option><option value="Análise">Análise</option><option value="Clientes">Clientes</option></select>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="column-board">
                    <label class="label-forte text-emerald-600 mb-6 flex justify-between items-center uppercase">
                        <span>Finalizados</span>
                        <span id="count-finalizado-archive" class="count-badge bg-emerald-50 text-emerald-700">0</span>
                    </label>
                    <div id="grid-finalizado" class="space-y-6"></div>
                </div>
                <div class="column-board">
                    <label class="label-forte text-red-600 mb-6 flex justify-between items-center uppercase">
                        <span>Despriorizados</span>
                        <span id="count-despriorizado-archive" class="count-badge bg-red-50 text-red-700">0</span>
                    </label>
                    <div id="grid-despriorizado" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- VIEW FORM -->
        <div id="view-form" class="hidden max-w-6xl mx-auto">
            <div class="mb-6 md:mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                <h2 id="form-title" class="text-2xl md:text-3xl font-black uppercase tracking-tighter text-slate-900">Ficha Técnica</h2>
                <div class="flex gap-2 no-print w-full sm:w-auto">
                    <button id="btn-concluir-quick" onclick="window.confirmFinalizationQuick()" class="hidden bg-emerald-500 text-white px-4 md:px-8 py-3 rounded-xl font-black text-[9px] uppercase shadow-lg hover:scale-105 transition-all">Finalizar</button>
                    <button onclick="window.exportPDF()" class="bg-slate-900 text-white px-4 md:px-8 py-3 rounded-xl font-black text-[9px] uppercase shadow-lg flex-1 sm:flex-none">Exportar PDF</button>
                </div>
            </div>
            <form id="project-form" oninput="window.setDirty()">
                <input type="hidden" id="edit-id" value="">
                <input type="hidden" id="impedimento_tipo_list" value="Risco">
                
                <div class="form-section-box shadow-sm">
                    <label class="label-forte text-slate-300 mb-6 pb-2 border-b border-slate-50 uppercase">1. Identificação Geral</label>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-10">
                        <div class="md:col-span-8">
                            <label class="label-forte">Nome da Iniciativa <span class="text-red-500 font-black">*</span></label>
                            <input type="text" id="iniciativa" required class="input-premium uppercase">
                        </div>
                        <div class="md:col-span-4"><label class="label-forte">Prioridade</label><select id="prioridade" class="input-premium font-bold"><option value="Baixa">Baixa</option><option value="Média" selected>Média</option><option value="Alta">Alta</option></select></div>
                    </div>
                </div>

                <div class="form-section-box shadow-sm">
                    <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">2. Definição Operacional</label>
                    <div class="flex flex-wrap items-start gap-4">
                        <div class="flex-1 min-w-[140px]">
                            <label class="label-forte">Estrutura</label>
                            <select id="estrutura" required class="input-premium font-bold">
                                <option value="Análise">Análise</option>
                                <option value="Clientes">Clientes</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[140px]">
                            <div class="flex justify-between items-center mb-1"><label class="label-forte !mb-0">Frente</label><span class="btn-add-item" onclick="window.openAddModal('frente')">+</span></div>
                            <select id="frente" required class="input-premium"></select>
                        </div>
                        <div class="flex-[1.5] min-w-[200px]">
                            <label class="label-forte">Classificação</label>
                            <select id="classificacao" required class="input-premium font-black text-cyan-600"><option value="Eficiência Operacional">Eficiência Operacional</option><option value="Rotina">Rotina</option></select>
                        </div>
                        <div class="flex-1 min-w-[130px]"><label class="label-forte">Status</label><select id="status" class="input-premium font-black text-slate-900" onchange="window.updateStatusUI(this.value)"><option value="Backlog">Backlog</option><option value="Em Andamento">Em Andamento</option><option value="Finalizado">Finalizado</option><option value="Despriorizado">Despriorizado</option></select></div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-50">
                        <div class="flex justify-between items-center mb-4">
                            <label class="label-forte !mb-0">Áreas Impactadas <span class="text-red-500 font-black">*</span></label>
                            <span class="btn-add-item" onclick="window.openAddModal('area_check')">+ Nova</span>
                        </div>
                        <div id="areas-checkbox-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="form-section-box shadow-sm">
                        <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">3. Cronograma</label>
                        <div class="grid grid-cols-2 gap-6">
                            <div><label class="label-forte">Início <span class="text-red-500 font-black">*</span></label><input type="date" id="data_criacao" required class="input-premium text-xs"></div>
                            <div><label class="label-forte">Prazo Estimado <span class="text-red-500 font-black">*</span></label><input type="date" id="prazo" required onchange="window.validatePrazo(this)" class="input-premium text-xs"></div>
                        </div>
                        <div id="closure-dates" class="mt-8 pt-8 border-t border-slate-100 hidden">
                            <label class="label-forte !text-emerald-600">Conclusão Realizada</label><input type="date" id="data_conclusao" class="input-premium text-xs border-emerald-100 bg-emerald-50/20 text-slate-900">
                        </div>
                        <div id="deprioritize-box" class="mt-8 pt-8 border-t border-slate-100 hidden">
                            <label class="label-forte !text-red-600">Motivo da Despriorização <span class="text-red-500 font-black">*</span></label>
                            <textarea id="justificativa_despriorizacao" rows="3" class="input-premium text-xs" placeholder="Descreva o motivo pelo qual este projeto foi despriorizado..."></textarea>
                        </div>
                    </div>

                    <div class="form-section-box shadow-sm">
                        <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">4. Atividades / Tasks</label>
                        <div class="flex justify-between items-center mb-2">
                            <span id="progress-percent" class="text-[10px] font-black text-emerald-600">PROGRESSO: 0%</span>
                        </div>
                        <div class="progress-container"><div id="task-progress-bar" class="progress-bar-fill"></div></div>
                        <div id="tasks-list-container" class="space-y-2 my-4 max-h-48 overflow-y-auto"></div>
                        <div class="flex gap-2">
                            <input type="text" id="new-task-input" class="input-premium !text-xs" placeholder="Nova tarefa...">
                            <button type="button" onclick="window.addTaskToProject()" class="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-[10px] uppercase hover:bg-slate-800 transition-all h-[38px]">Incluir</button>
                        </div>
                    </div>
                </div>

                <div class="form-section-box shadow-sm">
                    <div class="flex justify-between items-center mb-8 pb-3 border-b border-slate-50">
                        <label class="label-forte text-slate-400 !mb-0">5. Analistas Responsáveis <span class="text-red-500 font-black">*</span></label>
                        <span class="btn-add-item" onclick="window.openAddModal('analista')">+ Novo</span>
                    </div>
                    <div id="responsaveis-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-3 gap-x-12 max-h-56 overflow-y-auto pr-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                    <div class="form-section-box shadow-sm space-y-6">
                        <div>
                            <label class="label-forte">Descrição detalhada <span class="text-red-500 font-black">*</span></label>
                            <textarea id="nota_inicial" required rows="4" class="input-premium text-xs leading-relaxed"></textarea>
                        </div>
                        <div class="pt-6 border-t border-slate-50">
                            <label class="label-forte">Log de Updates</label>
                            <div id="notes-history-list" class="space-y-3 max-h-56 overflow-y-auto mb-4 pr-3 text-[11px]"></div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <textarea id="new-milestone-note" rows="3" class="input-premium !text-xs" placeholder="Evolução de hoje..."></textarea>
                                <button type="button" onclick="window.addItemToHistory('note')" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-[10px] uppercase self-end h-[38px]">Incluir</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section-box shadow-sm !bg-slate-50">
                        <div class="flex justify-between items-center mb-4">
                            <label class="label-forte !mb-0">Atenção Executiva</label>
                            <div class="flex gap-2">
                                <button type="button" id="toggle-list-risco" onclick="window.setAttentionType('Risco')" class="toggle-btn active-risco">Risco</button>
                                <button type="button" id="toggle-list-problema" onclick="window.setAttentionType('Problema')" class="toggle-btn inactive">Problema</button>
                            </div>
                        </div>
                        <div id="attention-history-list" class="space-y-3 max-h-48 overflow-y-auto mb-4 pr-3 text-[11px]"></div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <textarea id="new-attention-note" rows="3" class="input-premium !bg-white text-xs" placeholder="Novo alerta..."></textarea>
                            <button type="button" onclick="window.addItemToHistory('attention')" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-[10px] uppercase self-end h-[38px]">Incluir</button>
                        </div>
                    </div>
                </div>

                <div class="pt-10 flex flex-col sm:flex-row gap-4 border-t border-slate-100 no-print pb-10">
                    <button type="submit" class="bg-slate-900 text-white px-12 py-5 rounded-[1.5rem] font-black shadow-2xl flex-1 uppercase text-xs tracking-widest hover:scale-[1.01] transition-all">Salvar Projeto</button>
                    <button type="button" onclick="window.trySwitchTab('dashboard');" class="bg-white text-slate-400 border border-slate-200 px-10 py-5 rounded-[1.5rem] font-bold text-xs uppercase">Sair</button>
                </div>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const isGitHub = window.location.hostname === "timeprocessos.github.io";
        const firebaseConfig = isGitHub ? {
            apiKey: "AIzaSyAU8nHiRzTwOkrfd8LY7N-YkJG_S7CE0Xs",
            authDomain: "painel-de-projeto.firebaseapp.com",
            projectId: "painel-de-projeto",
            storageBucket: "painel-de-projeto.firebasestorage.app",
            messagingSenderId: "768185401154",
            appId: "1:768185401154:web:d89782c16620a1bf2852db"
        } : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" });

        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-eficiencia-2026';
        
        let projects = [], planningCycles = [], tempNotes = [], tempTasks = [], tempAttention = [], user = null, charts = {}, isFormDirty = false, pendingTab = null, idToDelete = null, typeToDelete = null, editingCycleId = null;

        const defaultTeam = ["Cauan Pereira Da Silva", "Diego Francisco Rocha", "Hudson Nestor Pereira Cortes", "Lucas Henrique Jantsch", "Luiz Gustavo Ribeiro", "Michael Gabriel Moraes Faria", "Otávio Augusto Oliveira", "Rodrigo Prinz De Paiva", "Simone Thomé de Andrade"].sort();
        const defaultAreas = ["Análise", "CX", "Comunicação", "Mesa", "Onboarding"].sort();
        const defaultFrentes = ["Automação", "Performance", "Reestruturação", "Simplificação"].sort();

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Auth Erro:", e); }
        };

        onAuthStateChanged(auth, u => {
            user = u;
            if (u) {
                document.getElementById('sync-indicator')?.classList.remove('hidden');
                
                // Snapshot Projetos
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), snap => {
                    projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.refreshUI();
                    document.getElementById('loading-overlay').style.display = 'none';
                }, err => console.warn("Snapshot Erro Projetos:", err));

                // Snapshot Planeamento
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'planning'), snap => {
                    planningCycles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.renderPlanningTimeline();
                }, err => console.warn("Snapshot Erro Planning:", err));
            }
        });

        // NAVEGAÇÃO
        window.switchTab = (t) => {
            ['dashboard', 'form', 'list', 'archive', 'planning'].forEach(v => document.getElementById('view-'+v)?.classList.add('hidden'));
            document.getElementById('view-'+t)?.classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active-tab', b.id === `tab-${t}`));
            if (t !== 'form' && t !== 'planning') resetForm();
            window.refreshUI();
        };

        window.trySwitchTab = (tab) => { if (isFormDirty) document.getElementById('confirm-exit-modal').style.display = 'flex'; else window.switchTab(tab); };

        // LOGICA PLANEAMENTO
        window.addNewYearPlanning = () => {
            const input = document.getElementById('new-year-input');
            const val = input.value.trim();
            if(!val) return;
            const sel = document.getElementById('planning-year');
            const opt = new Option(val, val, true, true);
            sel.add(opt);
            document.getElementById('add-year-modal').style.display = 'none';
            input.value = '';
        };

        window.saveCyclePlanning = async () => {
            if(!user) return;
            const btn = document.getElementById('btn-save-planning');
            btn.innerText = "A GUARDAR...";
            btn.disabled = true;

            const data = {
                semester: document.getElementById('planning-semester').value,
                year: document.getElementById('planning-year').value,
                ca: { b: Number(document.getElementById('plan-ca-b').value), m: Number(document.getElementById('plan-ca-m').value), r: Number(document.getElementById('plan-ca-r').value) },
                cc: { b: Number(document.getElementById('plan-cc-b').value), m: Number(document.getElementById('plan-cc-m').value), r: Number(document.getElementById('plan-cc-r').value) },
                qo: { b: Number(document.getElementById('plan-qo-b').value), m: Number(document.getElementById('plan-qo-m').value), r: Number(document.getElementById('plan-qo-r').value) },
                sla: { b: Number(document.getElementById('plan-sla-b').value), m: Number(document.getElementById('plan-sla-m').value), r: Number(document.getElementById('plan-sla-r').value) },
                updatedAt: new Date().toISOString()
            };

            try {
                if(editingCycleId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'planning', editingCycleId), data);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'planning'), data);
                }
                editingCycleId = null;
                btn.innerText = "SALVAR CICLO E ATUALIZAR RESULTADOS";
                btn.disabled = false;
                
                // Show success modal
                const mod = document.createElement('div'); mod.className = "fixed inset-0 flex items-center justify-center bg-black/50 z-[20000]";
                mod.innerHTML = `<div class="bg-white p-8 rounded-3xl max-w-sm text-center"><div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">✓</div><h3 class="font-black uppercase text-slate-800 mb-2">PLANEAMENTO SALVO</h3><p class="text-sm font-medium text-slate-500 mb-6">Os parâmetros estratégicos foram atualizados com sucesso.</p><button onclick="this.parentElement.parentElement.remove()" class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-black uppercase text-[10px]">FECHAR</button></div>`;
                document.body.appendChild(mod);
                
                // Limpar campos
                ['ca','cc','qo','sla'].forEach(k => {
                    document.getElementById(`plan-${k}-b`).value = '';
                    document.getElementById(`plan-${k}-m`).value = '';
                    document.getElementById(`plan-${k}-r`).value = '';
                });
            } catch(e) { 
                console.error(e);
                btn.disabled = false;
            }
        };

        window.renderPlanningTimeline = () => {
            const container = document.getElementById('planning-timeline-list');
            if(!container) return;
            container.innerHTML = '';

            // Sort cycles by year and semester desc
            const sorted = [...planningCycles].sort((a,b) => {
                if(a.year !== b.year) return b.year - a.year;
                return b.semester.localeCompare(a.semester);
            });

            sorted.forEach(c => {
                const card = document.createElement('div');
                card.className = "cycle-card";
                
                const getPerf = (val, meta, type) => {
                    if(!val || val === 0) return { status: 'PENDENTE', color: 'bg-slate-100 text-slate-500', pct: 0, gap: 'Aguardando Real...' };
                    let pct = 0;
                    let isBatida = false;
                    
                    if(type === 'reducao') {
                        isBatida = val <= meta;
                        pct = isBatida ? (100 + ((meta - val) / meta * 100)) : (meta / val * 100);
                    } else {
                        isBatida = val >= meta;
                        pct = (val / meta) * 100;
                    }

                    const status = isBatida ? 'BATIDA' : 'ABAIXO DO PLANEJADO';
                    const color = isBatida ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600';
                    const gapLabel = isBatida ? 'Meta Atingida!' : `Falta: ${Math.abs(meta - val).toFixed(2)}`;

                    return { status, color, pct: Math.round(pct), gap: gapLabel };
                };

                const kpis = [
                    { label: 'ANÁLISE', data: c.ca, type: 'reducao' },
                    { label: 'CHAMADO', data: c.cc, type: 'reducao' },
                    { label: 'QUALIDADE', data: c.qo, type: 'crescimento' },
                    { label: 'SLA', data: c.sla, type: 'crescimento' }
                ];

                let kpiHtml = '';
                kpis.forEach(k => {
                    const p = getPerf(k.data.r, k.data.m, k.type);
                    kpiHtml += `
                        <div class="mb-4 last:mb-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${k.label}</span>
                                <span class="text-[9px] font-black px-2 py-0.5 rounded-full ${p.color}">${p.status} (${p.pct}%)</span>
                            </div>
                            <div class="flex justify-between text-[10px] font-bold">
                                <span class="text-slate-400">B: ${k.data.b} → M: ${k.data.m}</span>
                                <span class="text-slate-900">Real: ${k.data.r || '0'}</span>
                            </div>
                            <p class="text-[8px] font-bold mt-0.5 ${p.pct >= 100 ? 'text-emerald-500' : 'text-slate-400 italic'}">${p.gap}</p>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-xl font-black text-slate-900 uppercase">${c.year} - ${c.semester}</h3>
                        <div class="flex gap-2">
                             <button onclick="window.editCycle('${c.id}')" class="text-[8px] font-black px-3 py-1 bg-slate-100 rounded-lg hover:bg-cyan-100 hover:text-cyan-600 transition-all uppercase">EDITANDO</button>
                             <button onclick="window.deleteCycle('${c.id}')" class="text-red-300 hover:text-red-500 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-2">
                        ${kpiHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        };

        window.editCycle = (id) => {
            const c = planningCycles.find(x => x.id === id);
            if(!c) return;
            editingCycleId = id;
            document.getElementById('planning-semester').value = c.semester;
            document.getElementById('planning-year').value = c.year;
            
            ['ca','cc','qo','sla'].forEach(k => {
                document.getElementById(`plan-${k}-b`).value = c[k].b;
                document.getElementById(`plan-${k}-m`).value = c[k].m;
                document.getElementById(`plan-${k}-r`).value = c[k].r;
            });
            document.getElementById('view-planning').scrollTo({ top: 0, behavior: 'smooth' });
        };

        // CORREÇÃO DO BUG DE EXCLUSÃO DE CICLO
        window.deleteCycle = (id) => {
            window.openDeleteModal(id, 'planning');
        };

        // DASHBOARD & PROJETOS LOGICA ORIGINAL (PRESERVADA)
        function renderChart(id, type, data, colors) { 
            if(charts[id]) charts[id].destroy(); 
            const canvas = document.getElementById(id); if(!canvas) return; 
            charts[id] = new Chart(canvas.getContext('2d'), { 
                type: type, 
                data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colors, borderWidth: 0 }] }, 
                plugins: [ChartDataLabels],
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: type === 'pie' ? {} : { x: { grid: { display: false } }, y: { grid: { display: false }, ticks: { display: false } } },
                    plugins: { 
                        legend: { display: type === 'pie', position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } },
                        datalabels: { display: true, color: type === 'pie' ? '#fff' : '#070047', font: { weight: 'bold', size: 10 } }
                    } 
                } 
            }); 
        }

        window.refreshUI = function() {
            const today = new Date();
            today.setHours(0,0,0,0);
            const activeTab = document.querySelector('.active-tab')?.id.split('-')[1];
            if(activeTab === 'planning') return;

            const prefix = activeTab === 'dashboard' ? 'dash' : activeTab === 'list' ? 'list' : 'archive';
            
            const searchVal = document.getElementById(`${prefix}-search`)?.value.toLowerCase() || '';
            const periodVal = document.getElementById(`${prefix}-filter-period`)?.value || 'all';
            const analistaVal = document.getElementById(`${prefix}-filter-analista`)?.value || '';
            const areaVal = document.getElementById(`${prefix}-filter-area`)?.value || '';
            const frenteVal = document.getElementById(`${prefix}-filter-frente`)?.value || '';
            const classVal = document.getElementById(`${prefix}-filter-classificacao`)?.value || '';
            const estruturaVal = document.getElementById(`${prefix}-filter-estrutura`)?.value || '';

            const filtered = projects.filter(p => {
                let match = true;
                if (searchVal && !p.iniciativa?.toLowerCase().includes(searchVal)) match = false;
                if (analistaVal && !p.responsavel?.includes(analistaVal)) match = false;
                if (areaVal && (!p.time || !p.time.includes(areaVal))) match = false;
                if (frenteVal && p.frente !== frenteVal) match = false;
                if (classVal && p.classificacao !== classVal) match = false;
                if (estruturaVal && p.estrutura !== estruturaVal) match = false;
                if (periodVal !== 'all' && p.data_criacao) {
                    const d = new Date(p.data_criacao);
                    const n = new Date();
                    if(periodVal === 'mes') match = match && d.getMonth() === n.getMonth() && d.getFullYear() === n.getFullYear();
                    if(periodVal === 'trimestre') match = match && Math.floor(n.getMonth() / 3) === Math.floor(d.getMonth() / 3);
                    if(periodVal === 'ano') match = match && d.getFullYear() === n.getFullYear();
                }
                return match;
            });

            const f = filtered.filter(p => p.status === 'Finalizado');
            let ris = 0, prob = 0;
            filtered.filter(p => p.status !== 'Finalizado' && p.status !== 'Despriorizado').forEach(p => {
                if(p.attention?.some(att => att.type === 'Problema')) prob++;
                else if(p.attention?.some(att => att.type === 'Risco')) ris++;
            });
            
            if (activeTab === 'dashboard') {
                document.getElementById('kpi-total').innerText = filtered.length;
                document.getElementById('kpi-sla').innerText = (f.length ? Math.round((f.filter(p => p.data_conclusao <= p.prazo).length/f.length)*100) : 0) + '%';
                document.getElementById('kpi-performance').innerText = (filtered.length ? Math.round((f.length/filtered.length)*100) : 0) + '%';
                document.getElementById('kpi-riscos').innerText = ris;
                document.getElementById('kpi-problemas').innerText = prob;
                const saude = prob > 0 ? (prob > 1 ? 0 : 50) : 100;
                const saEl = document.getElementById('kpi-saude');
                saEl.innerText = saude + '%';
                saEl.className = `text-2xl md:text-3xl font-black ${saude === 100 ? 'text-green-500' : (saude === 50 ? 'text-amber-500' : 'text-red-500')}`;

                const paleta = ['#FF1A5C', '#00A5FF', '#A35F9D', '#8D7AD2', '#32B77E', '#5C86C4', '#070047', '#333333'];
                renderChart('chartStatus', 'pie', filtered.reduce((a,v) => { a[v.status]=(a[v.status]||0)+1; return a; }, {}), paleta);
                
                const areaStats = {};
                filtered.forEach(p => {
                    const areas = Array.isArray(p.time) ? p.time : [p.time];
                    areas.forEach(area => { if(area) areaStats[area] = (areaStats[area] || 0) + 1; });
                });
                renderChart('chartTime', 'bar', areaStats, paleta);
                renderChart('chartFrente', 'bar', filtered.reduce((a,v) => { a[v.frente||'N/A']=(a[v.frente||'N/A']||0)+1; return a; }, {}), paleta);
                renderChart('chartLeadTime', 'bar', { 'Médio': 10, 'Atual': 8 }, ['#00A5FF', '#FF1A5C']);

                const bG = document.getElementById('grid-backlog'), aG = document.getElementById('grid-andamento');
                if(bG) bG.innerHTML = ''; if(aG) aG.innerHTML = '';
                filtered.forEach(p => {
                    const card = createProjectCard(p, today);
                    if(p.status === 'Backlog' && bG) bG.innerHTML += card;
                    else if(p.status === 'Em Andamento' && aG) aG.innerHTML += card;
                });
                document.getElementById('count-backlog').innerText = filtered.filter(p => p.status === 'Backlog').length;
                document.getElementById('count-andamento').innerText = filtered.filter(p => p.status === 'Em Andamento').length;
            }

            if (activeTab === 'list') {
                const tbody = document.getElementById('detailed-table-body');
                if(tbody) {
                    tbody.innerHTML = '';
                    filtered.forEach(p => {
                        const areasDisplay = Array.isArray(p.time) ? p.time.join(', ') : (p.time || '--');
                        tbody.innerHTML += `<tr><td class="p-6 uppercase font-bold">${p.iniciativa}</td><td class="p-6">${areasDisplay}</td><td class="p-6 text-center">${p.responsavel?.join(', ') || '--'}</td><td class="p-6 text-center font-bold">${p.prazo?.split('-').reverse().join('/') || '--'}</td><td class="p-6 text-center"><span class="status-pill" style="background: ${getStatusColor(p.status)}">${p.status}</span></td><td class="p-6 text-right flex items-center justify-end gap-3"><button onclick="window.editProjectByID('${p.id}')" class="text-cyan-500 uppercase text-[10px] font-black">Gerenciar</button><button onclick="window.openDeleteModal('${p.id}', 'projects')" class="text-red-400 hover:text-red-600 transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td></tr>`;
                    });
                }
            }

            if (activeTab === 'archive') {
                const fG = document.getElementById('grid-finalizado'), dG = document.getElementById('grid-despriorizado');
                if(fG) fG.innerHTML = ''; if(dG) dG.innerHTML = '';
                filtered.forEach(p => {
                    const card = createProjectCard(p, today);
                    if(p.status === 'Finalizado' && fG) fG.innerHTML += card;
                    else if(p.status === 'Despriorizado' && dG) dG.innerHTML += card;
                });
                document.getElementById('count-finalizado-archive').innerText = filtered.filter(p => p.status === 'Finalizado').length;
                document.getElementById('count-despriorizado-archive').innerText = filtered.filter(p => p.status === 'Despriorizado').length;
            }
        };

        function createProjectCard(p, today) {
            const start = p.data_criacao ? new Date(p.data_criacao) : today;
            const end = p.prazo ? new Date(p.prazo) : today;
            const openDays = Math.floor((today - start) / 86400000);
            const isOverdue = today > end && p.status !== 'Finalizado' && p.status !== 'Despriorizado';
            const topColor = getStatusColor(p.status);
            
            const totalTasks = p.tasks?.length || 0;
            const completedTasks = p.tasks?.filter(t => t.completed).length || 0;
            const pCent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            const areasDisplay = Array.isArray(p.time) ? p.time.join(', ') : (p.time || 'MESA');
            const tipoDisplay = p.estrutura || 'ANÁLISE';

            let justificationHtml = '';
            if (p.status === 'Despriorizado' && p.justificativa_despriorizacao) {
                justificationHtml = `
                    <div class="mt-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                        <span class="block text-[8px] font-black text-red-600 uppercase mb-1">Motivo:</span>
                        <p class="text-[10px] text-red-800 font-semibold italic">${p.justificativa_despriorizacao}</p>
                    </div>
                `;
            }

            return `
            <div class="card-project p-6 flex flex-col h-full bg-white shadow-sm border-slate-100" style="border-top-color: ${topColor}">
                <div class="flex justify-between items-start mb-6">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${tipoDisplay} | ${areasDisplay}</span>
                    <span class="status-pill text-white" style="background: ${topColor}">${p.status}</span>
                </div>
                <h3 class="text-[15px] font-black mb-6 uppercase leading-tight text-slate-900 min-h-[40px]">${p.iniciativa}</h3>
                <div class="space-y-2 text-[10px] font-bold text-slate-400">
                    <div class="flex justify-between items-center"><span>ESTIMADO:</span><span class="text-slate-900">${p.prazo ? p.prazo.split('-').reverse().join('/') : '--'}</span></div>
                    <div class="flex justify-between items-center"><span>ABERTO HÁ:</span><span class="text-slate-900">${Math.max(0, openDays)} dias</span></div>
                    <div class="flex justify-between items-center"><span>CLASSIFICAÇÃO:</span><span class="text-cyan-500">${p.classificacao || '--'}</span></div>
                    <div class="pt-2">
                        <div class="flex justify-between items-center mb-1"><span>PROGRESSO</span><span class="text-emerald-500">${pCent}%</span></div>
                        <div class="progress-container"><div class="progress-bar-fill" style="width: ${pCent}%"></div></div>
                    </div>
                    <div class="flex justify-between items-center pt-4"><span>STATUS:</span><span class="${isOverdue ? 'text-red-500 animate-pulse' : 'text-slate-900'} uppercase font-black">${isOverdue ? 'ATRASADO' : (p.status === 'Despriorizado' ? 'SUSPENSO' : 'NO PRAZO')}</span></div>
                </div>
                ${justificationHtml}
                <button onclick="window.editProjectByID('${p.id}')" class="w-full bg-[#000a28] text-white py-3.5 rounded-xl font-black uppercase text-[10px] hover:bg-slate-800 transition-all mt-6 shadow-lg tracking-widest">GERENCIAR</button>
            </div>`;
        }

        window.setDirty = () => { isFormDirty = true; };

        window.updateStatusUI = (v) => {
            const clo = document.getElementById('closure-dates');
            const dep = document.getElementById('deprioritize-box');
            if(clo) clo.classList.toggle('hidden', v !== 'Finalizado');
            if(dep) dep.classList.toggle('hidden', v !== 'Despriorizado');
        };

        window.validatePrazo = function(input) {
            const selectedDate = input.value;
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate && selectedDate < today) {
                const mod = document.createElement('div'); mod.className = "fixed inset-0 flex items-center justify-center bg-black/50 z-[20000]";
                mod.innerHTML = `<div class="bg-white p-8 rounded-3xl max-w-sm text-center text-slate-800"><h3 class="font-black uppercase text-red-500 mb-4">Data Inválida</h3><p class="text-sm font-medium mb-6">O Prazo Estimado não pode ser uma data retroativa.</p><button onclick="this.parentElement.parentElement.remove()" class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-black uppercase text-[10px]">Entendido</button></div>`;
                document.body.appendChild(mod);
                input.value = today;
            }
        };

        window.confirmFinalizationQuick = () => {
            const statusEl = document.getElementById('status');
            const dateEl = document.getElementById('data_conclusao');
            if(statusEl) statusEl.value = 'Finalizado';
            if(dateEl) dateEl.value = new Date().toISOString().split('T')[0];
            window.updateStatusUI('Finalizado');
            isFormDirty = true;
            document.getElementById('project-form')?.scrollIntoView({ behavior: 'smooth' });
        };

        // REATORAÇÃO DAS FUNÇÕES DE MODAL PARA SUPORTAR TIPOS DIFERENTES
        window.openDeleteModal = (id, type = 'projects') => { 
            idToDelete = id; 
            typeToDelete = type;
            const titleEl = document.getElementById('delete-modal-title');
            if(titleEl) titleEl.innerText = type === 'planning' ? 'Excluir Ciclo?' : 'Excluir Iniciativa?';
            document.getElementById('delete-modal').style.display = 'flex'; 
        };

        window.closeDeleteModal = () => { 
            idToDelete = null; 
            typeToDelete = null;
            document.getElementById('delete-modal').style.display = 'none'; 
        };

        window.confirmDelete = async () => { 
            if(idToDelete && typeToDelete && user) { 
                const collectionPath = typeToDelete === 'planning' ? 'planning' : 'projects';
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionPath, idToDelete)); 
                window.closeDeleteModal(); 
            } 
        };

        window.saveAndExit = () => { document.getElementById('project-form').requestSubmit(); isFormDirty = false; document.getElementById('confirm-exit-modal').style.display = 'none'; };
        window.discardAndExit = () => { isFormDirty = false; document.getElementById('confirm-exit-modal').style.display = 'none'; window.switchTab('dashboard'); };

        function resetForm() {
            document.getElementById('project-form').reset();
            document.getElementById('edit-id').value = '';
            document.querySelectorAll('input[name="area_check"]').forEach(cb => cb.checked = false);
            tempNotes = []; tempTasks = []; tempAttention = []; isFormDirty = false;
            window.renderHistoryLists(); window.renderTasksList(); window.renderAttentionList();
            window.updateStatusUI('Backlog');
        }

        window.editProjectByID = (id) => {
            const p = projects.find(x => x.id === id); if (!p) return;
            window.switchTab('form');
            document.getElementById('edit-id').value = p.id;
            document.getElementById('iniciativa').value = p.iniciativa || '';
            document.getElementById('frente').value = p.frente || '';
            document.getElementById('status').value = p.status || 'Backlog';
            document.getElementById('estrutura').value = p.estrutura || 'Análise';
            document.getElementById('classificacao').value = p.classificacao || 'Eficiência Operacional';
            document.getElementById('prazo').value = p.prazo || '';
            document.getElementById('data_criacao').value = p.data_criacao || '';
            document.getElementById('nota_inicial').value = p.nota_inicial || '';
            document.getElementById('justificativa_despriorizacao').value = p.justificativa_despriorizacao || '';
            document.getElementById('data_conclusao').value = p.data_conclusao || '';
            
            window.updateStatusUI(p.status);
            
            tempNotes = p.notes || []; tempTasks = p.tasks || []; tempAttention = p.attention || [];
            window.renderHistoryLists(); window.renderTasksList(); window.renderAttentionList();
            const pAreas = Array.isArray(p.time) ? p.time : [p.time];
            document.querySelectorAll('input[name="area_check"]').forEach(cb => { cb.checked = pAreas.includes(cb.value); });
            document.querySelectorAll('input[name="responsavel_check"]').forEach(cb => { cb.checked = p.responsavel?.includes(cb.value); });
            document.getElementById('btn-concluir-quick').classList.toggle('hidden', p.status === 'Finalizado');
        };

        window.renderTasksList = () => {
            const container = document.getElementById('tasks-list-container'); if(!container) return; container.innerHTML = ''; 
            tempTasks.forEach(t => { 
                container.innerHTML += `<div class="task-item text-slate-800"><input type="checkbox" ${t.completed ? 'checked' : ''} onchange="window.toggleTaskStatus(${t.id})"><span class="flex-1 text-xs font-bold ${t.completed ? 'line-through text-slate-300' : 'text-slate-700'}">${t.text}</span><button type="button" onclick="window.removeTaskFromProject(${t.id})" class="text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>`; 
            }); 
            window.updateTaskProgress();
        };

        window.updateTaskProgress = function() {
            const total = tempTasks.length;
            const completed = tempTasks.filter(t => t.completed).length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            const bar = document.getElementById('task-progress-bar');
            const txt = document.getElementById('progress-percent');
            if(bar) bar.style.width = percent + '%';
            if(txt) txt.innerText = `PROGRESSO: ${percent}%`;
        };

        window.toggleTaskStatus = (id) => { tempTasks = tempTasks.map(t => t.id === id ? {...t, completed: !t.completed} : t); window.renderTasksList(); isFormDirty = true; };
        window.removeTaskFromProject = (id) => { tempTasks = tempTasks.filter(t => t.id !== id); window.renderTasksList(); isFormDirty = true; };
        window.addTaskToProject = () => { const input = document.getElementById('new-task-input'); const val = input?.value.trim(); if(!val) return; tempTasks.push({ id: Date.now(), text: val, completed: false }); if(input) input.value = ''; window.renderTasksList(); isFormDirty = true; };

        window.renderHistoryLists = () => {
            const l = document.getElementById('notes-history-list'); l.innerHTML = '';
            tempNotes.forEach(n => l.innerHTML += `<div class="history-entry"><span class="text-cyan-500 font-black text-[9px] uppercase">${n.date}</span><p class="mt-1 font-semibold text-xs">${n.text}</p></div>`);
        };
        window.addItemToHistory = (type) => {
            const inputId = type === 'note' ? 'new-milestone-note' : 'new-attention-note';
            const val = document.getElementById(inputId).value; if(!val) return;
            const item = { date: new Date().toLocaleDateString('pt-BR'), text: val };
            if(type === 'note') { tempNotes.unshift(item); window.renderHistoryLists(); }
            else { item.type = document.getElementById('impedimento_tipo_list').value; tempAttention.unshift(item); window.renderAttentionList(); }
            document.getElementById(inputId).value = ''; isFormDirty = true;
        };

        window.renderAttentionList = () => {
            const l = document.getElementById('attention-history-list'); l.innerHTML = '';
            tempAttention.forEach((a, i) => {
                const color = a.type === 'Problema' ? 'border-red-500' : 'border-amber-500';
                l.innerHTML += `<div class="history-entry border-l-4 ${color}"><div class="flex justify-between items-start"><span class="font-black text-[9px] uppercase">${a.type} | ${a.date}</span><button type="button" onclick="window.removeAttention(${i})" class="text-slate-300">✕</button></div><p class="mt-1 font-semibold text-xs">${a.text}</p></div>`;
            });
        };
        window.removeAttention = (i) => { tempAttention.splice(i, 1); window.renderAttentionList(); isFormDirty = true; };
        window.setAttentionType = (t) => { document.getElementById('impedimento_tipo_list').value = t; document.getElementById('toggle-list-risco').className = `toggle-btn ${t==='Risco'?'active-risco':'inactive'}`; document.getElementById('toggle-list-problema').className = `toggle-btn ${t==='Problema'?'active-problema':'inactive'}`; };

        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault(); if(!user) return;
            
            const status = document.getElementById('status').value;
            const justificativa = document.getElementById('justificativa_despriorizacao').value.trim();
            
            if (status === 'Despriorizado' && !justificativa) {
                const mod = document.createElement('div'); mod.className = "fixed inset-0 flex items-center justify-center bg-black/50 z-[20000]";
                mod.innerHTML = `<div class="bg-white p-8 rounded-3xl max-w-sm text-center"><h3 class="font-black uppercase text-red-500 mb-4">Atenção</h3><p class="text-sm font-medium mb-6">Ao despriorizar uma iniciativa, é obrigatório preencher o motivo.</p><button onclick="this.parentElement.parentElement.remove()" class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-black uppercase text-[10px]">Preencher agora</button></div>`;
                document.body.appendChild(mod);
                return;
            }

            const resps = Array.from(document.querySelectorAll('input[name="responsavel_check"]:checked')).map(cb => cb.value);
            const areas = Array.from(document.querySelectorAll('input[name="area_check"]:checked')).map(cb => cb.value);
            
            if(areas.length === 0) {
                const mod = document.createElement('div'); mod.className = "fixed inset-0 flex items-center justify-center bg-black/50 z-[20000]";
                mod.innerHTML = `<div class="bg-white p-8 rounded-3xl max-w-sm text-center"><h3 class="font-black uppercase text-red-500 mb-4">Erro</h3><p class="text-sm font-medium mb-6">Selecione pelo menos uma Área impactada.</p><button onclick="this.parentElement.parentElement.remove()" class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-black uppercase text-[10px]">Ok</button></div>`;
                document.body.appendChild(mod); return;
            }
            
            const id = document.getElementById('edit-id').value;
            const data = {
                iniciativa: document.getElementById('iniciativa').value,
                time: areas,
                estrutura: document.getElementById('estrutura').value,
                frente: document.getElementById('frente').value,
                classificacao: document.getElementById('classificacao').value,
                status: status,
                prazo: document.getElementById('prazo').value,
                data_criacao: document.getElementById('data_criacao').value,
                nota_inicial: document.getElementById('nota_inicial').value,
                responsavel: resps,
                justificativa_despriorizacao: justificativa,
                data_conclusao: document.getElementById('data_conclusao').value,
                notes: tempNotes, tasks: tempTasks, attention: tempAttention
            };
            if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id), data);
            else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), data);
            isFormDirty = false; window.switchTab('dashboard');
        };

        window.exportToXLS = () => {
            let csv = "Iniciativa,Areas,Estrutura,Responsáveis,Prazo,Status,Motivo Despriorização\n";
            projects.forEach(p => { const areas = Array.isArray(p.time) ? p.time.join('; ') : p.time; csv += `"${p.iniciativa}","${areas}","${p.estrutura}","${p.responsavel?.join('; ')}","${p.prazo}","${p.status}","${p.justificativa_despriorizacao || ''}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", "Projetos_Unico.csv"); link.click();
        };
        
        window.exportPDF = () => window.print();

        window.openAddModal = (t) => { pendingTab = t; document.getElementById('add-item-title').innerText = "Adicionar " + t; document.getElementById('add-item-modal').style.display = 'flex'; };
        window.closeAddModal = () => document.getElementById('add-item-modal').style.display = 'none';
        window.processAddItem = () => {
            const v = document.getElementById('new-item-input').value.trim(); if(!v) return;
            if(pendingTab === 'analista') renderAnalista(v);
            else if(pendingTab === 'area_check') renderAreaCheckbox(v);
            else { const el = document.getElementById(pendingTab); if(el) el.add(new Option(v, v, true, true)); }
            window.closeAddModal(); document.getElementById('new-item-input').value = '';
        };

        function renderAnalista(name) {
            const g = document.getElementById('responsaveis-grid'); if(!g) return;
            const l = document.createElement('label'); l.className = "checkbox-item";
            l.innerHTML = `<input type="checkbox" name="responsavel_check" value="${name}"><span>${name}</span>`;
            g.appendChild(l);
            ['dash', 'list', 'archive'].forEach(p => {
                const el = document.getElementById(`${p}-filter-analista`);
                if(el) el.add(new Option(name, name));
            });
        }

        function renderAreaCheckbox(name) {
            const g = document.getElementById('areas-checkbox-grid'); if(!g) return;
            const l = document.createElement('label'); l.className = "checkbox-item";
            l.innerHTML = `<input type="checkbox" name="area_check" value="${name}"><span>${name}</span>`;
            g.appendChild(l);
            ['dash', 'list', 'archive', 'planning'].forEach(p => {
                const el = document.getElementById(`${p}-filter-area`);
                if(el) el.add(new Option(name, name));
            });
        }

        const setupFilters = () => {
            defaultTeam.forEach(renderAnalista);
            defaultAreas.forEach(renderAreaCheckbox);
            defaultFrentes.forEach(f => {
                const sel = document.getElementById('frente');
                if(sel) sel.add(new Option(f, f));
                ['dash', 'list', 'archive', 'planning'].forEach(p => {
                    const el = document.getElementById(`${p}-filter-frente`);
                    if(el) el.add(new Option(f, f));
                });
            });
        };

        setupFilters();
        initAuth();
    </script>
</body>
</html>
