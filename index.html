<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Eficiência Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --success-color: #10b981;
            --bg-body: #f8fafc;
            --color-backlog: #94a3b8;
            --color-andamento: #fabd23;
            --color-finalizado: #10b981;
            --color-despriorizado: #ef4444;
            --color-dependencia: #000000;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
            -webkit-font-smoothing: antialiased;
        }
        .input-premium {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.65rem 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            font-weight: 600;
            font-size: 0.85rem;
            width: 100%;
        }
        .input-premium:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.08);
        }
        .label-forte {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 0.6rem;
            display: block;
        }
        .active-tab {
            color: var(--primary-color);
            border-bottom: 3px solid var(--accent-color);
            font-weight: 900;
        }
        .kpi-card {
            background: white;
            padding: 1.5rem 1rem;
            border-radius: 1.5rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            gap: 0.4rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }
        .form-section-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        @media (min-width: 768px) { .form-section-box { padding: 2.5rem; } }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 0.85rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            border: 1px solid #f1f5f9;
        }
        .checkbox-item:hover { background: #f8fafc; border-color: #e2e8f0; }
        .checkbox-item input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            background: white;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .checkbox-item input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .checkbox-item input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            color: #000a28;
            font-size: 12px;
            font-weight: 900;
            left: 50%; top: 45%; transform: translate(-50%, -50%);
        }
        .checkbox-item span { font-size: 0.8rem; font-weight: 700; color: #334155; }
        
        .analista-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .checkbox-item:hover .analista-item-actions {
            opacity: 1;
        }
        .btn-action-small {
            padding: 4px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .btn-action-small:hover { background: #f1f5f9; }

        .toggle-btn {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .toggle-btn.active-risco { background: #fef3c7; border-color: #fbbf24; color: #92400e; }
        .toggle-btn.active-problema { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .toggle-btn.inactive { background: #f8fafc; color: #94a3b8; border-color: #e2e8f0; }
        .card-project { background: white; border-radius: 24px; border: 1px solid #e2e8f0; transition: all 0.3s ease; border-top-width: 12px; overflow: hidden; }
        .status-pill { 
            font-size: 0.6rem; 
            font-weight: 900; 
            padding: 4px 12px; 
            border-radius: 100px; 
            text-transform: uppercase; 
            white-space: nowrap; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            min-width: 110px;
            height: 24px;
        }
        .btn-add-item { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: #f1f5f9; color: #64748b; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-left: 8px; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 999px; height: 8px; overflow: hidden; margin-top: 4px; }
        .progress-bar-fill { height: 100%; background-color: var(--success-color); transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .history-entry p { white-space: pre-wrap; word-wrap: break-word; }
        
        .history-entry { padding: 0.75rem; background-color: #f8fafc; border-radius: 1rem; border: 1px solid #f1f5f9; margin-bottom: 0.5rem; }
        .task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: #fff; border: 1px solid #f1f5f9; border-radius: 10px; margin-bottom: 0.5rem; }
        .column-board { background: rgba(226, 232, 240, 0.3); border-radius: 1.5rem; padding: 1.25rem; min-height: 400px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 10, 40, 0.5); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 2rem; border-radius: 2rem; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .count-badge { padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 900; min-width: 24px; text-align: center; }
        
        /* Planeamento Estilos */
        .card-planning { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 20px; padding: 1.25rem; box-shadow: 0 4px 15px -5px rgba(0,0,0,0.05); }
        .cycle-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; padding: 1.5rem; position: relative; border-left: 8px solid #00e5ff; transition: all 0.2s; }
        .cycle-card:hover { transform: translateX(5px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); }
        .kpi-row { display: grid; grid-template-cols: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem; }
        .kpi-input-box { display: flex; flex-direction: column; }
        .kpi-input-box label { font-size: 9px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        .monthly-grid { display: grid; grid-template-cols: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.5rem; }
        @media (min-width: 640px) { .monthly-grid { grid-template-cols: repeat(6, 1fr); } }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white !important; padding: 0; } 
            .form-section-box { border: 1px solid #eee; break-inside: avoid; } 
            main { margin: 0 !important; padding: 0 !important; max-width: 100% !important; }
            .active-tab { border-bottom: none !important; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="no-print" style="position: fixed; inset: 0; background: var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: white; transition: opacity 0.5s, visibility 0.5s;">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-24 md:w-32 mb-8 invert" alt="Unico" onerror="this.style.display='none'">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
        <p class="mt-4 text-[10px] font-black uppercase tracking-widest text-slate-500">A conectar à estratégia...</p>
    </div>

    <!-- Modals -->
    <div id="confirm-exit-modal" class="modal-overlay no-print">
        <div class="modal-content text-center text-slate-800">
            <h3 class="text-xl md:text-2xl font-black mb-2 uppercase tracking-tighter text-slate-800">Alterações não salvas</h3>
            <p class="text-slate-500 mb-8 font-medium text-sm">Deseja salvar o progresso antes de sair?</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.saveAndExit()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-slate-800 transition-all">Salvar e Sair</button>
                <button onclick="window.discardAndExit()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px] hover:bg-slate-200 transition-all">Descartar</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay no-print">
        <div class="modal-content text-center text-slate-800">
            <h3 id="delete-modal-title" class="text-xl md:text-2xl font-black mb-2 uppercase tracking-tighter text-slate-800">Excluir Item?</h3>
            <p id="delete-modal-desc" class="text-slate-500 mb-8 font-medium text-sm">A remoção será permanente.</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.confirmDelete()" class="flex-1 bg-red-500 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] hover:bg-red-600 transition-all">Confirmar</button>
                <button onclick="window.closeDeleteModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px] hover:bg-slate-200 transition-all">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="add-item-modal" class="modal-overlay no-print">
        <div class="modal-content">
            <h3 id="add-item-title" class="text-xl font-black mb-6 uppercase tracking-tighter text-slate-800">Adicionar Opção</h3>
            <input type="text" id="new-item-input" class="input-premium mb-8" placeholder="Digite o nome...">
            <div class="flex gap-3">
                <button id="btn-process-item" onclick="window.processAddItem()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] shadow-xl">Adicionar</button>
                <button onclick="window.closeAddModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">Sair</button>
            </div>
        </div>
    </div>

    <div id="add-year-modal" class="modal-overlay no-print">
        <div class="modal-content text-center">
            <h3 class="text-xl font-black mb-6 uppercase tracking-tighter text-slate-800">NOVO ANO</h3>
            <input type="number" id="new-year-input" class="input-premium mb-8 text-center text-lg" placeholder="Ex: 2028">
            <div class="flex gap-3">
                <button onclick="window.addNewYearPlanning()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] shadow-xl">ADICIONAR</button>
                <button onclick="document.getElementById('add-year-modal').style.display='none'" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="add-indicator-modal" class="modal-overlay no-print">
        <div class="modal-content text-center">
            <h3 class="text-xl font-black mb-6 uppercase tracking-tighter text-slate-800">Novo Indicador</h3>
            <input type="text" id="new-indicator-name" class="input-premium mb-4" placeholder="Nome do Indicador (ex: NPS Operacional)">
            <label class="label-forte text-left mb-2">Unidade de Medida</label>
            <select id="new-indicator-unit" class="input-premium mb-4 font-bold">
                <option value="R$">Real (R$)</option>
                <option value="%">Percentual (%)</option>
                <option value="Vol">Volume (un)</option>
            </select>
            <label class="label-forte text-left mb-2">Qual o objetivo?</label>
            <select id="new-indicator-type" class="input-premium mb-8 font-bold">
                <option value="reducao">Redução (Quanto menor, melhor)</option>
                <option value="crescimento">Crescimento (Quanto maior, melhor)</option>
                <option value="manter">Manter</option>
            </select>
            <div class="flex gap-3">
                <button onclick="window.addNewIndicatorDefinition()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] shadow-xl">ADICIONAR</button>
                <button onclick="document.getElementById('add-indicator-modal').style.display='none'" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">CANCELAR</button>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 md:h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 md:gap-8">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-6" alt="Unico" onerror="this.style.display='none'">
                <div id="sync-indicator" class="hidden sm:flex items-center gap-2 px-3 md:px-4 py-1.5 bg-green-50 rounded-full border border-green-100">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[8px] md:text-[10px] font-black text-green-600 uppercase tracking-widest">Tempo Real</span>
                </div>
            </div>
            <nav class="flex gap-4 md:gap-10 h-full items-center text-[9px] md:text-[11px] font-bold uppercase tracking-widest text-slate-400">
                <button onclick="window.trySwitchTab('dashboard')" id="tab-dashboard" class="h-full px-1 md:px-2 active-tab">Dash</button>
                <button onclick="window.trySwitchTab('planning')" id="tab-planning" class="h-full px-1 md:px-2 hover:text-slate-900">Planeamento</button>
                <button onclick="window.trySwitchTab('form')" id="tab-form" class="h-full px-1 md:px-2 hover:text-slate-900">Novo</button>
                <button onclick="window.trySwitchTab('list')" id="tab-list" class="h-full px-1 md:px-2 hover:text-slate-900">Projetos</button>
                <button onclick="window.trySwitchTab('archive')" id="tab-archive" class="h-full px-1 md:px-2 hover:text-slate-900">Arquivo</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 mt-2 md:mt-4">
        <!-- Dashboard View -->
        <div id="view-dashboard" class="block">
            <div class="mb-8 md:mb-12 flex flex-col xl:flex-row xl:items-end justify-between gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Estratégia & Operação</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Painel de Decisões e Eficiência</p>
                </div>
                <div class="flex flex-wrap gap-2 md:gap-3 items-center no-print">
                    <div class="flex flex-col gap-2">
                        <div class="flex flex-wrap gap-2 items-center">
                            <input type="text" id="dash-search" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Procurar projeto..." oninput="window.refreshUI()">
                            <div class="flex items-center gap-1 bg-white border border-slate-200 rounded-xl px-2 py-1 shadow-sm">
                                <span class="text-[8px] font-black uppercase text-slate-400">De</span>
                                <input type="date" id="dash-filter-start" class="border-0 bg-transparent text-[10px] font-bold outline-none cursor-pointer" onchange="window.refreshUI()">
                                <span class="text-[8px] font-black uppercase text-slate-400">Até</span>
                                <input type="date" id="dash-filter-end" class="border-0 bg-transparent text-[10px] font-bold outline-none cursor-pointer" onchange="window.refreshUI()">
                            </div>
                            <select id="dash-filter-period" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="all">Todo o Período</option>
                                <option value="mes">Mensal</option>
                                <option value="trimestre">Trimestral</option>
                                <option value="ano">Anual</option>
                            </select>
                            <select id="dash-filter-analista" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Analistas (Todos)</option>
                            </select>
                            <select id="dash-filter-area" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Áreas (Todas)</option>
                            </select>
                            <select id="dash-filter-frente" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Frentes (Todas)</option>
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <select id="dash-filter-classificacao" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Classificação (Todas)</option>
                                <option value="Eficiência Operacional">Eficiência Operacional</option>
                                <option value="Rotina">Rotina</option>
                            </select>
                            <select id="dash-filter-estrutura" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                                <option value="">Estrutura (Todas)</option>
                                <option value="Análise">Análise</option>
                                <option value="Clientes">Clientes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6 mb-8 md:mb-12">
                <div class="kpi-card"><p class="label-forte !mb-0 text-[9px]">Total</p><h2 id="kpi-total" class="text-2xl md:text-3xl font-black">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-cyan-500 text-[9px]">SLA Geral</p><h2 id="kpi-sla" class="text-2xl md:text-3xl font-black text-cyan-500">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-green-500 text-[9px]">Aderência</p><h2 id="kpi-performance" class="text-2xl md:text-3xl font-black text-green-500">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-blue-500 text-[9px]">Riscos</p><h2 id="kpi-riscos" class="text-xl md:text-2xl font-black text-blue-500">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-red-500 text-[9px]">Problemas</p><h2 id="kpi-problemas" class="text-xl md:text-2xl font-black text-red-500">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-indigo-500 text-[9px]">Saúde</p><h2 id="kpi-saude" class="text-2xl md:text-3xl font-black text-indigo-500">100%</h2></div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8 mb-8 md:mb-12">
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Status</span><div class="w-full h-40 md:h-44"><canvas id="chartStatus"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Área</span><div class="w-full h-40 md:h-44"><canvas id="chartTime"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Frentes Ativas</span><div class="w-full h-40 md:h-44"><canvas id="chartFrente"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-4">Lead Time Médio</span><div class="w-full h-40 md:h-44"><canvas id="chartLeadTime"></canvas></div></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="column-board">
                    <label class="label-forte text-slate-400 mb-6 flex justify-between items-center">
                        <span>Backlog</span>
                        <span id="count-backlog" class="bg-[#94a3b8] text-white px-3 py-1 rounded-full text-[10px] font-black">0</span>
                    </label>
                    <div id="grid-backlog" class="space-y-6"></div>
                </div>
                <div class="column-board">
                    <label class="label-forte text-slate-400 mb-6 flex justify-between items-center">
                        <span>Em Andamento</span>
                        <span id="count-andamento" class="bg-[#fabd23] text-[#000a28] px-3 py-1 rounded-full text-[10px] font-black">0</span>
                    </label>
                    <div id="grid-andamento" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- Planning View -->
        <div id="view-planning" class="hidden">
            <div class="mb-10 flex justify-between items-start">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Performance Operacional</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Metas e acompanhamento mensal detalhado</p>
                </div>
                <button onclick="document.getElementById('add-indicator-modal').style.display='flex'" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg hover:bg-indigo-700 transition-all no-print">+ Novo Indicador</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-6 space-y-6 no-print">
                    <div class="form-section-box !mb-0">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="label-forte">Ciclo de Gestão</label>
                                <select id="planning-semester" class="input-premium font-bold" onchange="window.renderPlanningInputs()">
                                    <option value="H1">H1 (Jan - Jun)</option>
                                    <option value="H2">H2 (Jul - Dez)</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-forte">Ano Vigente</label>
                                <div class="flex gap-2">
                                    <select id="planning-year" class="input-premium font-bold">
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                    </select>
                                    <button onclick="document.getElementById('add-year-modal').style.display='flex'" class="btn-add-item !w-10 !h-10 !rounded-xl !ml-0 text-lg">+</button>
                                </div>
                            </div>
                        </div>
                        <div id="dynamic-kpi-inputs-container" class="space-y-10"></div>
                        <div class="mt-12 pt-8 border-t border-slate-100">
                            <label class="label-forte text-indigo-600">Responsável pelo Preenchimento *</label>
                            <select id="planning-responsible" class="input-premium font-black text-slate-900 mb-6">
                                <option value="">Selecione o analista...</option>
                            </select>
                            <button onclick="window.saveCyclePlanning()" id="btn-save-planning" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-2xl hover:scale-[1.01] transition-all">Salvar Ciclo e Atualizar Gráficos</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-6 print:!col-span-12">
                    <label class="label-forte text-slate-400 mb-6 uppercase tracking-widest no-print">Resultados Consolidados</label>
                    <div id="planning-timeline-list" class="space-y-8"></div>
                </div>
            </div>
        </div>

        <!-- List View -->
        <div id="view-list" class="hidden">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Projetos</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Controle e Listagem Geral</p>
                </div>
                <div class="flex flex-col gap-2 no-print">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="window.exportToXLS()" class="bg-white border border-slate-200 px-5 py-1.5 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-50 shadow-sm h-[34px]">XLS</button>
                        <button onclick="window.exportPDF()" class="bg-slate-900 text-white px-5 py-1.5 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-800 shadow-sm h-[34px]">PDF</button>
                        <input type="text" id="list-search" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Procurar projeto..." oninput="window.refreshUI()">
                        <select id="list-filter-period" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                            <option value="all">Período</option><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="ano">Anual</option>
                        </select>
                        <select id="list-filter-analista" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Analistas</option></select>
                        <select id="list-filter-area" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Áreas</option></select>
                        <select id="list-filter-frente" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Frentes</option></select>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-[1.5rem] border border-slate-100 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[1000px]">
                        <thead class="bg-slate-50 border-b border-slate-100 text-[10px] font-black uppercase tracking-widest text-slate-400">
                            <tr><th class="p-6">Iniciativa</th><th class="p-6">Área</th><th class="p-6 text-center">Responsáveis</th><th class="p-6 text-center">Início</th><th class="p-6 text-center">Estimado</th><th class="p-6 text-center">Status</th><th class="p-6 text-right no-print">Ações</th></tr>
                        </thead>
                        <tbody id="detailed-table-body" class="divide-y divide-slate-100 text-[11px] md:text-[13px] font-bold text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Archive View -->
        <div id="view-archive" class="hidden">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Arquivo</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 tracking-widest">Controle de Projetos Concluídos</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="column-board">
                    <label class="label-forte text-emerald-600 mb-6 flex justify-between items-center uppercase">
                        <span>Finalizados</span>
                        <span id="count-finalizado-archive" class="count-badge bg-emerald-50 text-emerald-700">0</span>
                    </label>
                    <div id="grid-finalizado" class="space-y-6"></div>
                </div>
                <div class="column-board">
                    <label class="label-forte text-red-600 mb-6 flex justify-between items-center uppercase">
                        <span>Despriorizados</span>
                        <span id="count-despriorizado-archive" class="count-badge bg-red-50 text-red-700">0</span>
                    </label>
                    <div id="grid-despriorizado" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- Form View -->
        <div id="view-form" class="hidden max-w-6xl mx-auto">
            <div class="mb-6 md:mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                <h2 id="form-title" class="text-2xl md:text-3xl font-black uppercase tracking-tighter text-slate-900">Ficha Técnica</h2>
                <div class="flex gap-2 no-print w-full sm:w-auto">
                    <button id="btn-concluir-quick" onclick="window.confirmFinalizationQuick()" class="hidden bg-emerald-500 text-white px-4 md:px-8 py-3 rounded-xl font-black text-[9px] uppercase shadow-lg hover:scale-105 transition-all">Finalizar</button>
                    <button onclick="window.exportPDF()" class="bg-slate-900 text-white px-4 md:px-8 py-3 rounded-xl font-black text-[9px] uppercase shadow-lg flex-1 sm:flex-none">Exportar PDF</button>
                </div>
            </div>
            <form id="project-form" oninput="window.setDirty()">
                <input type="hidden" id="edit-id" value="">
                <input type="hidden" id="impedimento_tipo_list" value="Risco">
                <div class="form-section-box shadow-sm">
                    <label class="label-forte text-slate-300 mb-6 pb-2 border-b border-slate-50 uppercase">1. Identificação Geral</label>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-10">
                        <div class="md:col-span-8">
                            <label class="label-forte">Nome da Iniciativa <span class="text-red-500 font-black">*</span></label>
                            <input type="text" id="iniciativa" required class="input-premium uppercase">
                        </div>
                        <div class="md:col-span-4"><label class="label-forte">Prioridade</label><select id="prioridade" class="input-premium font-bold"><option value="Baixa">Baixa</option><option value="Média" selected>Média</option><option value="Alta">Alta</option></select></div>
                    </div>
                </div>
                <div class="form-section-box shadow-sm">
                    <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">2. Definição Operacional</label>
                    <div class="flex flex-wrap items-start gap-4">
                        <div class="flex-1 min-w-[140px]">
                            <label class="label-forte">Estrutura</label>
                            <select id="estrutura" required class="input-premium font-bold">
                                <option value="Análise">Análise</option>
                                <option value="Clientes">Clientes</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[140px]">
                            <div class="flex justify-between items-center mb-1"><label class="label-forte !mb-0">Frente</label><span class="btn-add-item no-print" onclick="window.openAddModal('frente')">+</span></div>
                            <select id="frente" required class="input-premium"></select>
                        </div>
                        <div class="flex-[1.5] min-w-[200px]">
                            <label class="label-forte">Classificação</label>
                            <select id="classificacao" required class="input-premium font-black text-cyan-600"><option value="Eficiência Operacional">Eficiência Operacional</option><option value="Rotina">Rotina</option></select>
                        </div>
                        <div class="flex-1 min-w-[130px]"><label class="label-forte">Status</label><select id="status" class="input-premium font-black text-slate-900" onchange="window.updateStatusUI(this.value)"><option value="Backlog">Backlog</option><option value="Em Andamento">Em Andamento</option><option value="Finalizado">Finalizado</option><option value="Despriorizado">Despriorizado</option></select></div>
                    </div>
                    
                    <!-- Flag de Dependência Externa -->
                    <div class="mt-8 pt-6 border-t border-slate-50">
                        <label class="checkbox-item w-fit mb-4 no-print">
                            <input type="checkbox" id="possui_dependencia" onchange="window.toggleDependencyFields(this.checked)">
                            <span>Possui dependência externa?</span>
                        </label>
                        <div id="dep-fields-container" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="label-forte !mb-0">Área Responsável</label>
                                    <span class="btn-add-item no-print" onclick="window.openAddModal('area_dependencia')">+</span>
                                </div>
                                <select id="area_dependencia" class="input-premium font-bold"></select>
                            </div>
                            <div>
                                <label class="label-forte">Resumo da Dependência</label>
                                <input type="text" id="resumo_dependencia" class="input-premium" placeholder="Ex: Aguardando integração de API">
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-50">
                        <div class="flex justify-between items-center mb-4">
                            <label class="label-forte !mb-0">Áreas Impactadas <span class="text-red-500 font-black">*</span></label>
                            <span class="btn-add-item no-print" onclick="window.openAddModal('area_check')">+ Nova</span>
                        </div>
                        <div id="areas-checkbox-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="form-section-box shadow-sm">
                        <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">3. Cronograma</label>
                        <div class="grid grid-cols-2 gap-6">
                            <div><label class="label-forte">Início <span class="text-red-500 font-black">*</span></label><input type="date" id="data_criacao" required class="input-premium text-xs"></div>
                            <div><label class="label-forte">Prazo Estimado <span class="text-red-500 font-black">*</span></label><input type="date" id="prazo" required onchange="window.validatePrazo(this)" class="input-premium text-xs"></div>
                        </div>
                        <div id="closure-dates" class="mt-8 pt-8 border-t border-slate-100 hidden">
                            <label class="label-forte !text-emerald-600">Conclusão Realizada</label><input type="date" id="data_conclusao" class="input-premium text-xs border-emerald-100 bg-emerald-50/20 text-slate-900">
                        </div>
                        <div id="deprioritize-box" class="mt-8 pt-8 border-t border-slate-100 hidden">
                            <label class="label-forte !text-red-600">Motivo da Despriorização <span class="text-red-500 font-black">*</span></label>
                            <textarea id="justificativa_despriorizacao" rows="3" class="input-premium text-xs" placeholder="Descreva o motivo pelo qual este projeto foi despriorizado..."></textarea>
                        </div>
                    </div>
                    <div class="form-section-box shadow-sm">
                        <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">4. Atividades / Tasks</label>
                        <div class="flex justify-between items-center mb-2">
                            <span id="progress-percent" class="text-[10px] font-black text-emerald-600">PROGRESSO: 0%</span>
                        </div>
                        <div class="progress-container"><div id="task-progress-bar" class="progress-bar-fill"></div></div>
                        <div id="tasks-list-container" class="space-y-2 my-4 max-h-48 overflow-y-auto"></div>
                        <div class="flex gap-2 no-print">
                            <input type="text" id="new-task-input" class="input-premium !text-xs" placeholder="Nova tarefa...">
                            <button type="button" onclick="window.addTaskToProject()" class="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-[10px] uppercase hover:bg-slate-800 transition-all h-[38px]">Incluir</button>
                        </div>
                    </div>
                </div>
                <div class="form-section-box shadow-sm">
                    <div class="flex justify-between items-center mb-8 pb-3 border-b border-slate-50">
                        <label class="label-forte text-slate-400 !mb-0">5. Analistas Responsáveis <span class="text-red-500 font-black">*</span></label>
                        <span class="btn-add-item no-print" onclick="window.openAddModal('analista')">+ Novo</span>
                    </div>
                    <div id="responsaveis-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-3 gap-x-12 max-h-56 overflow-y-auto pr-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                    <div class="form-section-box shadow-sm space-y-6">
                        <div>
                            <label class="label-forte">Descrição detalhada <span class="text-red-500 font-black">*</span></label>
                            <div id="description-container">
                                <div id="description-edit-mode">
                                    <textarea id="nota_inicial" rows="4" class="input-premium text-xs leading-relaxed" placeholder="Descreva o escopo e objetivos principais..."></textarea>
                                    <div class="flex justify-end mt-2 no-print">
                                        <button type="button" onclick="window.saveDescriptionUI()" class="bg-indigo-600 text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg hover:bg-indigo-700 transition-all">Incluir Descrição</button>
                                    </div>
                                </div>
                                <div id="description-view-mode" class="hidden">
                                    <div class="p-4 bg-slate-50 border border-slate-100 rounded-2xl relative group min-h-[100px]">
                                        <div id="description-text-display" class="text-xs text-slate-700 leading-relaxed font-semibold whitespace-pre-wrap"></div>
                                        <button type="button" onclick="window.editDescriptionUI()" class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-2 rounded-lg shadow-sm text-cyan-500 border border-slate-100 no-print">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pt-6 border-t border-slate-50">
                            <label class="label-forte">Log de Updates</label>
                            <div id="notes-history-list" class="space-y-3 max-h-56 overflow-y-auto mb-4 pr-3 text-[11px]"></div>
                            <div class="flex flex-col sm:flex-row gap-2 no-print">
                                <textarea id="new-milestone-note" rows="3" class="input-premium !text-xs" placeholder="Evolução de hoje..."></textarea>
                                <button type="button" onclick="window.addItemToHistory('note')" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-[10px] uppercase self-end h-[38px]">Incluir</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-section-box shadow-sm !bg-slate-50">
                        <div class="flex justify-between items-center mb-4">
                            <label class="label-forte !mb-0">Atenção Executiva</label>
                            <div class="flex gap-2 no-print">
                                <button type="button" id="toggle-list-risco" onclick="window.setAttentionType('Risco')" class="toggle-btn active-risco">Risco</button>
                                <button type="button" id="toggle-list-problema" onclick="window.setAttentionType('Problema')" class="toggle-btn inactive">Problema</button>
                            </div>
                        </div>
                        <div id="attention-history-list" class="space-y-3 max-h-48 overflow-y-auto mb-4 pr-3 text-[11px]"></div>
                        <div class="flex flex-col sm:flex-row gap-2 no-print">
                            <textarea id="new-attention-note" rows="3" class="input-premium !bg-white text-xs" placeholder="Novo alerta..."></textarea>
                            <button type="button" onclick="window.addItemToHistory('attention')" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-[10px] uppercase self-end h-[38px]">Incluir</button>
                        </div>
                    </div>
                </div>
                <div class="pt-10 flex flex-col sm:flex-row gap-4 border-t border-slate-100 no-print pb-10">
                    <button type="submit" class="bg-slate-900 text-white px-12 py-5 rounded-[1.5rem] font-black shadow-2xl flex-1 uppercase text-xs tracking-widest hover:scale-[1.01] transition-all">Salvar Projeto</button>
                    <button type="button" onclick="window.trySwitchTab('dashboard');" class="bg-white text-slate-400 border border-slate-200 px-10 py-5 rounded-[1.5rem] font-bold text-xs uppercase">Sair</button>
                </div>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration fallback for standalone or environment variables
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "",
            authDomain: "painel-de-projeto.firebaseapp.com",
            projectId: "painel-de-projeto",
            storageBucket: "painel-de-projeto.firebasestorage.app",
            messagingSenderId: "768185401154",
            appId: "1:768185401154:web:d89782c16620a1bf2852db"
        };

        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-eficiencia-2026';
        
        let projects = [], planningCycles = [], indicatorDefinitions = [], tempNotes = [], tempTasks = [], tempAttention = [], user = null, charts = {}, isFormDirty = false, pendingTab = null, idToDelete = null, typeToDelete = null, editingCycleId = null;

        let analystToEdit = null;
        let previousStatusValue = null;

        const defaultTeam = ["Ariel Mori", "Bárbara Pammela Savazi", "Cauan Pereira Da Silva", "Diego Francisco Rocha", "Hudson Nestor Pereira Cortes", "Lucas Henrique Jantsch", "Luiz Gustavo Ribeiro", "Michael Gabriel Moraes Faria", "Natalia Pereira", "Otávio Augusto Oliveira", "Simone Thomé de Andrade"].sort();
        const defaultAreas = ["Análise", "CX", "Comunicação", "Mesa", "Onboarding"].sort();
        const defaultFrentes = ["Automação", "Performance", "Reestruturação", "Simplificação"].sort();
        const defaultDependencies = ["Engenharia", "Eficiência", "Compras", "Privacidade"].sort();

        const teamAvatars = {
    "Ariel Mori": "",
    "Bárbara Pammela Savazi": "",
    "Cauan Pereira Da Silva": "",
    "Diego Francisco Rocha": "",
    "Hudson Nestor Pereira Cortes": "",
    "Lucas Henrique Jantsch": "",
    "Luiz Gustavo Ribeiro": "",
    "Michael Gabriel Moraes Faria": "",
    "Natalia Pereira": "",
    "Otávio Augusto Oliveira": "",
    "Simone Thomé de Andrade": ""
        };

        const monthLabels = {
            "H1": ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun"],
            "H2": ["Jul", "Ago", "Set", "Out", "Nov", "Dez"]
        };

        const hideLoader = () => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.visibility = 'hidden';
                setTimeout(() => overlay.style.display = 'none', 500);
            }
        };

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { 
                console.error("Auth error", e);
                hideLoader(); 
            }
        };

        const safeLinkify = (text) => {
            if (!text) return "";
            const div = document.createElement('div');
            div.textContent = text;
            const escapedText = div.innerHTML;
            const urlPattern = /(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return escapedText.replace(urlPattern, (url) => {
                return `<a href="${url}" target="_blank" class="text-cyan-500 underline hover:text-cyan-700 transition-colors font-bold">${url}</a>`;
            });
        };

        const getAnalystAvatarUrl = (name) => {
            if (teamAvatars[name] && teamAvatars[name].trim() !== "") {
                return teamAvatars[name];
            }
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&bold=true&size=128`;
        };

        onAuthStateChanged(auth, u => {
            user = u;
            if (u) {
                document.getElementById('sync-indicator')?.classList.remove('hidden');
                
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), snap => {
                    projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.refreshUI();
                    hideLoader();
                }, (err) => { console.error(err); hideLoader(); });

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'indicator_definitions'), snap => {
                    indicatorDefinitions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.renderPlanningInputs();
                    window.renderPlanningTimeline();
                }, (err) => console.error(err));

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'planning'), snap => {
                    planningCycles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.renderPlanningTimeline();
                }, (err) => console.error(err));
            } else {
                setTimeout(hideLoader, 2000);
            }
        });

        window.addNewIndicatorDefinition = async () => {
            if(!user) return;
            const name = document.getElementById('new-indicator-name').value.trim();
            const type = document.getElementById('new-indicator-type').value;
            const unit = document.getElementById('new-indicator-unit').value;
            if(!name) { alertModal("Atenção", "O nome do indicador é obrigatório."); return; }
            const data = { name, type, unit, createdAt: new Date().toISOString() };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'indicator_definitions'), data);
            document.getElementById('new-indicator-name').value = '';
            document.getElementById('add-indicator-modal').style.display = 'none';
        };

        window.addNewYearPlanning = () => {
            const yearInput = document.getElementById('new-year-input');
            const year = yearInput.value;
            if(!year) return;
            const select = document.getElementById('planning-year');
            const option = new Option(year, year, true, true);
            select.add(option);
            document.getElementById('add-year-modal').style.display = 'none';
            yearInput.value = '';
        };

        window.switchTab = (t) => {
            ['dashboard', 'form', 'list', 'archive', 'planning'].forEach(v => document.getElementById('view-'+v)?.classList.add('hidden'));
            document.getElementById('view-'+t)?.classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active-tab', b.id === `tab-${t}`));
            if (t === 'form') resetForm();
            if (t === 'planning') {
                window.renderPlanningInputs();
                window.renderPlanningTimeline();
            }
            window.refreshUI();
            window.scrollTo(0,0);
        };

        window.trySwitchTab = (tab) => { 
            if (isFormDirty) {
                document.getElementById('confirm-exit-modal').style.display = 'flex';
            } else {
                window.switchTab(tab); 
            }
        };

        // Lógica condicional da dependência
        window.toggleDependencyFields = (checked) => {
            const container = document.getElementById('dep-fields-container');
            container.classList.toggle('hidden', !checked);
            if (!checked) {
                document.getElementById('area_dependencia').selectedIndex = 0;
                document.getElementById('resumo_dependencia').value = "";
            }
            isFormDirty = true;
        };

        window.renderPlanningInputs = () => {
            const container = document.getElementById('dynamic-kpi-inputs-container');
            const semester = document.getElementById('planning-semester').value;
            const labels = monthLabels[semester];
            if(!container) return;
            container.innerHTML = '';
            if(indicatorDefinitions.length === 0) {
                container.innerHTML = '<div class="p-8 border-2 border-dashed border-slate-200 rounded-3xl text-center"><p class="text-slate-400 font-bold text-xs uppercase tracking-widest">Nenhuma meta cadastrada. Clique em "+ Novo Indicador" acima.</p></div>';
                return;
            }
            indicatorDefinitions.forEach(ind => {
                const div = document.createElement('div');
                div.className = "mb-10 pb-8 border-b border-slate-100 last:border-0";
                let monthlyInputsHtml = '';
                labels.forEach(m => {
                    monthlyInputsHtml += `
                        <div class="kpi-input-box">
                            <label class="!text-[8px]">${m}</label>
                            <input type="number" step="0.01" id="plan-mth-${ind.id}-${m}" class="input-premium !py-1.5 !px-2 !text-[11px]" placeholder="0,00">
                        </div>`;
                });
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-5">
                        <div class="flex items-center gap-2">
                             <h4 class="label-forte !text-slate-900 !mb-0 !text-[10px] tracking-tight">${ind.name}</h4>
                             <span class="bg-slate-100 text-slate-500 text-[8px] px-2 py-0.5 rounded-full font-black uppercase">${ind.unit || 'un'}</span>
                        </div>
                        <button onclick="window.openDeleteModal('${ind.id}', 'indicator')" class="text-slate-300 hover:text-red-500 transition-all p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                    <div class="kpi-row !mb-4">
                        <div class="kpi-input-box"><label>Baseline</label><input type="number" step="0.01" id="plan-b-${ind.id}" class="input-premium !py-2 !px-3 !bg-slate-50" placeholder="0,00"></div>
                        <div class="kpi-input-box"><label class="!text-indigo-500">Meta Ciclo</label><input type="number" step="0.01" id="plan-m-${ind.id}" class="input-premium !py-2 !px-3 border-indigo-100" placeholder="0,00"></div>
                        <div class="kpi-input-box"><label class="!text-emerald-500">Real Médio</label><input type="number" step="0.01" id="plan-r-${ind.id}" class="input-premium !py-2 !px-3 border-emerald-100" placeholder="Automático" readonly></div>
                    </div>
                    <label class="label-forte !text-[8px] !mb-2">Acompanhamento Mensal (${semester})</label>
                    <div class="monthly-grid">${monthlyInputsHtml}</div>`;
                container.appendChild(div);
                
                labels.forEach(m => {
                    const inputEl = document.getElementById(`plan-mth-${ind.id}-${m}`);
                    if(inputEl) {
                        inputEl.addEventListener('input', () => {
                            let sum = 0, count = 0;
                            labels.forEach(mo => {
                                const val = parseFloat(document.getElementById(`plan-mth-${ind.id}-${mo}`).value);
                                if(!isNaN(val)) { sum += val; count++; }
                            });
                            document.getElementById(`plan-r-${ind.id}`).value = count > 0 ? (sum / count).toFixed(2) : '';
                        });
                    }
                });
            });
        };

        window.saveCyclePlanning = async () => {
            if(!user) return;
            const responsible = document.getElementById('planning-responsible').value;
            if(!responsible) { alertModal("Atenção", "Selecione o analista responsável."); return; }
            const semester = document.getElementById('planning-semester').value;
            const kpiValues = {};
            indicatorDefinitions.forEach(ind => {
                const monthlyData = {};
                monthLabels[semester].forEach(m => {
                    const val = document.getElementById(`plan-mth-${ind.id}-${m}`)?.value;
                    monthlyData[m] = val !== "" ? Number(val) : null;
                });
                kpiValues[ind.id] = {
                    b: Number(document.getElementById(`plan-b-${ind.id}`)?.value) || 0,
                    m: Number(document.getElementById(`plan-m-${ind.id}`)?.value) || 0,
                    r: Number(document.getElementById(`plan-r-${ind.id}`)?.value) || 0,
                    monthly: monthlyData,
                    name: ind.name, type: ind.type, unit: ind.unit || ''
                };
            });
            const data = {
                semester, year: document.getElementById('planning-year').value,
                kpis: kpiValues, registeredBy: responsible, updatedAt: new Date().toISOString()
            };
            if(editingCycleId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'planning', editingCycleId), data);
            else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'planning'), data);
            editingCycleId = null;
            alertModal("SUCESSO", "Planeamento atualizado com sucesso.", "emerald");
            window.renderPlanningTimeline();
        };

        window.renderPlanningTimeline = () => {
            const container = document.getElementById('planning-timeline-list');
            if(!container) return;
            container.innerHTML = '';
            if(planningCycles.length === 0) {
                 container.innerHTML = '<div class="h-full flex flex-col items-center justify-center p-12 text-center bg-white border border-slate-100 rounded-3xl"><p class="text-slate-400 font-bold text-xs uppercase tracking-widest leading-relaxed">Nenhum resultado consolidado.<br>Preencha os dados à esquerda e clique em Salvar Ciclo.</p></div>';
                 return;
            }
            [...planningCycles].sort((a,b) => b.year - a.year || b.semester.localeCompare(a.semester)).forEach(c => {
                const card = document.createElement('div');
                card.className = "cycle-card !p-8 mb-6";
                let kpisHtml = '';
                Object.entries(c.kpis || {}).forEach(([id, k]) => {
                    const canvasId = `chart-${c.id}-${id}`;
                    let adherence = 0;
                    if(k.m > 0) {
                        if(k.type === 'reducao') adherence = k.r <= k.m ? 100 : Math.max(0, 100 - ((k.r - k.m) / k.m * 100));
                        else if(k.type === 'crescimento') adherence = Math.min(100, (k.r / k.m * 100));
                        else adherence = 100; 
                    } else if (k.r > 0 && k.m === 0 && k.type === 'reducao') adherence = 0;
                    else adherence = 100;
                    kpisHtml += `
                        <div class="mb-12 last:mb-0">
                            <div class="flex justify-between items-end mb-6">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="label-forte !mb-0">${k.name}</span>
                                        <span class="bg-slate-100 text-slate-400 text-[8px] px-2 py-0.5 rounded-full font-black uppercase">${k.unit || 'un'}</span>
                                    </div>
                                    <div class="flex gap-4 text-[10px] font-bold">
                                        <span class="text-slate-400">Base: ${k.b}</span>
                                        <span class="text-indigo-500">Meta: ${k.m}</span>
                                        <span class="text-emerald-600">Real: ${k.r}</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-[20px] font-black ${adherence >= 100 ? 'text-emerald-500' : 'text-amber-500'}">${Math.round(adherence)}%</span>
                                    <p class="text-[8px] font-black uppercase text-slate-300 tracking-widest">Aderência</p>
                                </div>
                            </div>
                            <div class="h-48 w-full bg-slate-50/50 rounded-2xl p-4"><canvas id="${canvasId}"></canvas></div>
                        </div>`;
                });
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-10 pb-6 border-b border-slate-50">
                        <div>
                            <h3 class="text-2xl font-black text-slate-900">${c.year} <span class="text-cyan-400">${c.semester}</span></h3>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Responsável: ${c.registeredBy}</span>
                        </div>
                        <div class="flex gap-2 no-print">
                            <button onclick="window.editCycle('${c.id}')" class="text-[9px] font-black px-4 py-2 bg-slate-100 rounded-xl hover:bg-cyan-50 hover:text-cyan-600 transition-all uppercase">Editar</button>
                            <button onclick="window.deleteCycle('${c.id}')" class="text-red-200 hover:text-red-500 p-2 transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </div>${kpisHtml}`;
                container.appendChild(card);
                
                Object.entries(c.kpis || {}).forEach(([id, k]) => {
                    const canvasEl = document.getElementById(`chart-${c.id}-${id}`);
                    if(!canvasEl) return;
                    const ctx = canvasEl.getContext('2d');
                    const months = Object.keys(k.monthly || {});
                    const values = Object.values(k.monthly || {});
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                { label: 'Realizado', data: values, borderColor: '#00e5ff', backgroundColor: 'rgba(0, 229, 255, 0.1)', borderWidth: 4, pointRadius: 6, pointBackgroundColor: '#00e5ff', fill: true, tension: 0.4 },
                                { label: 'Meta', data: new Array(months.length).fill(k.m), borderColor: '#6366f1', borderDash: [5, 5], borderWidth: 2, pointRadius: 0 },
                                { label: 'Baseline', data: new Array(months.length).fill(k.b), borderColor: '#94a3b8', borderWidth: 1, pointRadius: 0 }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, datalabels: { display: false } },
                            scales: {
                                y: { grid: { color: '#f1f5f9' }, ticks: { font: { size: 9, weight: 'bold' } } },
                                x: { grid: { display: false }, ticks: { font: { size: 9, weight: 'bold' } } }
                            }
                        }
                    });
                });
            });
        };

        window.editCycle = (id) => {
            const c = planningCycles.find(x => x.id === id);
            if(!c) return;
            editingCycleId = id;
            document.getElementById('planning-semester').value = c.semester;
            document.getElementById('planning-year').value = c.year;
            document.getElementById('planning-responsible').value = c.registeredBy || '';
            window.renderPlanningInputs();
            Object.entries(c.kpis || {}).forEach(([indId, val]) => {
                if(document.getElementById(`plan-b-${indId}`)) document.getElementById(`plan-b-${indId}`).value = val.b;
                if(document.getElementById(`plan-m-${indId}`)) document.getElementById(`plan-m-${indId}`).value = val.m;
                if(document.getElementById(`plan-r-${indId}`)) document.getElementById(`plan-r-${indId}`).value = val.r;
                Object.entries(val.monthly || {}).forEach(([m, v]) => {
                    const el = document.getElementById(`plan-mth-${indId}-${m}`);
                    if(el) el.value = v;
                });
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.deleteCycle = (id) => { window.openDeleteModal(id, 'planning'); };

        function renderChart(id, type, data, colors) { 
            if(charts[id]) charts[id].destroy(); 
            const canvas = document.getElementById(id); if(!canvas) return; 
            charts[id] = new Chart(canvas.getContext('2d'), { 
                type: type, 
                data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colors, borderWidth: 0 }] }, 
                plugins: [ChartDataLabels],
                options: { responsive: true, maintainAspectRatio: false, scales: type === 'pie' ? {} : { x: { grid: { display: false } }, y: { grid: { display: false }, ticks: { display: false } } }, plugins: { legend: { display: type === 'pie', position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } }, datalabels: { display: true, color: type === 'pie' ? '#fff' : '#070047', font: { weight: 'bold', size: 10 } } } } 
            }); 
        }

        window.refreshUI = function() {
            const today = new Date(); today.setHours(0,0,0,0);
            const todayStr = today.toISOString().split('T')[0];
            const activeTab = document.querySelector('.active-tab')?.id.split('-')[1];
            if(activeTab === 'planning') return;
            const prefix = activeTab === 'dashboard' ? 'dash' : activeTab === 'list' ? 'list' : 'archive';
            const searchVal = document.getElementById(`${prefix}-search`)?.value.toLowerCase() || '';
            const periodVal = document.getElementById(`${prefix}-filter-period`)?.value || 'all';
            const dateStart = document.getElementById(`${prefix}-filter-start`)?.value || '';
            const dateEnd = document.getElementById(`${prefix}-filter-end`)?.value || '';
            const analistaVal = document.getElementById(`${prefix}-filter-analista`)?.value || '';
            const areaVal = document.getElementById(`${prefix}-filter-area`)?.value || '';
            const frenteVal = document.getElementById(`${prefix}-filter-frente`)?.value || '';
            const classVal = document.getElementById(`${prefix}-filter-classificacao`)?.value || '';
            const estruturaVal = document.getElementById(`${prefix}-filter-estrutura`)?.value || '';
            
            const filtered = projects.filter(p => {
                let match = true;
                if (searchVal && !p.iniciativa?.toLowerCase().includes(searchVal)) match = false;
                if (analistaVal && !p.responsavel?.includes(analistaVal)) match = false;
                if (areaVal && (!p.time || !p.time.includes(areaVal))) match = false;
                if (frenteVal && p.frente !== frenteVal) match = false;
                if (classVal && p.classificacao !== classVal) match = false;
                if (estruturaVal && p.estrutura !== estruturaVal) match = false;
                if (p.data_criacao) {
                    if (dateStart && p.data_criacao < dateStart) match = false;
                    if (dateEnd && p.data_criacao > dateEnd) match = false;
                }
                if (periodVal !== 'all' && p.data_criacao && !dateStart && !dateEnd) {
                    const d = new Date(p.data_criacao), n = new Date();
                    if(periodVal === 'mes') match = match && d.getMonth() === n.getMonth() && d.getFullYear() === n.getFullYear();
                    if(periodVal === 'trimestre') match = match && Math.floor(n.getMonth() / 3) === Math.floor(d.getMonth() / 3);
                    if(periodVal === 'ano') match = match && d.getFullYear() === n.getFullYear();
                }
                return match;
            });

            if (activeTab === 'dashboard') {
                const f = filtered.filter(p => p.status === 'Finalizado');
                const totalRisks = filtered.reduce((acc, p) => acc + (p.attention?.filter(a => a.type === 'Risco').length || 0), 0);
                const totalProblems = filtered.reduce((acc, p) => acc + (p.attention?.filter(a => a.type === 'Problema').length || 0), 0);
                const inSLA = filtered.filter(p => {
                    if (p.status === 'Finalizado' || p.status === 'Despriorizado') return true;
                    if (!p.prazo) return true;
                    return p.prazo >= todayStr;
                });
                const slaPerc = filtered.length ? Math.round((inSLA.length / filtered.length) * 100) : 100;
                const saude = Math.max(0, 100 - (totalProblems * 10) - (totalRisks * 5));
                
                document.getElementById('kpi-total').innerText = filtered.length;
                document.getElementById('kpi-performance').innerText = (filtered.length ? Math.round((f.length/filtered.length)*100) : 0) + '%';
                document.getElementById('kpi-riscos').innerText = totalRisks;
                document.getElementById('kpi-problemas').innerText = totalProblems;
                document.getElementById('kpi-sla').innerText = slaPerc + '%';
                document.getElementById('kpi-saude').innerText = saude + '%';
                
                const paleta = ['#FF1A5C', '#00A5FF', '#A35F9D', '#8D7AD2', '#32B77E', '#5C86C4', '#070047', '#333333'];
                
                renderChart('chartStatus', 'pie', filtered.reduce((a,v) => { a[v.status]=(a[v.status]||0)+1; return a; }, {}), paleta);
                
                const areaStats = {};
                filtered.forEach(p => { (Array.isArray(p.time) ? p.time : [p.time]).forEach(area => { if(area) areaStats[area] = (areaStats[area] || 0) + 1; }); });
                renderChart('chartTime', 'bar', areaStats, paleta);
                
                renderChart('chartFrente', 'bar', filtered.reduce((a,v) => { a[v.frente||'N/A']=(a[v.frente||'N/A']||0)+1; return a; }, {}), paleta);
                renderChart('chartLeadTime', 'bar', { 'Médio': 10, 'Atual': 8 }, ['#00A5FF', '#FF1A5C']);
                
                const bG = document.getElementById('grid-backlog'), aG = document.getElementById('grid-andamento');
                if(bG) bG.innerHTML = ''; if(aG) aG.innerHTML = '';
                
                const sortedDash = [...filtered].sort((a, b) => (b.data_criacao || '').localeCompare(a.data_criacao || ''));
                sortedDash.forEach(p => {
                    const card = createProjectCard(p, today);
                    if(p.status === 'Backlog' && bG) bG.innerHTML += card;
                    else if(p.status === 'Em Andamento' && aG) aG.innerHTML += card;
                });
                
                document.getElementById('count-backlog').innerText = filtered.filter(p => p.status === 'Backlog').length;
                document.getElementById('count-andamento').innerText = filtered.filter(p => p.status === 'Em Andamento').length;
            }

            if (activeTab === 'list') {
                const tbody = document.getElementById('detailed-table-body');
                if(tbody) {
                    tbody.innerHTML = '';
                    filtered.forEach(p => {
                        const areasDisplay = Array.isArray(p.time) ? p.time.join(', ') : (p.time || '--');
                        tbody.innerHTML += `<tr><td class="p-6 uppercase font-bold">${p.iniciativa}</td><td class="p-6">${areasDisplay}</td><td class="p-6 text-center">${p.responsavel?.join(', ') || '--'}</td><td class="p-6 text-center">${p.data_criacao?.split('-').reverse().join('/') || '--'}</td><td class="p-6 text-center font-bold">${p.prazo?.split('-').reverse().join('/') || '--'}</td><td class="p-6 text-center"><span class="status-pill" style="background: ${getStatusColor(p.status)}">${p.status}</span></td><td class="p-6 text-right flex items-center justify-end gap-3 no-print"><button onclick="window.editProjectByID('${p.id}')" class="text-cyan-500 uppercase text-[10px] font-black">Gerenciar</button><button onclick="window.openDeleteModal('${p.id}', 'projects')" class="text-red-400 hover:text-red-600 transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td></tr>`;
                    });
                }
            }

            if (activeTab === 'archive') {
                const fG = document.getElementById('grid-finalizado'), dG = document.getElementById('grid-despriorizado');
                if(fG) fG.innerHTML = ''; if(dG) dG.innerHTML = '';
                const sortedFinalizados = filtered.filter(p => p.status === 'Finalizado').sort((a, b) => (b.data_conclusao || '').localeCompare(a.data_conclusao || ''));
                const sortedDespriorizados = filtered.filter(p => p.status === 'Despriorizado').sort((a, b) => (b.data_criacao || '').localeCompare(a.data_criacao || ''));
                sortedFinalizados.forEach(p => { if(fG) fG.innerHTML += createProjectCard(p, today); });
                sortedDespriorizados.forEach(p => { if(dG) dG.innerHTML += createProjectCard(p, today); });
                document.getElementById('count-finalizado-archive').innerText = sortedFinalizados.length;
                document.getElementById('count-despriorizado-archive').innerText = sortedDespriorizados.length;
            }
        };

        function getStatusColor(s) {
            if(s === 'Backlog') return '#94a3b8';
            if(s === 'Em Andamento') return '#fabd23';
            if(s === 'Finalizado') return '#10b981';
            return '#ef4444';
        }

        function createProjectCard(p, today) {
            const todayStr = today.toISOString().split('T')[0];
            const start = p.data_criacao ? new Date(p.data_criacao) : today;
            const openDays = Math.floor((today - start) / 86400000);
            const topColor = getStatusColor(p.status);
            const totalTasks = p.tasks?.length || 0, completedTasks = p.tasks?.filter(t => t.completed).length || 0;
            const pCent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const areasDisplay = Array.isArray(p.time) ? p.time.join(', ') : (p.time || 'MESA');
            
            // Lógica de Alerta para Dependência Externa (Nova UX)
            const hasDependency = p.possui_dependencia === true;
            const cardExtraStyle = hasDependency ? 'border-l-8 border-black opacity-95' : '';
            const dependencyBox = hasDependency ? `
                <div class="mt-4 p-3 bg-slate-100 border border-slate-200 rounded-xl">
                    <div class="flex justify-between items-center mb-1">
                        <span class="status-pill !min-w-0 !px-2 bg-black text-white font-black text-[7px]">🏷️ ${p.area_dependencia || 'DEP. EXTERNA'}</span>
                    </div>
                    <p class="text-[9px] font-bold text-slate-800 leading-tight">${p.resumo_dependencia || 'Aguardando ação externa.'}</p>
                </div>` : '';

            let avatarStackHtml = "";
            if (p.responsavel && p.responsavel.length > 0) {
                const avatars = p.responsavel.map(name => {
                    return `<img src="${getAnalystAvatarUrl(name)}" title="${name}" class="w-8 h-8 rounded-full border-2 border-white ring-2 ring-slate-50 object-cover shadow-sm bg-slate-200 transition-transform hover:scale-110" alt="${name}">`;
                }).join('');
                avatarStackHtml = `<div class="flex -space-x-3 overflow-hidden ml-1 my-1">${avatars}</div>`;
            }

            let deadlineAlert = "";
            if (p.status !== 'Finalizado' && p.status !== 'Despriorizado' && p.prazo) {
                if (p.prazo < todayStr) deadlineAlert = `<span class="status-pill bg-red-600 text-white animate-pulse">EM ATRASO</span>`;
                else if (p.prazo === todayStr) deadlineAlert = `<span class="status-pill bg-amber-500 text-white font-black">FINALIZA HOJE</span>`;
            }
            let deprioritizeInfo = (p.status === 'Despriorizado' && p.justificativa_despriorizacao) ? `<div class="mt-4 p-3 bg-red-50 border border-red-100 rounded-xl"><span class="label-forte !text-red-600 !mb-1 !text-[8px]">Motivo da Despriorização</span><p class="text-[10px] font-bold text-red-800 leading-tight">${p.justificativa_despriorizacao}</p></div>` : "";
            let conclusionInfo = (p.status === 'Finalizado' && p.data_conclusao) ? `<div class="flex justify-between items-center text-emerald-600"><span>CONCLUÍDO EM:</span><span>${p.data_conclusao.split('-').reverse().join('/')}</span></div>` : "";

            return `<div class="card-project p-6 flex flex-col h-full bg-white shadow-sm border-slate-100 ${cardExtraStyle}" style="border-top-color: ${topColor}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex flex-col gap-1">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${p.estrutura || 'ANÁLISE'} | ${areasDisplay}</span>
                        ${avatarStackHtml}
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="status-pill text-white" style="background: ${topColor}">${p.status}</span>
                        ${deadlineAlert}
                    </div>
                </div>
                <h3 class="text-[15px] font-black mb-6 uppercase leading-tight text-slate-900 min-h-[40px]">${p.iniciativa}</h3>
                <div class="space-y-2 text-[10px] font-bold text-slate-400">
                    <div class="flex justify-between items-center"><span>ESTIMADO:</span><span class="text-slate-900">${p.prazo ? p.prazo.split('-').reverse().join('/') : '--'}</span></div>
                    <div class="flex justify-between items-center"><span>CRIAÇÃO:</span><span class="text-slate-900">${p.data_criacao ? p.data_criacao.split('-').reverse().join('/') : '--'}</span></div>
                    <div class="flex justify-between items-center"><span>DURAÇÃO:</span><span class="text-slate-900">${Math.max(0, openDays)} dias</span></div>
                    ${conclusionInfo}
                    <div class="pt-2">
                        <div class="flex justify-between items-center mb-1"><span>PROGRESSO</span><span class="text-emerald-500">${pCent}%</span></div>
                        <div class="progress-container"><div class="progress-bar-fill" style="width: ${pCent}%"></div></div>
                    </div>
                </div>
                ${deprioritizeInfo}
                ${dependencyBox}
                <button onclick="window.editProjectByID('${p.id}')" class="w-full bg-[#000a28] text-white py-3.5 rounded-xl font-black uppercase text-[10px] hover:bg-slate-800 transition-all mt-6 shadow-lg tracking-widest no-print">GERENCIAR</button>
            </div>`;
        }

        window.saveDescriptionUI = () => {
            const val = document.getElementById('nota_inicial').value.trim();
            if(!val) { alertModal("Atenção", "O campo Descrição detalhada é obrigatório."); return; }
            document.getElementById('description-text-display').innerHTML = safeLinkify(val);
            document.getElementById('description-edit-mode').classList.add('hidden');
            document.getElementById('description-view-mode').classList.remove('hidden');
            isFormDirty = true;
        };

        window.editDescriptionUI = () => {
            document.getElementById('description-edit-mode').classList.remove('hidden');
            document.getElementById('description-view-mode').classList.add('hidden');
        };

        window.setDirty = () => { isFormDirty = true; };

        window.updateStatusUI = (v) => {
            const clo = document.getElementById('closure-dates'), dep = document.getElementById('deprioritize-box');
            if(clo) clo.classList.toggle('hidden', v !== 'Finalizado');
            if(dep) dep.classList.toggle('hidden', v !== 'Despriorizado');
            if (v === 'Finalizado') {
                const dateEl = document.getElementById('data_conclusao');
                if (dateEl && !dateEl.value) dateEl.value = new Date().toISOString().split('T')[0];
            }
            if (previousStatusValue && previousStatusValue !== v) {
                const logMsg = `Status alterado de "${previousStatusValue}" para "${v}"`;
                const color = getStatusColor(v);
                tempNotes.unshift({ 
                    date: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 
                    text: logMsg, color: color
                });
                window.renderHistoryLists();
                isFormDirty = true;
            }
            previousStatusValue = v; 
        };

        window.validatePrazo = function(input) {
            const selectedDate = input.value;
            const todayStr = new Date().toISOString().split('T')[0];
            if (selectedDate) {
                if (selectedDate < todayStr) {
                    alertModal("Data Inválida", "O Prazo Estimado não pode ser uma data retroativa.");
                    input.value = todayStr;
                } else if (selectedDate === todayStr) alertModal("Atenção ao Prazo", "O prazo de finalização do seu projeto é hoje.", "emerald");
            }
        };

        window.confirmFinalizationQuick = () => {
            const statusEl = document.getElementById('status'), dateEl = document.getElementById('data_conclusao');
            if(statusEl) statusEl.value = 'Finalizado'; 
            if(dateEl) dateEl.value = new Date().toISOString().split('T')[0];
            window.updateStatusUI('Finalizado'); 
            isFormDirty = true; 
            document.getElementById('project-form')?.scrollIntoView({ behavior: 'smooth' });
        };

        window.openDeleteModal = (id, type = 'projects') => { 
            idToDelete = id; typeToDelete = type;
            const titleEl = document.getElementById('delete-modal-title');
            const descEl = document.getElementById('delete-modal-desc');
            if(titleEl) {
                if (type === 'planning') { titleEl.innerText = 'Excluir Ciclo?'; descEl.innerText = 'Os resultados consolidados deste ciclo serão perdidos.'; }
                else if (type === 'indicator') { titleEl.innerText = 'Excluir Indicador?'; descEl.innerText = 'Esta meta não aparecerá mais nos próximos planejamentos.'; }
                else if (type === 'analista') { titleEl.innerText = 'Excluir Analista?'; descEl.innerText = `Remover "${id}" da lista de seleção? Projetos históricos manterão o registro.`; }
                else { titleEl.innerText = 'Excluir Iniciativa?'; descEl.innerText = 'A remoção será permanente.'; }
            }
            document.getElementById('delete-modal').style.display = 'flex'; 
        };

        window.closeDeleteModal = () => { idToDelete = null; typeToDelete = null; document.getElementById('delete-modal').style.display = 'none'; };
        
        window.confirmDelete = async () => { 
            if(!user) return;
            if (typeToDelete === 'analista') { window.executeDeleteAnalista(idToDelete); window.closeDeleteModal(); return; }
            if(idToDelete && typeToDelete) { 
                let collectionPath = typeToDelete === 'planning' ? 'planning' : (typeToDelete === 'indicator' ? 'indicator_definitions' : 'projects');
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionPath, idToDelete)); 
                window.closeDeleteModal(); 
            } 
        };

        window.saveAndExit = () => { document.getElementById('project-form').requestSubmit(); isFormDirty = false; document.getElementById('confirm-exit-modal').style.display = 'none'; };
        window.discardAndExit = () => { isFormDirty = false; document.getElementById('confirm-exit-modal').style.display = 'none'; window.switchTab('dashboard'); };
        
        function resetForm() {
            const projectForm = document.getElementById('project-form'); 
            if(projectForm) projectForm.reset();
            document.getElementById('edit-id').value = '';
            document.querySelectorAll('input[name="area_check"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="responsavel_check"]').forEach(cb => cb.checked = false);
            document.getElementById('possui_dependencia').checked = false;
            window.toggleDependencyFields(false);
            tempNotes = []; tempTasks = []; tempAttention = []; isFormDirty = false;
            window.renderHistoryLists(); window.renderTasksList(); window.renderAttentionList();
            previousStatusValue = null; window.updateStatusUI('Backlog');
            document.getElementById('btn-concluir-quick').classList.add('hidden');
            document.getElementById('description-edit-mode').classList.remove('hidden');
            document.getElementById('description-view-mode').classList.add('hidden');
            document.getElementById('description-text-display').innerHTML = '';
            window.originalDependencyState = false;
        }

        window.originalDependencyState = false;

        window.editProjectByID = (id) => {
            const p = projects.find(x => x.id === id); if (!p) return;
            window.switchTab('form');
            document.getElementById('edit-id').value = p.id;
            document.getElementById('iniciativa').value = p.iniciativa || '';
            document.getElementById('frente').value = p.frente || '';
            document.getElementById('status').value = p.status || 'Backlog';
            document.getElementById('estrutura').value = p.estrutura || 'Análise';
            document.getElementById('classificacao').value = p.classificacao || 'Eficiência Operacional';
            document.getElementById('prazo').value = p.prazo || '';
            document.getElementById('data_criacao').value = p.data_criacao || '';
            document.getElementById('nota_inicial').value = p.nota_inicial || '';
            document.getElementById('justificativa_despriorizacao').value = p.justificativa_despriorizacao || '';
            document.getElementById('data_conclusao').value = p.data_conclusao || '';
            
            // Popula dependência
            const depChecked = p.possui_dependencia === true;
            document.getElementById('possui_dependencia').checked = depChecked;
            window.originalDependencyState = depChecked;
            window.toggleDependencyFields(depChecked);
            if (depChecked) {
                document.getElementById('area_dependencia').value = p.area_dependencia || '';
                document.getElementById('resumo_dependencia').value = p.resumo_dependencia || '';
            }

            previousStatusValue = p.status || 'Backlog';
            window.updateStatusUI(previousStatusValue);
            tempNotes = p.notes || []; tempTasks = p.tasks || []; tempAttention = p.attention || [];
            window.renderHistoryLists(); window.renderTasksList(); window.renderAttentionList();
            const pAreas = Array.isArray(p.time) ? p.time : [p.time];
            document.querySelectorAll('input[name="area_check"]').forEach(cb => { cb.checked = pAreas.includes(cb.value); });
            document.querySelectorAll('input[name="responsavel_check"]').forEach(cb => { cb.checked = p.responsavel?.includes(cb.value); });
            document.getElementById('btn-concluir-quick').classList.toggle('hidden', p.status === 'Finalizado');
            if(p.nota_inicial) {
                document.getElementById('description-text-display').innerHTML = safeLinkify(p.nota_inicial);
                document.getElementById('description-edit-mode').classList.add('hidden');
                document.getElementById('description-view-mode').classList.remove('hidden');
            }
        };

        window.renderTasksList = () => {
            const container = document.getElementById('tasks-list-container'); if(!container) return; container.innerHTML = ''; 
            tempTasks.forEach(t => { container.innerHTML += `<div class="task-item text-slate-800"><input type="checkbox" class="no-print" ${t.completed ? 'checked' : ''} onchange="window.toggleTaskStatus(${t.id})"><span class="flex-1 text-xs font-bold ${t.completed ? 'line-through text-slate-300' : 'text-slate-700'}">${t.text}</span><button type="button" onclick="window.removeTaskFromProject(${t.id})" class="text-red-500 no-print"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>`; }); 
            window.updateTaskProgress();
        };
        window.updateTaskProgress = function() {
            const total = tempTasks.length, completed = tempTasks.filter(t => t.completed).length, percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            const bar = document.getElementById('task-progress-bar'), txt = document.getElementById('progress-percent');
            if(bar) bar.style.width = percent + '%'; if(txt) txt.innerText = `PROGRESSO: ${percent}%`;
        };
        window.toggleTaskStatus = (id) => { tempTasks = tempTasks.map(t => t.id === id ? {...t, completed: !t.completed} : t); window.renderTasksList(); isFormDirty = true; };
        window.removeTaskFromProject = (id) => { tempTasks = tempTasks.filter(t => t.id !== id); window.renderTasksList(); isFormDirty = true; };
        window.addTaskToProject = () => { const input = document.getElementById('new-task-input'), val = input?.value.trim(); if(!val) return; tempTasks.push({ id: Date.now(), text: val, completed: false }); if(input) input.value = ''; window.renderTasksList(); isFormDirty = true; };
        
        window.renderHistoryLists = () => { 
            const l = document.getElementById('notes-history-list'); 
            if(l) { 
                l.innerHTML = ''; 
                tempNotes.forEach(n => {
                    const borderStyle = n.color ? `border-left: 4px solid ${n.color}` : '';
                    const labelColor = n.color ? '' : 'text-cyan-500';
                    const customLabelStyle = n.color ? `color: ${n.color}` : '';
                    l.innerHTML += `
                        <div class="history-entry" style="${borderStyle}">
                            <span class="font-black text-[9px] uppercase ${labelColor}" style="${customLabelStyle}">${n.date}</span>
                            <div class="mt-1 font-semibold text-xs text-slate-700">${safeLinkify(n.text)}</div>
                        </div>`;
                }); 
            } 
        };

        window.addItemToHistory = (type) => {
            const inputId = type === 'note' ? 'new-milestone-note' : 'new-attention-note', val = document.getElementById(inputId).value; if(!val) return;
            const item = { date: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), text: val };
            if(type === 'note') { tempNotes.unshift(item); window.renderHistoryLists(); }
            else { item.type = document.getElementById('impedimento_tipo_list').value; tempAttention.unshift(item); window.renderAttentionList(); }
            document.getElementById(inputId).value = ''; isFormDirty = true;
        };

        window.renderAttentionList = () => { const l = document.getElementById('attention-history-list'); if(l) { l.innerHTML = ''; tempAttention.forEach((a, i) => { const color = a.type === 'Problema' ? 'border-red-500' : 'border-amber-500'; l.innerHTML += `<div class="history-entry border-l-4 ${color}"><div class="flex justify-between items-start"><span class="font-black text-[9px] uppercase">${a.type} | ${a.date}</span><button type="button" onclick="window.removeAttention(${i})" class="text-slate-300 no-print">✕</button></div><p class="mt-1 font-semibold text-xs">${a.text}</p></div>`; }); } };
        window.removeAttention = (i) => { tempAttention.splice(i, 1); window.renderAttentionList(); isFormDirty = true; };
        window.setAttentionType = (t) => { document.getElementById('impedimento_tipo_list').value = t; document.getElementById('toggle-list-risco').className = `toggle-btn ${t==='Risco'?'active-risco':'inactive'}`; document.getElementById('toggle-list-problema').className = `toggle-btn ${t==='Problema'?'active-problema':'inactive'}`; };
        
        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault(); if(!user) return;
            const resps = Array.from(document.querySelectorAll('input[name="responsavel_check"]:checked')).map(cb => cb.value);
            const areas = Array.from(document.querySelectorAll('input[name="area_check"]:checked')).map(cb => cb.value);
            if(resps.length === 0) { alertModal("Erro", "Selecione pelo menos um Analista responsável."); return; }
            if(areas.length === 0) { alertModal("Erro", "Selecione pelo menos uma Área impactada."); return; }
            const desc = document.getElementById('nota_inicial').value.trim();
            if(!desc) { alertModal("Erro", "O campo Descrição detalhada é obrigatório."); return; }
            const id = document.getElementById('edit-id').value;
            const statusVal = document.getElementById('status').value;
            const justificativa = document.getElementById('justificativa_despriorizacao').value;
            if (statusVal === 'Despriorizado' && !justificativa.trim()) { alertModal("Campo Obrigatório", "Para despriorizar uma iniciativa, é obrigatório preencher o motivo da despriorização."); return; }
            
            const hasDep = document.getElementById('possui_dependencia').checked;
            const areaDep = document.getElementById('area_dependencia').value;

            // Lógica de Log Automático para Dependência
            const timestamp = new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            if (hasDep && !window.originalDependencyState) {
                tempNotes.unshift({ 
                    date: timestamp, 
                    text: `🏷️ Dependência criada: ${areaDep || 'Área não definida'}`, 
                    color: '#000000' 
                });
            } else if (!hasDep && window.originalDependencyState) {
                tempNotes.unshift({ 
                    date: timestamp, 
                    text: `🏷️ Dependência resolvida`, 
                    color: '#10b981' 
                });
            }

            const data = { 
                initiativeId: Date.now(), 
                iniciativa: document.getElementById('iniciativa').value, 
                time: areas, 
                estrutura: document.getElementById('estrutura').value, 
                frente: document.getElementById('frente').value, 
                classificacao: document.getElementById('classificacao').value, 
                status: document.getElementById('status').value, 
                prazo: document.getElementById('prazo').value, 
                data_criacao: document.getElementById('data_criacao').value, 
                nota_inicial: desc, 
                responsavel: resps, 
                justificativa_despriorizacao: justificativa, 
                data_conclusao: document.getElementById('data_conclusao').value, 
                notes: tempNotes, 
                tasks: tempTasks, 
                attention: tempAttention,
                possui_dependencia: hasDep,
                area_dependencia: areaDep,
                resumo_dependencia: document.getElementById('resumo_dependencia').value
            };
            
            if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id), data); 
            else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), data);
            
            isFormDirty = false; window.switchTab('dashboard');
        };

        window.exportToXLS = () => { let csv = "Iniciativa,Areas,Status\n"; projects.forEach(p => { csv += `"${p.iniciativa}","${Array.isArray(p.time) ? p.time.join('; ') : p.time}","${p.status}"\n`; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", "Projetos.csv"); link.click(); };
        window.exportPDF = () => window.print();
        
        window.openAddModal = (t) => { 
            pendingTab = t; analystToEdit = null; 
            document.getElementById('add-item-title').innerText = "Adicionar " + t.replace('_', ' '); 
            document.getElementById('btn-process-item').innerText = "Adicionar"; 
            document.getElementById('new-item-input').value = ''; 
            document.getElementById('add-item-modal').style.display = 'flex'; 
        };
        
        window.closeAddModal = () => document.getElementById('add-item-modal').style.display = 'none';
        
        window.openEditAnalistaModal = (oldName, event) => { if(event) event.stopPropagation(); pendingTab = 'analista_edit'; analystToEdit = oldName; document.getElementById('add-item-title').innerText = "Editar Analista"; document.getElementById('btn-process-item').innerText = "Salvar"; document.getElementById('new-item-input').value = oldName; document.getElementById('add-item-modal').style.display = 'flex'; };
        
        window.processAddItem = () => { 
            const v = document.getElementById('new-item-input').value.trim(); 
            if(!v) return; 
            if(pendingTab === 'analista') renderAnalista(v); 
            else if (pendingTab === 'analista_edit') window.executeEditAnalista(analystToEdit, v); 
            else if(pendingTab === 'area_check') renderAreaCheckbox(v); 
            else if(pendingTab === 'area_dependencia') { 
                const el = document.getElementById('area_dependencia');
                if(el) el.add(new Option(v, v, true, true));
            }
            else { 
                const el = document.getElementById(pendingTab); 
                if(el) el.add(new Option(v, v, true, true)); 
            } 
            window.closeAddModal(); 
            document.getElementById('new-item-input').value = ''; 
        };

        window.executeEditAnalista = (oldName, newName) => {
            const grid = document.getElementById('responsaveis-grid');
            const items = grid.querySelectorAll('.checkbox-item');
            items.forEach(item => {
                const input = item.querySelector('input');
                if(input.value === oldName) {
                    input.value = newName; item.querySelector('span').innerText = newName;
                    const btns = item.querySelectorAll('button');
                    btns[0].setAttribute('onclick', `window.openEditAnalistaModal('${newName}', event)`);
                    btns[1].setAttribute('onclick', `window.openDeleteModal('${newName}', 'analista')`);
                }
            });
            ['dash', 'list', 'planning-responsible'].forEach(prefix => {
                const sel = document.getElementById(prefix.includes('planning') ? prefix : `${prefix}-filter-analista`);
                if(sel) { for(let i=0; i<sel.options.length; i++) { if(sel.options[i].value === oldName) { sel.options[i].text = newName; sel.options[i].value = newName; } } }
            });
            analystToEdit = null;
        };
        window.executeDeleteAnalista = (name) => {
            const grid = document.getElementById('responsaveis-grid');
            const items = grid.querySelectorAll('.checkbox-item');
            items.forEach(item => { if(item.querySelector('input').value === name) item.remove(); });
            ['dash', 'list', 'planning-responsible'].forEach(prefix => {
                const sel = document.getElementById(prefix.includes('planning') ? prefix : `${prefix}-filter-analista`);
                if(sel) { for(let i=sel.options.length-1; i>=0; i--) { if(sel.options[i].value === name) sel.remove(i); } }
            });
        };
        function renderAnalista(name) { 
            const g = document.getElementById('responsaveis-grid'); if(!g) return; 
            const l = document.createElement('label'); l.className = "checkbox-item group"; 
            l.innerHTML = `
                <input type="checkbox" name="responsavel_check" value="${name}">
                <span class="flex-1">${name}</span>
                <div class="analista-item-actions no-print">
                    <button type="button" onclick="window.openEditAnalistaModal('${name}', event)" class="btn-action-small text-slate-400 hover:text-indigo-600" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                    <button type="button" onclick="window.openDeleteModal('${name}', 'analista')" class="btn-action-small text-slate-400 hover:text-red-500" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>`; 
            g.appendChild(l); 
            const pSel = document.getElementById('planning-responsible'); if(pSel) pSel.add(new Option(name, name));
            ['dash', 'list'].forEach(p => { const el = document.getElementById(`${p}-filter-analista`); if(el) el.add(new Option(name, name)); });
        }
        function renderAreaCheckbox(name) { 
            const g = document.getElementById('areas-checkbox-grid'); if(!g) return; 
            const l = document.createElement('label'); l.className = "checkbox-item"; l.innerHTML = `<input type="checkbox" name="area_check" value="${name}"><span>${name}</span>`; g.appendChild(l); 
            ['dash', 'list'].forEach(p => { const el = document.getElementById(`${p}-filter-area`); if(el) el.add(new Option(name, name)); });
        }
        function alertModal(title, msg, color = "slate") {
            const mod = document.createElement('div'); mod.className = "fixed inset-0 flex items-center justify-center bg-black/50 z-[20000]";
            const iconColor = color === "emerald" ? "bg-emerald-100 text-emerald-600" : "bg-red-100 text-red-600";
            mod.innerHTML = `<div class="bg-white p-8 rounded-3xl max-w-sm text-center"><div class="w-12 h-12 ${iconColor} rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">${color === 'emerald' ? '✓' : '!'}</div><h3 class="font-black uppercase text-slate-800 mb-2">${title}</h3><p class="text-sm font-medium text-slate-500 mb-6">${msg}</p><button onclick="this.parentElement.parentElement.remove()" class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-black uppercase text-[10px]">FECHAR</button></div>`;
            document.body.appendChild(mod);
        }
        const setupFilters = () => { 
            defaultTeam.forEach(renderAnalista); 
            defaultAreas.forEach(renderAreaCheckbox); 
            defaultFrentes.forEach(f => { const sel = document.getElementById('frente'); if(sel) sel.add(new Option(f, f)); }); 
            // Popula dropdown de dependência
            const depSel = document.getElementById('area_dependencia');
            if(depSel) {
                depSel.add(new Option("Selecione a área...", ""));
                defaultDependencies.forEach(d => depSel.add(new Option(d, d)));
            }
        };
        
        setupFilters(); 
        initAuth();
    </script>
</body>
</html>
