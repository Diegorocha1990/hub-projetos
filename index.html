<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Efici√™ncia Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Nunito+Sans:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --bg-body: #f4f7f9;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
        }
        .input-premium {
            background-color: #ffffff;
            border: 2px solid #1e293b;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
            outline: none;
            font-weight: 700;
        }
        .input-premium:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.1);
        }
        .label-forte {
            font-size: 0.75rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #1e293b;
            margin-bottom: 0.5rem;
            display: block;
        }
        .active-tab {
            color: var(--accent-color);
            border-bottom: 4px solid var(--accent-color);
            font-weight: 900;
        }
        .card-project {
            background: white;
            border-radius: 32px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .card-project:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
        }
        .status-pill {
            font-size: 0.65rem;
            font-weight: 900;
            padding: 4px 12px;
            border-radius: 100px;
            text-transform: uppercase;
        }
        .status-backlog { background-color: #e2e8f0; color: #475569; }
        .status-andamento { background-color: #fef3c7; color: #92400e; }
        .status-finalizado { background-color: #dcfce7; color: #166534; }
        .status-despriorizado { background-color: #fee2e2; color: #991b1b; }

        .kpi-card {
            background: white;
            padding: 1.25rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s;
        }

        .btn-icon-add {
            background: #f1f5f9;
            color: #475569;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-icon-add:hover {
            background: var(--accent-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 1.5rem; /* Espa√ßo de respiro maior entre a flag e o nome */
            padding: 0.6rem 0.8rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .checkbox-item:hover { background: #f1f5f9; }

        .metrica-row {
            display: grid;
            grid-template-columns: 120px 2fr 1fr 1fr 40px;
            gap: 12px;
            align-items: end;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .main-content { margin: 0; padding: 0; }
        }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <div id="loading-overlay">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-32 mb-8 invert" alt="Unico Logo">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
        <p class="text-[10px] uppercase font-bold tracking-widest mt-4 opacity-50">Sincronizando dados...</p>
    </div>

    <!-- Modais -->
    <div id="custom-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[11000] p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl">
            <h3 id="modal-title" class="text-xl font-black mb-4 uppercase tracking-tighter text-center text-slate-800">Adicionar Item</h3>
            <div id="modal-input-container">
                <input type="text" id="modal-input" class="w-full input-premium mb-6" placeholder="Digite o nome...">
            </div>
            <p id="modal-msg" class="text-sm font-bold text-slate-600 mb-6 text-center hidden"></p>
            <div class="flex gap-3">
                <button id="modal-confirm" class="bg-slate-900 text-white font-bold py-3 px-6 rounded-2xl flex-1 transition hover:bg-slate-800 uppercase text-[10px] tracking-widest">Confirmar</button>
                <button onclick="closeCustomModal()" class="bg-slate-100 text-slate-400 font-bold py-3 px-6 rounded-2xl flex-1 transition hover:bg-slate-200 uppercase text-[10px] tracking-widest">Cancelar</button>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center text-slate-800">
            <div class="flex items-center gap-6">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-8" alt="Unico Logo">
                <div id="sync-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] font-black text-green-600 uppercase">Tempo Real</span>
                </div>
            </div>
            <nav class="flex gap-8 h-full items-center text-[11px] font-black uppercase tracking-widest text-slate-400">
                <button onclick="window.switchTab('dashboard')" id="tab-dashboard" class="h-full px-2 active-tab transition-colors">Dashboard</button>
                <button onclick="window.switchTab('form')" id="tab-form" class="h-full px-2 hover:text-slate-900 transition-colors">Novo Projeto</button>
                <button onclick="window.switchTab('list')" id="tab-list" class="h-full px-2 hover:text-slate-900 transition-colors">Projetos</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 mt-4 main-content">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="block no-print text-slate-800">
            <div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4 text-slate-800">
                <div>
                    <h1 class="text-4xl font-black tracking-tighter uppercase leading-none text-slate-800">Estrat√©gia & Opera√ß√£o</h1>
                    <p class="text-slate-400 text-xs font-bold uppercase mt-2 tracking-widest">Vis√£o macro de efici√™ncia corporativa</p>
                </div>
                <div class="flex flex-wrap gap-2 text-slate-800">
                    <select id="dash-filter-period" class="input-premium !py-2 !text-xs shadow-sm" onchange="window.refreshUI()">
                        <option value="all">Todo o Per√≠odo</option>
                        <option value="mes">Mensal (Este M√™s)</option>
                        <option value="trimestre">Trimestral (Este Trimestre)</option>
                        <option value="semestre">Semestral (Este Semestre)</option>
                        <option value="ano">Anual (Este Ano)</option>
                    </select>
                    <select id="dash-filter-area" class="input-premium !py-2 !text-xs shadow-sm" onchange="window.refreshUI()">
                        <option value="">Todas as √Åreas Impactadas</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-12 text-center md:text-left">
                <div class="kpi-card border-l-4 border-slate-900"><p class="label-forte !text-[9px]">Total Projetos</p><h2 id="kpi-total" class="text-2xl font-black text-slate-800">0</h2></div>
                <div class="kpi-card border-l-4 border-cyan-400"><p class="label-forte !text-[9px] text-cyan-600">SLA Geral</p><h2 id="kpi-sla" class="text-2xl font-black text-cyan-600">0%</h2></div>
                <div class="kpi-card border-l-4 border-green-500"><p class="label-forte !text-[9px] text-green-600">No Prazo</p><h2 id="kpi-concluidos-prazo" class="text-2xl font-black text-green-600">0</h2></div>
                <div class="kpi-card border-l-4 border-red-500"><p class="label-forte !text-[9px] text-red-600">Com Atraso</p><h2 id="kpi-concluidos-atraso" class="text-2xl font-black text-red-600">0</h2></div>
                <div class="kpi-card border-l-4 border-amber-400"><p class="label-forte !text-[9px] text-amber-500">Bloqueios</p><h2 id="kpi-blockers" class="text-2xl font-black text-amber-600">0</h2></div>
                <div class="kpi-card border-l-4 border-pink-500"><p class="label-forte !text-[9px] text-pink-600">Prioridade</p><h2 id="kpi-prioridade" class="text-2xl font-black text-pink-600">0</h2></div>
                <div class="kpi-card border-l-4 border-indigo-500"><p class="label-forte !text-[9px] text-indigo-600">Sa√∫de</p><h2 id="kpi-saude" class="text-2xl font-black text-indigo-600">0%</h2></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 text-slate-800">
                <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center text-slate-800">
                    <span class="label-forte mb-6 text-center text-slate-800">Status das Iniciativas</span>
                    <div class="w-full h-56 mt-4"><canvas id="chartStatus"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center text-slate-800">
                    <span class="label-forte mb-6 text-center text-slate-800">√Årea Impactada</span>
                    <div class="w-full h-56 mt-4"><canvas id="chartTime"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center text-slate-800">
                    <span class="label-forte mb-6 text-center text-slate-800">Pilar Estrat√©gico</span>
                    <div class="w-full h-56 mt-4"><canvas id="chartFrente"></canvas></div>
                </div>
            </div>

            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <!-- FORMUL√ÅRIO VIEW -->
        <div id="view-form" class="hidden max-w-5xl mx-auto text-slate-800">
            <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl border-t-[12px] border-cyan-400 print-card mb-12">
                <div class="flex justify-between items-start mb-10">
                    <div>
                        <h2 id="form-title" class="text-3xl font-black uppercase tracking-tighter text-slate-800">Ficha T√©cnica</h2>
                        <p class="text-slate-400 text-sm font-medium">Gest√£o detalhada da iniciativa</p>
                    </div>
                </div>
                
                <form id="project-form" class="space-y-10 text-slate-800">
                    <input type="hidden" id="edit-id" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-slate-800">
                        <div class="md:col-span-2">
                            <label class="label-forte" for="iniciativa">Iniciativa / Projeto</label>
                            <input type="text" id="iniciativa" required class="w-full input-premium text-lg uppercase text-slate-800" placeholder="EX: PROJETO DE EFICI√äNCIA">
                        </div>
                        <div>
                            <label class="label-forte" for="prioridade">Prioridade</label>
                            <select id="prioridade" class="w-full input-premium font-bold text-slate-800">
                                <option value="Baixa">Baixa</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-forte">√Årea Impactada</label>
                            <select id="time" required class="w-full input-premium text-slate-800"></select>
                        </div>
                        <div>
                            <label class="label-forte">Frente de Trabalho</label>
                            <select id="frente" class="w-full input-premium text-slate-800"></select>
                        </div>
                        <div>
                            <label class="label-forte" for="status">Status Atual</label>
                            <select id="status" class="w-full input-premium font-black text-slate-900" onchange="window.toggleConclusionField(this.value)">
                                <option value="Backlog">Backlog</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Finalizado">Finalizado</option>
                                <option value="Despriorizado">Despriorizado</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-forte">Data de In√≠cio</label>
                            <input type="date" id="data_criacao" required class="w-full input-premium">
                        </div>
                        <div>
                            <label class="label-forte">Prazo Final (Target)</label>
                            <input type="date" id="prazo" required class="input-premium w-full">
                        </div>
                        
                        <div id="conclusion-section" class="md:col-span-2 hidden">
                            <label class="label-forte text-green-600">Data de Conclus√£o Real</label>
                            <input type="date" id="data_conclusao" class="input-premium w-full border-green-300">
                        </div>

                        <div class="md:col-span-4 bg-slate-50 p-6 rounded-3xl border-2 border-slate-900 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <label class="label-forte !mb-0">Respons√°veis L√≠deres (Sele√ß√£o M√∫ltipla)</label>
                                <button type="button" onclick="window.openAdderModal('team')" class="btn-icon-add">+</button>
                            </div>
                            <div id="responsaveis-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-2 text-slate-800"></div>
                        </div>

                        <div class="md:col-span-4 bg-slate-100 p-6 rounded-3xl border-2 border-slate-200">
                             <label class="label-forte text-cyan-600">Expectativas de Ganho (KPIs)</label>
                             <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                <div id="metricas-container" class="space-y-3 mb-4 text-slate-800"></div>
                                <button type="button" onclick="window.addMetricaInput()" class="text-[10px] font-black text-cyan-500 hover:text-cyan-700 uppercase tracking-widest">+ Adicionar M√©trica</button>
                             </div>
                        </div>

                        <div class="md:col-span-4">
                            <div class="flex justify-between items-center mb-1">
                                <label class="label-forte text-red-500">üö´ Impedimentos e Bloqueios</label>
                                <label class="flex items-center gap-2 text-[10px] font-black text-slate-400 cursor-pointer">
                                    <input type="checkbox" id="no-blockers" class="w-4 h-4 rounded accent-green-500" onchange="window.toggleImpedimentos(this)"> SEM BLOQUEIOS
                                </label>
                            </div>
                            <textarea id="impedimentos" rows="2" class="input-premium w-full !bg-red-50/20" placeholder="O que est√° a travar o progresso?"></textarea>
                        </div>
                    </div>
                    
                    <div id="status-actions" class="pt-8 flex flex-col md:flex-row gap-4 no-print border-t border-slate-100">
                        <button type="submit" id="btn-submit" class="bg-slate-900 text-white px-10 py-5 rounded-2xl font-black hover:bg-slate-800 transition-all flex-1 uppercase tracking-widest text-xs shadow-xl">Salvar Altera√ß√µes</button>
                        <button type="button" id="btn-delete-project" onclick="window.confirmDeletion()" class="hidden bg-red-500 text-white px-10 py-5 rounded-2xl font-black hover:bg-red-600 transition-all uppercase tracking-widest text-xs shadow-lg">Excluir Projeto</button>
                        <button type="button" onclick="window.resetForm(); window.switchTab('dashboard');" class="bg-slate-100 text-slate-400 px-10 py-5 rounded-2xl font-black hover:bg-slate-200 transition-all uppercase tracking-widest text-xs">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- LISTA VIEW -->
        <div id="view-list" class="hidden no-print text-slate-800">
            <div class="mb-10 flex flex-col md:flex-row justify-between items-center gap-4 text-slate-800">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tight leading-none">Projetos</h1>
                    <p id="project-counter" class="text-slate-400 text-xs font-bold uppercase mt-2">Carregando iniciativas...</p>
                </div>
                
                <div class="flex flex-wrap gap-2 text-slate-800">
                    <select id="list-filter-area" class="input-premium !py-2 !text-[10px]" onchange="window.refreshUI()"><option value="">√Årea Impactada</option></select>
                    <select id="list-filter-leader" class="input-premium !py-2 !text-[10px]" onchange="window.refreshUI()"><option value="">L√≠der</option></select>
                    <select id="list-filter-status" class="input-premium !py-2 !text-[10px]" onchange="window.refreshUI()">
                        <option value="">Todos os Status</option>
                        <option value="Backlog">Backlog</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Despriorizado">Despriorizado</option>
                    </select>
                    <button onclick="window.clearListFilters()" class="text-[10px] font-black text-slate-400 hover:text-red-500 uppercase px-2 transition">Limpar</button>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-200 overflow-hidden">
                <table class="w-full text-left text-slate-800">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-400 uppercase text-[9px] font-black tracking-widest">
                        <tr>
                            <th class="p-8 text-center">Sa√∫de</th>
                            <th class="p-8">Iniciativa</th>
                            <th class="p-8">√Årea</th>
                            <th class="p-8">Respons√°veis</th>
                            <th class="p-8">Status</th>
                            <th class="p-8 text-right">Ac√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-table-body" class="divide-y divide-slate-100 text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURA√á√ÉO OFICIAL - PRESERVADA
        const firebaseConfig = {
            apiKey: "AIzaSyAU8nHiRzTwOkrfd8LY7N-YkJG_S7CE0Xs",
            authDomain: "painel-de-projeto.firebaseapp.com",
            projectId: "painel-de-projeto",
            storageBucket: "painel-de-projeto.firebasestorage.app",
            messagingSenderId: "768185401154",
            appId: "1:768185401154:web:d89782c16620a1bf2852db",
            measurementId: "G-CKMHJJ5C37"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-eficiencia-2026';
        
        let projects = [];
        let dynamicTeam = [];
        let dynamicAreas = [];
        let dynamicFrentes = [];
        let charts = {};
        let currentUser = null;

        const defaultTeam = ["Cauan Pereira Da Silva", "Diego Francisco Rocha", "Hudson Nestor Pereira Cortes", "Lucas Henrique Jantsch", "Luiz Gustavo Ribeiro", "Michael Gabriel Moraes Faria", "Ot√°vio Augusto Oliveira", "Rodrigo Prinz De Paiva", "Simone Thom√© de Andrade"];
        const defaultAreas = ["An√°lise", "CX", "Mesa", "Onboarding", "Comunica√ß√£o"];
        const defFrentes = ["Performance", "Reestrutura√ß√£o", "Automa√ß√£o", "Simplifica√ß√£o"];

        // ATRIBUI√á√ÉO AO OBJETO WINDOW PARA EVITAR REFERECEERROR
        window.startApp = async () => {
            try {
                const cred = await signInAnonymously(auth);
                currentUser = cred.user;
                document.getElementById('sync-indicator')?.classList.remove('hidden');
                setupDynamicListeners();
                setupRealtime();
            } catch (err) { console.error(err); }
        };

        const setupDynamicListeners = () => {
            if (!currentUser) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'team'), (snap) => {
                dynamicTeam = snap.docs.map(doc => doc.data().name);
                window.renderTeamCheckboxes();
                updateLeaderFilters();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'areas'), (snap) => {
                dynamicAreas = snap.docs.map(doc => doc.data().name);
                updateDropdown('time', dynamicAreas, defaultAreas);
                updateDropdown('dash-filter-area', dynamicAreas, defaultAreas, "Todas as √Åreas Impactadas");
                updateDropdown('list-filter-area', dynamicAreas, defaultAreas, "√Årea Impactada");
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'frentes'), (snap) => {
                dynamicFrentes = snap.docs.map(doc => doc.data().name);
                updateDropdown('frente', dynamicFrentes, defFrentes);
            });
        };

        const updateDropdown = (id, dynamic, defaults, firstText) => {
            const el = document.getElementById(id); if(!el) return;
            const cur = el.value;
            const list = Array.from(new Set([...defaults, ...dynamic])).sort();
            el.innerHTML = firstText ? `<option value="">${firstText}</option>` : '<option value="" disabled selected>Selecionar...</option>';
            list.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
            if (cur && list.includes(cur)) el.value = cur;
        };

        const updateLeaderFilters = () => {
            const el = document.getElementById('list-filter-leader'); if(!el) return;
            const cur = el.value;
            const list = Array.from(new Set([...defaultTeam, ...dynamicTeam])).sort();
            el.innerHTML = '<option value="">L√≠der</option>';
            list.forEach(n => el.innerHTML += `<option value="${n}">${n}</option>`);
            if (cur) el.value = cur;
        };

        const setupRealtime = () => {
            if (!currentUser) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), (snap) => {
                projects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                projects.sort((a, b) => (a.data_criacao || "") > (b.data_criacao || "") ? 1 : -1);
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
                window.refreshUI();
            });
        };

        window.switchTab = (t) => {
            ['view-dashboard', 'view-form', 'view-list'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            ['tab-dashboard', 'tab-form', 'tab-list'].forEach(b => document.getElementById(b).classList.toggle('active-tab', b==='tab-'+t));
            window.refreshUI();
        };

        window.refreshUI = () => {
            const tab = document.querySelector('.active-tab')?.id.split('-')[1] || 'dashboard';
            if (tab === 'dashboard') {
                const area = document.getElementById('dash-filter-area')?.value || "";
                const per = document.getElementById('dash-filter-period')?.value || 'all';
                const fil = projects.filter(p => (!area || p.time === area) && isProjectInPeriod(p.data_criacao, per));
                updateKPIs(fil); window.renderDashboard(fil); updateCharts(fil);
            } else if (tab === 'list') {
                const ana = document.getElementById('list-filter-leader')?.value || "";
                const sta = document.getElementById('list-filter-status')?.value || "";
                const are = document.getElementById('list-filter-area')?.value || "";
                const fil = projects.filter(p => (!ana || (Array.isArray(p.responsavel) && p.responsavel.includes(ana))) && (!sta || p.status === sta) && (!are || p.time === are));
                window.renderDetailedList(fil);
                document.getElementById('project-counter').innerText = `${fil.length} INICIATIVAS MAPEADAS`;
            }
        };

        const updateKPIs = (data) => {
            const fin = data.filter(p => p.status === 'Finalizado');
            const onT = fin.filter(p => p.data_conclusao && p.prazo && new Date(p.data_conclusao) <= new Date(p.prazo)).length;
            document.getElementById('kpi-total').innerText = data.length;
            document.getElementById('kpi-concluidos-prazo').innerText = onT;
            document.getElementById('kpi-blockers').innerText = data.filter(p => p.impedimentos?.trim()).length;
            document.getElementById('kpi-prioridade').innerText = data.filter(p => p.prioridade?.includes('Alta')).length;
            const saude = data.length ? Math.round(((data.length - data.filter(p => p.impedimentos?.trim()).length)/data.length)*100) : 100;
            document.getElementById('kpi-saude').innerText = saude + '%';
            document.getElementById('kpi-sla').innerText = (fin.length ? Math.round((onT/fin.length)*100) : 0) + '%';
        };

        window.renderDashboard = (data) => {
            const grid = document.getElementById('projects-grid'); if(!grid) return; grid.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            data.forEach(p => {
                const slug = p.status?.toLowerCase().replace(/\s/g, '') || 'backlog';
                const deadline = p.prazo ? new Date(p.prazo) : null;
                const isLate = p.status !== 'Finalizado' && deadline && today > deadline;
                const alert = isLate ? `<div class="flex items-center gap-2 mt-2 bg-red-50 p-2 rounded-xl border border-red-100 animate-pulse"><span class="w-3 h-3 bg-red-500 rounded-full"></span><span class="text-[9px] font-black text-red-600 uppercase">Aten√ß√£o ao cronograma</span></div>` : "";
                
                let kpisHtml = "";
                if(p.metricas?.length) {
                    kpisHtml = `<div class="mt-4 pt-4 border-t border-slate-50 space-y-2">`;
                    p.metricas.forEach(m => {
                        const icon = m.tipo === 'Redu√ß√£o (-)' 
                            ? `<span class="text-blue-500" title="Redu√ß√£o">‚ñº</span>` 
                            : `<span class="text-green-500" title="Ganho">‚ñ≤</span>`;
                        kpisHtml += `
                            <div class="flex justify-between items-center text-[10px] font-bold">
                                <span class="text-slate-400 uppercase">${icon} ${m.label}</span>
                                <span class="text-slate-700">${m.real || '---'} / ${m.meta}</span>
                            </div>`;
                    });
                    kpisHtml += `</div>`;
                }

                grid.innerHTML += `<div class="card-project p-8 flex flex-col h-full border-t-[12px] text-slate-800" style="border-top-color: ${p.time === 'An√°lise' ? '#00e5ff' : '#000a28'}">
                    <div class="flex justify-between items-start mb-6">
                        <span class="text-[9px] font-black text-slate-300 uppercase">${p.time}</span>
                        <span class="status-pill status-${slug}">${p.status}</span>
                    </div>
                    <h3 class="text-xl font-black mb-2 uppercase leading-tight line-clamp-2">${p.iniciativa}</h3>
                    ${alert}
                    <div class="text-[11px] font-bold space-y-2 my-6 border-l-2 border-slate-50 pl-4 text-slate-500">
                        <p class="flex justify-between"><span>L√çDERES:</span> <span class="text-slate-900">${Array.isArray(p.responsavel) ? p.responsavel.slice(0,2).join(', ') : '---'}</span></p>
                        <p class="flex justify-between"><span>TARGET:</span> <span class="text-slate-900 font-black">${formatDate(p.prazo)}</span></p>
                    </div>
                    ${kpisHtml}
                    <button onclick="window.editProjectByID('${p.id}')" class="bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest mt-auto">Ver Detalhes</button>
                </div>`;
            });
        };

        window.renderDetailedList = (data) => {
            const tbody = document.getElementById('detailed-table-body'); if(!tbody) return; tbody.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            data.forEach(p => {
                const hasBlockers = p.impedimentos && p.impedimentos.trim() !== "";
                const deadline = p.prazo ? new Date(p.prazo) : null;
                const isLate = p.status !== 'Finalizado' && deadline && today > deadline;
                const resps = Array.isArray(p.responsavel) ? p.responsavel.join(', ') : "";
                tbody.innerHTML += `<tr class="hover:bg-slate-50 transition text-slate-800">
                    <td class="p-8 text-center"><div class="flex flex-col items-center gap-1"><span class="w-4 h-4 rounded-full inline-block ${hasBlockers ? 'bg-red-500 shadow-xl shadow-red-200' : 'bg-green-500 shadow-xl shadow-green-200'}"></span>${isLate ? '<span class="text-[7px] font-black text-red-500 uppercase">Aten√ß√£o</span>' : ''}</div></td>
                    <td class="p-8 font-black uppercase text-sm">${p.iniciativa}</td>
                    <td class="p-8 text-slate-400 font-bold text-xs uppercase tracking-wider">${p.time}</td>
                    <td class="p-8 text-xs text-slate-700 font-bold">${resps}</td>
                    <td class="p-8 text-center"><span class="status-pill bg-slate-100 text-slate-600 font-black">${p.status}</span></td>
                    <td class="p-8 text-right flex items-center justify-end gap-3">
                        <button onclick="window.editProjectByID('${p.id}')" class="text-cyan-500 font-black text-[10px] uppercase hover:underline">Editar</button>
                        <button onclick="window.confirmDeletion('${p.id}')" class="text-red-400 hover:text-red-600 p-2 transition" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                </tr>`;
            });
        };

        window.addMetricaInput = (label = '', meta = '', real = '', tipo = 'Ganho (+)') => {
            const container = document.getElementById('metricas-container');
            const div = document.createElement('div');
            div.className = 'metrica-row mb-4 animate-in fade-in slide-in-from-left-2 duration-300 text-slate-800';
            div.innerHTML = `
                <div>
                    <label class="label-forte !text-[9px]">Tipo</label>
                    <select class="metrica-tipo input-premium !py-1.5 !text-[10px] w-full text-slate-800">
                        <option value="Ganho (+)" ${tipo === 'Ganho (+)' ? 'selected' : ''}>Ganho (+)</option>
                        <option value="Redu√ß√£o (-)" ${tipo === 'Redu√ß√£o (-)' ? 'selected' : ''}>Redu√ß√£o (-)</option>
                    </select>
                </div>
                <div><label class="label-forte !text-[9px]">KPI</label><input type="text" class="metrica-label input-premium !py-1.5 !text-[10px] w-full uppercase" value="${label}"></div>
                <div><label class="label-forte !text-[9px]">Meta</label><input type="text" class="metrica-meta input-premium !py-1.5 !text-[10px] w-full" value="${meta}"></div>
                <div><label class="label-forte !text-[9px]">Real</label><input type="text" class="metrica-real input-premium !py-1.5 !text-[10px] w-full" value="${real}"></div>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-300 hover:text-red-500 pb-2 font-black text-xl">√ó</button>`;
            container.appendChild(div);
        };

        window.confirmDeletion = (id = null) => {
            const targetId = id || document.getElementById('edit-id').value;
            if (!targetId) return;
            window.pendingDeleteId = targetId;
            document.getElementById('modal-title').innerText = "Excluir Projeto";
            document.getElementById('modal-input-container').classList.add('hidden');
            document.getElementById('modal-msg').classList.remove('hidden');
            document.getElementById('modal-msg').innerText = "Eliminar permanentemente de toda a base Unico?";
            document.getElementById('custom-modal').classList.replace('hidden', 'flex');
            document.getElementById('modal-confirm').onclick = async () => {
                if (!currentUser) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', window.pendingDeleteId));
                    window.closeCustomModal();
                    if (document.getElementById('edit-id').value === window.pendingDeleteId) {
                        window.resetForm(); window.switchTab('dashboard');
                    }
                } catch (e) { console.error(e); }
            };
        };

        window.openAdderModal = (target) => {
            window.currentModalTarget = target;
            const map = { area: 'Nova √Årea Impactada', frente: 'Nova Frente de Trabalho', team: 'Novo L√≠der' };
            document.getElementById('modal-title').innerText = map[target];
            document.getElementById('modal-input-container').classList.remove('hidden');
            document.getElementById('modal-msg').classList.add('hidden');
            document.getElementById('modal-input').value = '';
            document.getElementById('custom-modal').classList.replace('hidden', 'flex');
            document.getElementById('modal-confirm').onclick = async () => {
                const val = document.getElementById('modal-input').value.trim();
                if(!val || !currentUser) return;
                const col = window.currentModalTarget === 'team' ? 'team' : window.currentModalTarget === 'area' ? 'areas' : 'frentes';
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', col), { name: val });
                window.closeCustomModal();
            };
        };

        window.closeCustomModal = () => document.getElementById('custom-modal').classList.replace('flex', 'hidden');

        window.editProjectByID = (id) => { 
            const p = projects.find(x => x.id === id); 
            if(p) window.editProject(projects.indexOf(p)); 
        };

        window.editProject = (index) => {
            const p = projects[index];
            document.getElementById('edit-id').value = p.id;
            document.getElementById('iniciativa').value = p.iniciativa;
            document.getElementById('prioridade').value = p.prioridade || "Baixa";
            document.getElementById('time').value = p.time || "";
            document.getElementById('frente').value = p.frente || "";
            document.getElementById('status').value = p.status || "Backlog";
            document.getElementById('data_criacao').value = p.data_criacao || "";
            document.getElementById('prazo').value = p.prazo || "";
            document.getElementById('data_conclusao').value = p.data_conclusao || "";
            document.getElementById('impedimentos').value = p.impedimentos || "";
            document.getElementById('nota_inicial').value = p.nota_inicial || "";
            document.getElementById('no-blockers').checked = (!p.impedimentos || p.impedimentos === "");
            window.toggleImpedimentos(document.getElementById('no-blockers'));
            document.getElementById('btn-delete-project').classList.remove('hidden');
            document.getElementById('btn-print-project').classList.remove('hidden');
            window.renderTeamCheckboxes();
            document.querySelectorAll('input[name="responsavel_check"]').forEach(cb => { cb.checked = Array.isArray(p.responsavel) && p.responsavel.includes(cb.value); });
            document.getElementById('envolvidos-container').innerHTML = '';
            if(p.envolvidos) p.envolvidos.forEach(v => window.addEnvolvidoInput(v));
            document.getElementById('metricas-container').innerHTML = '';
            if(p.metricas?.length) p.metricas.forEach(m => window.addMetricaInput(m.label, m.meta, m.real, m.tipo)); else window.addMetricaInput();
            window.toggleConclusionField(p.status);
            window.switchTab('form');
        };

        document.getElementById('project-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if(!currentUser) return;
            const editId = document.getElementById('edit-id').value;
            const leaders = Array.from(document.querySelectorAll('input[name="responsavel_check"]:checked')).map(cb => cb.value);
            const metricas = Array.from(document.querySelectorAll('.metrica-row')).map(row => ({ 
                tipo: row.querySelector('.metrica-tipo').value,
                label: row.querySelector('.metrica-label').value.toUpperCase(), 
                meta: row.querySelector('.metrica-meta').value, 
                real: row.querySelector('.metrica-real').value 
            })).filter(m => m.label.trim());

            const pData = {
                iniciativa: document.getElementById('iniciativa').value.toUpperCase(),
                prioridade: document.getElementById('prioridade').value,
                time: document.getElementById('time').value,
                frente: document.getElementById('frente').value,
                status: document.getElementById('status').value,
                data_criacao: document.getElementById('data_criacao').value,
                prazo: document.getElementById('prazo').value,
                data_conclusao: document.getElementById('data_conclusao')?.value || null,
                responsavel: leaders, metricas,
                impedimentos: document.getElementById('no-blockers').checked ? "" : document.getElementById('impedimentos').value,
                nota_inicial: document.getElementById('nota_inicial').value,
                envolvidos: Array.from(document.querySelectorAll('#envolvidos-container input')).map(i => i.value).filter(v => v.trim())
            };

            try {
                if (editId) {
                    const existing = projects.find(x => x.id === editId);
                    pData.notes = existing?.notes || [{ text: "Editado.", date: new Date().toLocaleDateString('pt-BR') }];
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', editId), pData);
                } else {
                    pData.notes = [{ text: "Iniciado.", date: new Date().toLocaleDateString('pt-BR') }];
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), pData);
                }
                window.resetForm(); window.switchTab('dashboard');
            } catch (err) { console.error(err); }
        });

        window.addEnvolvidoInput = (v = '') => {
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `<input type="text" class="input-premium py-2 text-xs flex-1 uppercase" value="${v}"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 font-bold px-2">√ó</button>`;
            document.getElementById('envolvidos-container').appendChild(div);
        };

        window.toggleImpedimentos = (cb) => {
            const tx = document.getElementById('impedimentos');
            tx.disabled = cb.checked;
            if(cb.checked) { tx.value = ""; tx.classList.add('opacity-40'); } else tx.classList.remove('opacity-40');
        };

        window.toggleConclusionField = (s) => document.getElementById('conclusion-section').classList.toggle('hidden', s !== 'Finalizado');

        window.resetForm = () => {
            document.getElementById('project-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('metricas-container').innerHTML = '';
            window.addMetricaInput();
            document.getElementById('envolvidos-container').innerHTML = '';
            document.getElementById('btn-delete-project').classList.add('hidden');
            document.getElementById('btn-print-project').classList.add('hidden');
            const d = new Date().toISOString().split('T')[0];
            document.getElementById('data_criacao').value = d;
            document.getElementById('prazo').value = d;
        };

        window.renderTeamCheckboxes = () => { 
            const container = document.getElementById('responsaveis-grid'); if(!container) return; 
            const list = Array.from(new Set([...defaultTeam, ...dynamicTeam])).sort(); 
            container.innerHTML = ''; 
            list.forEach(n => container.innerHTML += `<label class="checkbox-item text-xs font-bold text-slate-600"><input type="checkbox" name="responsavel_check" value="${n}" class="w-4 h-4 rounded border-slate-300 accent-cyan-500"><span>${n}</span></label>`); 
        };

        window.clearListFilters = () => { ['list-filter-area', 'list-filter-leader', 'list-filter-status'].forEach(id => document.getElementById(id).value = ""); window.refreshUI(); };

        const isProjectInPeriod = (projDate, period) => {
            if (!projDate || period === 'all') return true;
            const d = new Date(projDate); const now = new Date();
            if (period === 'ano') return d.getFullYear() === now.getFullYear();
            if (period === 'mes') return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
            if (period === 'trimestre') return d.getFullYear() === now.getFullYear() && Math.floor(d.getMonth()/3) === Math.floor(now.getMonth()/3);
            if (period === 'semestre') return d.getFullYear() === now.getFullYear() && (d.getMonth() < 6) === (now.getMonth() < 6);
            return true;
        };

        function updateCharts(data) {
            const countFn = (k) => data.reduce((a,v) => { a[v[k]||'N/A'] = (a[v[k]||'N/A']||0)+1; return a; }, {});
            renderChart('chartStatus', 'pie', countFn('status'), ['#e2e8f0', '#fef3c7', '#dcfce7', '#fee2e2']);
            renderChart('chartTime', 'bar', countFn('time'), '#00e5ff');
            renderChart('chartFrente', 'bar', countFn('frente'), '#000a28');
        }

        const formatDate = (d) => d ? d.split('-').reverse().join('/') : '---';

        onAuthStateChanged(auth, (user) => { if (user) window.startApp(); });
    </script>
</body>
</html>
