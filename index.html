<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Eficiência Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --success-color: #10b981;
            --bg-body: #f8fafc;
            --color-backlog: #94a3b8;
            --color-andamento: #fbbf24;
            --color-finalizado: #10b981;
            --color-despriorizado: #ef4444;
            --u-azul: #00A5FF;
            --u-rosa: #FF1A5C;
            --u-purpura: #A35F9D;
            --u-roxo: #8D7AD2;
            --u-verde: #32B77E;
            --u-azul-pay: #5C86C4;
            --u-azul-escuro: #070047;
            --u-cinza: #333333;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
            -webkit-font-smoothing: antialiased;
        }
        .input-premium {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.65rem 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            font-weight: 600;
            font-size: 0.85rem;
            width: 100%;
        }
        .input-premium:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.08);
        }
        .label-forte {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 0.6rem;
            display: block;
        }
        .active-tab {
            color: var(--primary-color);
            border-bottom: 3px solid var(--accent-color);
            font-weight: 900;
        }
        .kpi-card {
            background: white;
            padding: 1.5rem 1rem;
            border-radius: 1.5rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            gap: 0.4rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }
        .form-section-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        @media (min-width: 768px) { .form-section-box { padding: 2.5rem; } }
        
        .card-project {
            background: white;
            border-radius: 1.5rem;
            border: 1px solid #e2e8f0;
            border-top-width: 8px;
            transition: transform 0.2s;
        }
        .card-project:hover { transform: translateY(-3px); }
        .status-pill { font-size: 0.6rem; font-weight: 900; padding: 3px 10px; border-radius: 100px; text-transform: uppercase; }

        .column-board { background: rgba(226, 232, 240, 0.3); border-radius: 1.5rem; padding: 1.25rem; min-height: 400px; height: fit-content; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 10, 40, 0.5); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 2rem; border-radius: 2rem; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="min-h-screen">

    <div id="loading-overlay" style="position: fixed; inset: 0; background: var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: white; transition: opacity 0.5s;">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-24 md:w-32 mb-8 invert" alt="Unico">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
        <p class="text-[10px] uppercase font-black tracking-widest mt-4 opacity-50">Sincronizando ambiente...</p>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50 no-print text-slate-800">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 md:h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 md:gap-8">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-6" alt="Unico Logo">
                <div id="sync-indicator" class="hidden sm:flex items-center gap-2 px-3 md:px-4 py-1.5 bg-green-50 rounded-full border border-green-100">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[8px] md:text-[10px] font-black text-green-600 uppercase tracking-widest">Tempo Real</span>
                </div>
            </div>
            <nav class="flex gap-4 md:gap-10 h-full items-center text-[9px] md:text-[11px] font-bold uppercase tracking-widest text-slate-400">
                <button onclick="window.switchTab('dashboard')" id="tab-dashboard" class="h-full px-1 md:px-2 active-tab transition-all">Dash</button>
                <button onclick="window.switchTab('form')" id="tab-form" class="h-full px-1 md:px-2 hover:text-slate-900 transition-all">Novo</button>
                <button onclick="window.switchTab('list')" id="tab-list" class="h-full px-1 md:px-2 hover:text-slate-900 transition-all">Projetos</button>
                <button onclick="window.switchTab('archive')" id="tab-archive" class="h-full px-1 md:px-2 hover:text-slate-900 transition-all">Arquivo</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 mt-2 md:mt-4 text-slate-800">
        <!-- VIEW DASHBOARD -->
        <div id="view-dashboard" class="block no-print">
            <div class="mb-8 md:mb-12 flex flex-col xl:flex-row xl:items-end justify-between gap-6 text-slate-900">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none">Estratégia & Operação</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 md:mt-3 tracking-widest">Painel de Decisões e Eficiência</p>
                </div>
                <div class="flex flex-wrap gap-2 md:gap-3 items-center">
                    <input type="text" id="search-dashboard" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Buscar projeto..." oninput="window.refreshUI()">
                    <select id="dash-filter-period" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="all">Todo o Período</option><option value="mes">Mensal</option></select>
                    <select id="dash-filter-analista" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Analistas (Todos)</option></select>
                    <select id="dash-filter-area" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()"><option value="">Áreas (Todas)</option></select>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6 mb-8 md:mb-12">
                <div class="kpi-card"><p class="label-forte !mb-0 text-[9px] text-slate-400">Total</p><h2 id="kpi-total" class="text-2xl font-black">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-cyan-500">SLA Geral</p><h2 id="kpi-sla" class="text-2xl font-black">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-green-500">Aderência</p><h2 id="kpi-performance" class="text-2xl font-black">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-blue-500">Riscos</p><h2 id="kpi-riscos" class="text-xl font-black">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-red-500">Problemas</p><h2 id="kpi-problemas" class="text-xl font-black">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-indigo-500">Saúde</p><h2 id="kpi-saude" class="text-2xl font-black">100%</h2></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="column-board">
                    <label class="label-forte">Backlog <span id="count-backlog" class="text-[10px] font-black ml-2 opacity-50">0</span></label>
                    <div id="grid-backlog" class="space-y-4"></div>
                </div>
                <div class="column-board">
                    <label class="label-forte text-amber-600">Em Andamento <span id="count-andamento" class="text-[10px] font-black ml-2 opacity-50">0</span></label>
                    <div id="grid-andamento" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- VIEW LISTA -->
        <div id="view-list" class="hidden no-print">
            <h1 class="text-2xl font-black uppercase mb-8">Projetos</h1>
            <div class="bg-white rounded-2xl border overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase">
                        <tr><th class="p-6">Iniciativa</th><th class="p-6">Área</th><th class="p-6">Prazo</th><th class="p-6 text-right">Ações</th></tr>
                    </thead>
                    <tbody id="detailed-table-body" class="divide-y text-[12px] font-bold"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW ARQUIVO -->
        <div id="view-archive" class="hidden no-print">
            <h1 class="text-2xl font-black uppercase mb-8">Arquivo</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="column-board"><label class="label-forte text-emerald-600">Finalizados</label><div id="grid-finalizado" class="space-y-4"></div></div>
                <div class="column-board"><label class="label-forte text-red-600">Despriorizados</label><div id="grid-despriorizado" class="space-y-4"></div></div>
            </div>
        </div>

        <!-- VIEW FORM -->
        <div id="view-form" class="hidden max-w-4xl mx-auto">
            <h2 class="text-2xl font-black uppercase mb-8">Nova Iniciativa</h2>
            <form id="project-form" class="space-y-6">
                <input type="hidden" id="edit-id" value="">
                <div class="form-section-box">
                    <label class="label-forte">Identificação</label>
                    <input type="text" id="iniciativa" required class="input-premium uppercase" placeholder="Nome do Projeto">
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div><label class="label-forte">Área</label><select id="time" required class="input-premium"></select></div>
                        <div><label class="label-forte">Prazo</label><input type="date" id="prazo" required class="input-premium"></div>
                    </div>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-slate-800 transition-all">Salvar Projeto</button>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DEFINIÇÕES GLOBAIS SEGURAS ---
        const defaultTeam = ["Cauan Pereira", "Diego Rocha", "Hudson Cortes", "Lucas Jantsch", "Luiz Ribeiro", "Michael Faria", "Otávio Oliveira", "Rodrigo Paiva", "Simone Andrade"];
        const defaultAreas = ["Análise", "CX", "Comunicação", "Mesa", "Onboarding", "Tecnologia"];
        
        let user = null, projects = [], charts = {};
        
        // --- FUNÇÕES DE INTERFACE ---
        window.hideOverlay = () => {
            const o = document.getElementById('loading-overlay');
            if (o) { o.style.opacity = '0'; setTimeout(() => o.style.display = 'none', 500); }
        };

        window.switchTab = (t) => {
            const views = ['dashboard', 'form', 'list', 'archive'];
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) el.classList.add('hidden');
                const btn = document.getElementById('tab-' + v);
                if (btn) btn.classList.remove('active-tab');
            });
            const target = document.getElementById('view-' + t);
            if (target) target.classList.remove('hidden');
            const targetBtn = document.getElementById('tab-' + t);
            if (targetBtn) targetBtn.classList.add('active-tab');
        };

        window.refreshUI = () => {
            const today = new Date(); today.setHours(0,0,0,0);
            const bG = document.getElementById('grid-backlog'), aG = document.getElementById('grid-andamento');
            if (bG) bG.innerHTML = ''; if (aG) aG.innerHTML = '';

            projects.forEach(p => {
                const card = createCard(p, today);
                if (p.status === 'Backlog' && bG) bG.innerHTML += card;
                if (p.status === 'Em Andamento' && aG) aG.innerHTML += card;
            });
            
            if (document.getElementById('kpi-total')) document.getElementById('kpi-total').innerText = projects.length;
            if (document.getElementById('count-backlog')) document.getElementById('count-backlog').innerText = projects.filter(p => p.status === 'Backlog').length;
            if (document.getElementById('count-andamento')) document.getElementById('count-andamento').innerText = projects.filter(p => p.status === 'Em Andamento').length;
        };

        const createCard = (p, today) => {
            const isLate = p.prazo && new Date(p.prazo) < today;
            const topColor = p.status === 'Backlog' ? '#94a3b8' : '#fbbf24';
            return `<div class="card-project p-5 flex flex-col" style="border-top-color: ${topColor}">
                <span class="text-[8px] font-black uppercase text-slate-400">${p.time || 'N/A'}</span>
                <h3 class="text-sm font-black mt-1 mb-4 uppercase">${p.iniciativa}</h3>
                <div class="text-[10px] space-y-1">
                    <p class="flex justify-between"><span>PRAZO:</span> <b>${p.prazo?.split('-').reverse().join('/') || '--'}</b></p>
                    <p class="flex justify-between ${isLate ? 'text-red-500' : ''}"><span>STATUS:</span> <b>${isLate ? 'EM ATRASO' : 'NO PRAZO'}</b></p>
                </div>
            </div>`;
        };

        // --- INICIALIZAÇÃO FIREBASE (REGRA 3) ---
        const initSystem = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "", authDomain: "", projectId: "" };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-eficiencia-2026';
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // Autenticação obrigatória antes de qualquer consulta
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        const projectsRef = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
                        onSnapshot(projectsRef, (snap) => {
                            projects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.refreshUI();
                            window.hideOverlay();
                        }, (err) => {
                            console.error("Firestore Permission Error:", err);
                            window.hideOverlay();
                        });
                    } else {
                        window.hideOverlay();
                    }
                });

            } catch (err) {
                console.error("System Init Error:", err);
                window.hideOverlay();
            }
        };

        // --- SETUP INICIAL ---
        const setup = () => {
            try {
                const timeSel = document.getElementById('time');
                if (timeSel) defaultAreas.forEach(a => timeSel.add(new Option(a, a)));
                initSystem();
            } catch (e) {
                console.error("Setup Logic Error:", e);
                window.hideOverlay();
            }
        };

        setup();
    </script>
</body>
</html>
