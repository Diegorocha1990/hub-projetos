<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Projetos - Unico</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --bg-body: #f4f7f9;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
            scroll-behavior: smooth;
        }
        .active-tab {
            border-bottom: 4px solid var(--accent-color);
            color: var(--accent-color);
            font-weight: 900;
        }
        .status-backlog { background-color: #e2e8f0; color: #475569; }
        .status-andamento { background-color: #fef3c7; color: #92400e; }
        .status-finalizado { background-color: #dcfce7; color: #166534; }
        .status-despriorizado { background-color: #fee2e2; color: #991b1b; }

        .priority-high { color: #dc2626; font-weight: 900; }
        .priority-medium { color: #d97706; font-weight: 700; }
        .priority-low { color: #059669; font-weight: 700; }

        #loading-screen {
            position: fixed;
            inset: 0;
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s ease;
        }

        .input-mega-visivel {
            background-color: #ffffff !important;
            border: 3px solid #1e293b !important;
            color: #000000 !important;
            padding: 1rem !important;
            border-radius: 0.75rem !important;
            width: 100%;
            font-weight: 700;
            font-size: 0.95rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .input-mega-visivel:focus {
            border-color: var(--accent-color) !important;
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.2);
        }
        .label-forte {
            display: block;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            color: #475569;
            margin-bottom: 0.4rem;
            letter-spacing: 0.05em;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .checkbox-item:hover { background: #f1f5f9; }

        .filter-select {
            background-color: #fff;
            border: 2px solid #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            font-weight: 700;
            outline: none;
            color: #475569;
            cursor: pointer;
        }
        .filter-select:focus { border-color: var(--accent-color); }

        .kpi-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; }
            .print-card { box-shadow: none !important; border: 1px solid #eee !important; width: 100% !important; margin: 0 !important; }
            .print-title { font-size: 20pt !important; }
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div id="loading-screen">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-32 mb-8 invert" alt="Unico">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-400 mb-4"></div>
        <p id="loading-text" class="text-[10px] uppercase tracking-widest font-bold opacity-60">Sincronizando dados...</p>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center text-slate-800">
            <div class="flex items-center gap-6">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-24 md:w-28" alt="Unico">
                <div id="sync-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] font-black text-green-600 uppercase">Tempo Real</span>
                </div>
            </div>
            
            <nav class="flex gap-4 md:gap-10 h-full items-center text-[11px] md:text-xs uppercase tracking-tighter md:tracking-widest font-black">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="h-full px-1 transition-all active-tab hover:text-cyan-400">Dashboard</button>
                <button onclick="switchTab('form')" id="tab-form" class="h-full px-1 transition-all hover:text-cyan-400">Novo Projeto</button>
                <button onclick="switchTab('list')" id="tab-list" class="h-full px-1 transition-all hover:text-cyan-400">Projetos</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 mt-10 main-content">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="block no-print">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-6">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tight">Estrat√©gia & Opera√ß√£o</h1>
                    <p class="text-slate-400 font-bold uppercase text-xs mt-1">Vis√£o Macro de Efici√™ncia</p>
                </div>

                <div class="flex flex-wrap gap-2">
                    <select id="dash-filter-periodo" class="filter-select" onchange="refreshUI()">
                        <option value="all">Todo o Per√≠odo</option>
                        <option value="mes">Este M√™s</option>
                        <option value="trimestre">Este Trimestre</option>
                        <option value="semestre">Este Semestre</option>
                        <option value="ano">Este Ano</option>
                    </select>
                    <select id="dash-filter-analista" class="filter-select" onchange="refreshUI()">
                        <option value="">L√≠der do Projeto</option>
                    </select>
                    <select id="dash-filter-area" class="filter-select" onchange="refreshUI()">
                        <option value="">√Årea Beneficiada</option>
                        <option value="An√°lise">An√°lise</option>
                        <option value="CX">CX</option>
                        <option value="Mesa">Mesa</option>
                        <option value="Tecnologia">Tecnologia</option>
                    </select>
                    <button onclick="clearDashFilters()" class="text-[10px] font-black text-slate-300 hover:text-red-500 uppercase px-2">Limpar</button>
                </div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10 text-center">
                <div class="kpi-card border-l-4 border-slate-900">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">Total de Projetos</p>
                    <h2 id="kpi-total" class="text-3xl font-black text-slate-900">0</h2>
                </div>
                <div class="kpi-card border-l-4 border-green-400">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">Saud√°veis (Sem Bloqueio)</p>
                    <h2 id="kpi-saude" class="text-3xl font-black text-green-500">0%</h2>
                </div>
                <div class="kpi-card border-l-4 border-red-500">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">Impedimentos Ativos</p>
                    <h2 id="kpi-blockers" class="text-3xl font-black text-red-600">0</h2>
                </div>
                <div class="kpi-card border-l-4 border-cyan-400">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">Foco Alta Prioridade</p>
                    <h2 id="kpi-prioridade" class="text-3xl font-black text-cyan-500">0</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center">
                    <h3 class="text-[10px] font-black text-slate-300 uppercase mb-6 tracking-widest">Status da Carteira</h3>
                    <div class="w-full h-56"><canvas id="chartStatus"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center">
                    <h3 class="text-[10px] font-black text-slate-300 uppercase mb-6 tracking-widest">Esfor√ßo por √Årea</h3>
                    <div class="w-full h-56"><canvas id="chartTime"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center">
                    <h3 class="text-[10px] font-black text-slate-300 uppercase mb-6 tracking-widest">Pilar Estrat√©gico</h3>
                    <div class="w-full h-56"><canvas id="chartFrente"></canvas></div>
                </div>
            </div>

            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <!-- FORMUL√ÅRIO -->
        <div id="view-form" class="hidden max-w-4xl mx-auto">
            <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl border-t-[12px] border-cyan-400 print-card">
                <div class="flex justify-between items-center mb-10">
                    <h2 id="form-title" class="text-3xl font-black text-slate-800 print-title uppercase tracking-tight">Dados do Projeto</h2>
                    <button id="btn-print-project" onclick="window.print()" class="no-print hidden bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-2 hover:bg-slate-800 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                        Exportar PDF
                    </button>
                </div>
                
                <form id="project-form" class="space-y-8">
                    <input type="hidden" id="edit-id" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                        <div class="md:col-span-2">
                            <label class="label-forte">Nome do Projeto / Iniciativa</label>
                            <input type="text" id="iniciativa" required class="input-mega-visivel" placeholder="EX: AUTOMA√á√ÉO LIVENESS">
                        </div>

                        <div>
                            <label class="label-forte">Prioridade</label>
                            <select id="prioridade" class="input-mega-visivel">
                                <option value="Baixa">üü¢ Baixa</option>
                                <option value="M√©dia">üü° M√©dia</option>
                                <option value="Alta">üî¥ Alta</option>
                            </select>
                        </div>

                        <div>
                            <label class="label-forte">√Årea Beneficiada</label>
                            <select id="time" required class="input-mega-visivel">
                                <option value="An√°lise">An√°lise</option>
                                <option value="CX">CX</option>
                                <option value="Mesa">Mesa</option>
                                <option value="Tecnologia">Tecnologia</option>
                            </select>
                        </div>

                        <div>
                            <label class="label-forte">Frente de Trabalho</label>
                            <select id="frente" class="input-mega-visivel">
                                <option value="Performance">Performance</option>
                                <option value="Reestrutura√ß√£o">Reestrutura√ß√£o</option>
                                <option value="Automa√ß√£o">Automa√ß√£o</option>
                                <option value="Simplifica√ß√£o">Simplifica√ß√£o</option>
                            </select>
                        </div>

                        <div>
                            <label class="label-forte">Status Atual</label>
                            <select id="status" class="input-mega-visivel">
                                <option value="Backlog">Backlog</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Finalizado">Finalizado</option>
                                <option value="Despriorizado">Despriorizado</option>
                            </select>
                        </div>

                        <div class="md:col-span-3 bg-white p-6 rounded-3xl border-2 border-slate-900 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <label class="label-forte">Respons√°veis L√≠deres</label>
                                <button type="button" onclick="addNewTeamMember()" class="text-[10px] font-black bg-cyan-100 text-cyan-600 px-3 py-1 rounded-full hover:bg-cyan-200 transition">+ ADICIONAR L√çDER</button>
                            </div>
                            <div id="responsaveis-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-2"></div>
                        </div>

                        <div class="md:col-span-3 bg-slate-50 p-6 rounded-3xl border-2 border-slate-200">
                            <div class="flex justify-between items-center mb-4">
                                <label class="label-forte text-slate-400">Outras Pessoas Envolvidas (Time de Apoio)</label>
                                <button type="button" onclick="addEnvolvidoInput()" class="bg-slate-900 text-white p-2 rounded-full hover:bg-black transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                </button>
                            </div>
                            <div id="envolvidos-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>

                        <div>
                            <label class="label-forte">Data de In√≠cio</label>
                            <input type="date" id="data_criacao" required class="input-mega-visivel">
                        </div>

                        <div>
                            <label class="label-forte">Prazo Final (Target)</label>
                            <input type="date" id="prazo" required class="input-mega-visivel">
                        </div>

                        <div id="campo-conclusao" class="hidden">
                            <label class="label-forte text-green-600 font-black">Data de Conclus√£o Real</label>
                            <input type="date" id="data_conclusao" class="input-mega-visivel border-green-400">
                        </div>

                        <div class="md:col-span-3">
                            <div class="flex justify-between items-center mb-1">
                                <label class="label-forte text-red-500">üö´ Impedimentos, Gargalos ou Bloqueios</label>
                                <label class="flex items-center gap-2 text-[10px] font-black text-slate-400 cursor-pointer">
                                    <input type="checkbox" id="no-blockers" class="w-4 h-4 rounded accent-green-500" onchange="toggleImpedimentos(this)"> SEM BLOQUEIOS
                                </label>
                            </div>
                            <textarea id="impedimentos" rows="2" class="input-mega-visivel border-red-300 bg-red-50" placeholder="O que est√° travando?"></textarea>
                        </div>

                        <div class="md:col-span-3 bg-slate-100 p-6 rounded-3xl border-2 border-slate-200">
                            <div class="flex justify-between items-center mb-4">
                                <label class="label-forte text-slate-500">Links √öteis (Documenta√ß√£o, Dashboards)</label>
                                <button type="button" onclick="addLinkInput()" class="bg-slate-900 text-white p-2 rounded-full hover:bg-black transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                </button>
                            </div>
                            <div id="links-container" class="space-y-3"></div>
                        </div>

                        <div class="md:col-span-3">
                            <label class="label-forte">Hist√≥rico de Evolu√ß√£o / Notas</label>
                            <textarea id="nota_inicial" rows="5" class="input-mega-visivel" placeholder="Principais avan√ßos e milestones"></textarea>
                        </div>
                    </div>
                    
                    <div class="pt-8 flex flex-col md:flex-row gap-4 no-print">
                        <button type="submit" class="bg-slate-900 text-white px-10 py-5 rounded-2xl font-black hover:bg-slate-800 transition-all flex-1 uppercase tracking-widest text-xs shadow-xl">Salvar Informa√ß√µes</button>
                        <button type="button" onclick="resetForm(); switchTab('dashboard');" class="bg-slate-100 text-slate-400 px-10 py-5 rounded-2xl font-black hover:bg-slate-200 transition-all uppercase tracking-widest text-xs">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- LISTA GERAL -->
        <div id="view-list" class="hidden no-print">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10">
                <h1 class="text-4xl font-black text-slate-900 tracking-tight">Projetos</h1>
                
                <div class="flex flex-wrap gap-2">
                    <select id="filter-analista" class="filter-select" onchange="refreshUI()">
                        <option value="">L√≠der do Projeto</option>
                    </select>
                    <select id="filter-status" class="filter-select" onchange="refreshUI()">
                        <option value="">Status</option>
                        <option value="Backlog">Backlog</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Despriorizado">Despriorizado</option>
                    </select>
                    <select id="filter-area" class="filter-select" onchange="refreshUI()">
                        <option value="">√Årea</option>
                        <option value="An√°lise">An√°lise</option>
                        <option value="CX">CX</option>
                        <option value="Mesa">Mesa</option>
                        <option value="Tecnologia">Tecnologia</option>
                    </select>
                    <button onclick="clearListFilters()" class="text-[10px] font-black text-slate-400 hover:text-red-500 uppercase px-2">Limpar</button>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-200 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500">
                        <tr class="text-[10px] uppercase font-black tracking-widest">
                            <th class="p-8">Sa√∫de</th>
                            <th class="p-8">Iniciativa</th>
                            <th class="p-8">√Årea</th>
                            <th class="p-8">Respons√°veis</th>
                            <th class="p-8 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- FIREBASE INTEGRATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAU8nHiRzTwOkrfd8LY7N-YkJG_S7CE0Xs",
            authDomain: "painel-de-projeto.firebaseapp.com",
            projectId: "painel-de-projeto",
            storageBucket: "painel-de-projeto.firebasestorage.app",
            messagingSenderId: "768185401154",
            appId: "1:768185401154:web:d89782c16620a1bf2852db",
            measurementId: "G-CKMHJJ5C37"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-eficiencia-2026';
        
        let projects = [];
        let dynamicTeam = [];
        let charts = {};
        let currentUser = null;

        const defaultTeam = ["Cauan Pereira Da Silva", "Diego Francisco Rocha", "Hudson Nestor Pereira Cortes Da S...", "Lucas Henrique Jantsch", "Luiz Gustavo Ribeiro", "Michael Gabriel Moraes Faria", "Ot√°vio Augusto Oliveira", "Rodrigo Prinz De Paiva", "Simone Thom√© de Andrade"];

        const startApp = async () => {
            try {
                const cred = await signInAnonymously(auth);
                currentUser = cred.user;
                document.getElementById('sync-indicator').classList.remove('hidden');
                setupTeamListener();
                setupRealtime();
            } catch (err) { console.error(err); }
        };

        const setupTeamListener = () => {
            const teamCol = collection(db, 'artifacts', appId, 'public', 'data', 'team');
            onSnapshot(teamCol, (snapshot) => {
                dynamicTeam = snapshot.docs.map(doc => doc.data().name);
                renderTeamCheckboxes();
                updateAllAnalistaFilters();
            });
        };

        const updateAllAnalistaFilters = () => {
            const fullTeam = Array.from(new Set([...defaultTeam, ...dynamicTeam])).sort((a,b) => a.localeCompare(b));
            ['dash-filter-analista', 'filter-analista'].forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                const currentVal = select.value;
                select.innerHTML = '<option value="">L√≠der do Projeto</option>';
                fullTeam.forEach(name => select.innerHTML += `<option value="${name}">${name}</option>`);
                select.value = currentVal;
            });
        };

        const setupRealtime = () => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
            onSnapshot(colRef, (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                projects.sort((a, b) => b.data_criacao > a.data_criacao ? 1 : -1);
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
                refreshUI();
            });
        };

        const isProjectInPeriod = (projDate, period) => {
            if (!projDate || period === 'all') return true;
            const date = new Date(projDate);
            const now = new Date();
            const year = now.getFullYear();
            if (period === 'ano') return date.getFullYear() === year;
            if (period === 'mes') return date.getFullYear() === year && date.getMonth() === now.getMonth();
            if (period === 'trimestre') {
                const currentQuarter = Math.floor(now.getMonth() / 3);
                const projQuarter = Math.floor(date.getMonth() / 3);
                return date.getFullYear() === year && currentQuarter === projQuarter;
            }
            if (period === 'semestre') {
                const currentSemester = now.getMonth() < 6 ? 0 : 1;
                const projSemester = date.getMonth() < 6 ? 0 : 1;
                return date.getFullYear() === year && currentSemester === projSemester;
            }
            return true;
        };

        const getFilteredData = (source) => {
            const pre = source === 'dash' ? 'dash-' : '';
            const analista = document.getElementById(`${pre}filter-analista`).value;
            const status = document.getElementById(`${pre}filter-status`)?.value || '';
            const area = document.getElementById(`${pre}filter-area`).value;
            const period = document.getElementById('dash-filter-periodo')?.value || 'all';

            return projects.filter(p => {
                const mAnalista = !analista || (Array.isArray(p.responsavel) ? p.responsavel.includes(analista) : p.responsavel === analista);
                const mStatus = !status || p.status === status;
                const mArea = !area || p.time === area;
                const mPeriod = source === 'dash' ? isProjectInPeriod(p.data_criacao, period) : true;
                return mAnalista && mStatus && mArea && mPeriod;
            });
        };

        window.refreshUI = () => {
            const activeTabBtn = document.querySelector('.active-tab');
            const currentTab = activeTabBtn ? activeTabBtn.id.split('-')[1] : 'dashboard';
            
            if (currentTab === 'dashboard') {
                const filtered = getFilteredData('dash');
                renderDashboard(filtered);
                updateCharts(filtered);
                updateKPIs(filtered);
            } else if (currentTab === 'list') {
                renderDetailedList(getFilteredData('list'));
            }
        };

        const updateKPIs = (data) => {
            document.getElementById('kpi-total').innerText = data.length;
            const blockers = data.filter(p => p.impedimentos && p.impedimentos.trim() !== "").length;
            document.getElementById('kpi-blockers').innerText = blockers;
            document.getElementById('kpi-prioridade').innerText = data.filter(p => p.prioridade === 'Alta').length;
            const saude = data.length > 0 ? Math.round(((data.length - blockers) / data.length) * 100) : 0;
            document.getElementById('kpi-saude').innerText = saude + '%';
        };

        window.clearDashFilters = () => {
            document.getElementById('dash-filter-periodo').value = 'all';
            document.getElementById('dash-filter-analista').value = '';
            document.getElementById('dash-filter-area').value = '';
            refreshUI();
        };

        window.clearListFilters = () => {
            document.getElementById('filter-analista').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-area').value = '';
            refreshUI();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            const btn = document.getElementById(`tab-${tab}`);
            if(btn) btn.classList.add('active-tab');
            document.getElementById('view-dashboard').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('view-form').classList.toggle('hidden', tab !== 'form');
            document.getElementById('view-list').classList.toggle('hidden', tab !== 'list');
            refreshUI();
            if(tab === 'form') initFormDates();
        };

        window.renderDashboard = (data) => {
            const grid = document.getElementById('projects-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            const today = new Date();
            today.setHours(0,0,0,0);

            data.forEach((proj) => {
                const statusSlug = proj.status?.toLowerCase().replace(/\s/g, '') || 'backlog';
                const statusClass = `status-${statusSlug === 'emandamento' ? 'andamento' : statusSlug}`;
                const hasBlockers = proj.impedimentos && proj.impedimentos.trim() !== "";
                const priorityClass = `priority-${proj.prioridade?.toLowerCase() || 'baixa'}`;
                const lastNote = proj.notes && proj.notes.length > 0 ? proj.notes[proj.notes.length - 1] : { text: 'Iniciado.' };
                
                // L√≥gica do Farol de Alerta (Gentil)
                let cronogramaAlert = "";
                if (proj.status !== 'Finalizado' && proj.prazo) {
                    const deadline = new Date(proj.prazo);
                    if (today > deadline) {
                        cronogramaAlert = `
                            <div class="flex items-center gap-2 mt-2 bg-red-50 p-2 rounded-xl border border-red-100 animate-pulse">
                                <span class="w-3 h-3 bg-red-500 rounded-full shadow-[0_0_8px_rgba(239,68,68,0.5)]"></span>
                                <span class="text-[9px] font-black text-red-600 uppercase tracking-tighter">Aten√ß√£o ao cronograma</span>
                            </div>
                        `;
                    }
                }

                grid.innerHTML += `
                    <div class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100 flex flex-col h-full hover:shadow-2xl transition-all relative group">
                        ${hasBlockers ? '<div class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full p-2 shadow-xl animate-bounce z-10"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div>' : ''}
                        <div class="flex justify-between items-start mb-6">
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-300">${proj.time} | ${proj.frente}</span>
                            <span class="px-3 py-1 rounded-full text-[9px] font-black tracking-widest ${statusClass} uppercase">${proj.status}</span>
                        </div>
                        <h3 class="text-xl font-black mb-2 text-slate-900 leading-tight">${proj.iniciativa}</h3>
                        ${cronogramaAlert}
                        <div class="text-[11px] my-8 space-y-4 border-l-2 border-slate-50 pl-4 font-bold text-slate-600">
                            <p class="flex justify-between"><span>L√≠deres</span> <span class="text-slate-900 text-right">${Array.isArray(proj.responsavel) ? proj.responsavel.join(', ') : proj.responsavel}</span></p>
                            <p class="flex justify-between"><span>Target</span> <span class="text-slate-900">${formatDate(proj.prazo)}</span></p>
                        </div>
                        <div class="bg-slate-50 p-5 rounded-2xl flex-grow mb-8 border border-slate-100 overflow-hidden group-hover:bg-slate-100 transition-colors">
                            <p class="text-[9px] font-black text-slate-300 uppercase mb-2">Evolu√ß√£o</p>
                            <p class="text-[11px] text-slate-500 italic line-clamp-3 leading-relaxed">"${lastNote.text}"</p>
                        </div>
                        <button onclick="editProjectByID('${proj.id}')" class="bg-slate-900 text-white py-4 px-6 rounded-2xl font-black transition hover:bg-slate-800 uppercase text-[10px] tracking-widest">Ver Detalhes</button>
                    </div>
                `;
            });
        };

        window.renderDetailedList = (data) => {
            const tbody = document.getElementById('detailed-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const today = new Date();
            today.setHours(0,0,0,0);

            data.forEach((proj) => {
                const hasBlockers = proj.impedimentos && proj.impedimentos.trim() !== "";
                const deadline = proj.prazo ? new Date(proj.prazo) : null;
                const isLate = proj.status !== 'Finalizado' && deadline && today > deadline;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-8 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <span class="w-4 h-4 rounded-full inline-block ${hasBlockers ? 'bg-red-500 shadow-red-200 shadow-xl' : 'bg-green-500 shadow-green-100 shadow-xl'}"></span>
                                ${isLate ? '<span class="text-[7px] font-black text-red-500 uppercase">Aten√ß√£o</span>' : ''}
                            </div>
                        </td>
                        <td class="p-8 font-black text-slate-900 text-sm">${proj.iniciativa}</td>
                        <td class="p-8 text-slate-400 font-bold text-xs uppercase">${proj.time}</td>
                        <td class="p-8 text-slate-700 font-black text-xs">${Array.isArray(proj.responsavel) ? proj.responsavel.slice(0,2).join(', ') : proj.responsavel}</td>
                        <td class="p-8"><span class="px-3 py-1 rounded-full text-[9px] font-black bg-slate-100 uppercase">${proj.status}</span></td>
                        <td class="p-8 flex gap-6"><button onclick="editProjectByID('${proj.id}')" class="text-cyan-500 font-black text-[10px] uppercase hover:underline">Editar</button></td>
                    </tr>
                `;
            });
        };

        window.updateCharts = (data) => {
            if (data.length === 0) return;
            renderChart('chartStatus', 'pie', countBy(data, 'status'), ['#e2e8f0', '#fef3c7', '#dcfce7', '#fee2e2']);
            renderChart('chartTime', 'bar', countBy(data, 'time'), '#00e5ff');
            renderChart('chartFrente', 'bar', countBy(data, 'frente'), '#000a28');
        };

        function countBy(arr, key) { return arr.reduce((acc, obj) => { const val = obj[key] || 'Outros'; acc[val] = (acc[val] || 0) + 1; return acc; }, {}); }

        function renderChart(canvasId, type, dataMap, colors) {
            if (charts[canvasId]) charts[canvasId].destroy();
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            charts[canvasId] = new Chart(canvas.getContext('2d'), {
                type: type,
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{ data: Object.values(dataMap), backgroundColor: colors, borderWidth: 0, borderRadius: type === 'bar' ? 12 : 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: type === 'pie', position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } },
                    scales: type === 'bar' ? { y: { beginAtZero: true, grid: { display: false }, ticks: { font: { size: 9 } } }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } } : {}
                }
            });
        }

        window.editProjectByID = (id) => {
            const index = projects.findIndex(p => p.id === id);
            if(index !== -1) editProject(index);
        };

        window.editProject = (index) => {
            const proj = projects[index];
            document.getElementById('edit-id').value = proj.id;
            document.getElementById('form-title').innerText = "Ficha T√©cnica";
            document.getElementById('iniciativa').value = proj.iniciativa;
            document.getElementById('prioridade').value = proj.prioridade || 'Baixa';
            document.getElementById('time').value = proj.time;
            document.getElementById('frente').value = proj.frente;
            document.getElementById('status').value = proj.status;
            document.getElementById('data_criacao').value = proj.data_criacao;
            document.getElementById('prazo').value = proj.prazo;
            document.getElementById('data_conclusao').value = proj.data_conclusao || '';
            document.getElementById('impedimentos').value = proj.impedimentos || '';
            document.getElementById('nota_inicial').value = proj.notes?.map(n => `[${n.date}] ${n.text}`).join('\n\n') || '';
            document.querySelectorAll('input[name="responsavel_check"]').forEach(cb => { cb.checked = Array.isArray(proj.responsavel) ? proj.responsavel.includes(cb.value) : proj.responsavel === cb.value; });
            document.getElementById('envolvidos-container').innerHTML = '';
            if(proj.envolvidos) proj.envolvidos.forEach(p => addEnvolvidoInput(p));
            document.getElementById('links-container').innerHTML = '';
            if(proj.links) proj.links.forEach(url => addLinkInput(url));
            document.getElementById('no-blockers').checked = (!proj.impedimentos || proj.impedimentos === "");
            toggleImpedimentos(document.getElementById('no-blockers'));
            document.getElementById('btn-print-project').classList.remove('hidden');
            document.getElementById('campo-conclusao').classList.toggle('hidden', proj.status !== 'Finalizado');
            switchTab('form');
        };

        window.resetForm = () => {
            document.getElementById('project-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('links-container').innerHTML = '';
            document.getElementById('envolvidos-container').innerHTML = '';
            document.getElementById('form-title').innerText = "Novo Registro";
            document.getElementById('campo-conclusao').classList.add('hidden');
            document.getElementById('no-blockers').checked = false;
            toggleImpedimentos(document.getElementById('no-blockers'));
            initFormDates();
        };

        document.getElementById('project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            const editId = document.getElementById('edit-id').value;
            const selectedResponsaveis = Array.from(document.querySelectorAll('input[name="responsavel_check"]:checked')).map(cb => cb.value);
            const pData = {
                iniciativa: document.getElementById('iniciativa').value.toUpperCase(),
                prioridade: document.getElementById('prioridade').value,
                time: document.getElementById('time').value,
                frente: document.getElementById('frente').value,
                status: document.getElementById('status').value,
                data_criacao: document.getElementById('data_criacao').value,
                prazo: document.getElementById('prazo').value,
                data_conclusao: document.getElementById('data_conclusao').value || null,
                responsavel: selectedResponsaveis,
                impedimentos: document.getElementById('no-blockers').checked ? "" : document.getElementById('impedimentos').value,
                links: Array.from(document.querySelectorAll('#links-container input')).map(i => i.value).filter(v => v.trim() !== ""),
                envolvidos: Array.from(document.querySelectorAll('#envolvidos-container input')).map(i => i.value).filter(v => v.trim() !== "")
            };
            try {
                if (editId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', editId), pData);
                else {
                    pData.notes = [{ text: document.getElementById('nota_inicial').value || "Iniciado.", date: new Date().toLocaleDateString('pt-BR') }];
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), pData);
                }
                resetForm(); switchTab('dashboard');
            } catch (err) { console.error(err); }
        });

        const renderTeamCheckboxes = () => {
            const container = document.getElementById('responsaveis-grid');
            if (!container) return;
            const fullTeam = Array.from(new Set([...defaultTeam, ...dynamicTeam])).sort((a,b) => a.localeCompare(b));
            container.innerHTML = '';
            fullTeam.forEach(name => {
                container.innerHTML += `<label class="checkbox-item text-xs font-bold text-slate-600"><input type="checkbox" name="responsavel_check" value="${name}" class="w-4 h-4 rounded accent-cyan-500"><span>${name}</span></label>`;
            });
        };

        window.addNewTeamMember = async () => {
            const newName = prompt("Nome completo:");
            if (newName && newName.trim() !== "") await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'team'), { name: newName.trim() });
        };

        window.addEnvolvidoInput = (val = '') => {
            const div = document.createElement('div');
            div.className = 'flex gap-2 link-row';
            div.innerHTML = `<input type="text" class="input-mega-visivel py-3 text-sm flex-1" value="${val}"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`;
            document.getElementById('envolvidos-container').appendChild(div);
        };

        window.addLinkInput = (url = '') => {
            const div = document.createElement('div');
            div.className = 'flex gap-2 link-row';
            div.innerHTML = `<input type="url" class="input-mega-visivel py-3 text-sm flex-1" value="${url}"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`;
            document.getElementById('links-container').appendChild(div);
        };

        window.toggleImpedimentos = (checkbox) => {
            const textarea = document.getElementById('impedimentos');
            if (checkbox.checked) {
                textarea.value = "";
                textarea.disabled = true;
                textarea.classList.add('opacity-50', 'bg-slate-50');
                textarea.classList.remove('bg-red-50');
            } else {
                textarea.disabled = false;
                textarea.classList.remove('opacity-50', 'bg-slate-50');
                textarea.classList.add('bg-red-50');
            }
        };

        const initFormDates = () => {
            const today = new Date().toISOString().split('T')[0];
            if(!document.getElementById('data_criacao').value) document.getElementById('data_criacao').value = today;
            if(!document.getElementById('prazo').value) document.getElementById('prazo').value = today;
        };

        const formatDate = (d) => d ? d.split('-').reverse().join('/') : '-';

        document.getElementById('status').addEventListener('change', function() {
            document.getElementById('campo-conclusao').classList.toggle('hidden', this.value !== 'Finalizado');
        });

        startApp();
    </script>
</body>
</html>
