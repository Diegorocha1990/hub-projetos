<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Eficiência Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Nunito+Sans:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #000a28; --accent-color: #00e5ff; --bg-body: #f4f7f9; }
        body { font-family: 'Nunito Sans', sans-serif; background-color: var(--bg-body); color: var(--primary-color); }
        .input-premium { background-color: #ffffff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1rem; transition: all 0.2s; outline: none; font-weight: 700; width: 100%; }
        .input-premium:focus { border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.1); }
        .label-forte { font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; color: #475569; margin-bottom: 0.5rem; display: block; }
        .active-tab { color: var(--accent-color); border-bottom: 4px solid var(--accent-color); font-weight: 900; }
        .card-project { background: white; border-radius: 32px; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .status-pill { font-size: 0.65rem; font-weight: 900; padding: 4px 12px; border-radius: 100px; text-transform: uppercase; }
        .status-backlog { background-color: #e2e8f0; color: #475569; }
        .status-andamento { background-color: #fef3c7; color: #92400e; }
        .status-finalizado { background-color: #dcfce7; color: #166534; }
        .status-despriorizado { background-color: #fee2e2; color: #991b1b; }
        .kpi-card { background: white; padding: 1.25rem; border-radius: 1.5rem; border: 1px solid #f1f5f9; display: flex; flex-direction: column; justify-content: center; }
        #loading-overlay { position: fixed; inset: 0; background: var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: white; transition: opacity 0.5s; }
        .tooltip-container { position: relative; display: inline-block; cursor: help; }
        .tooltip-text { visibility: hidden; width: 200px; background-color: #334155; color: #fff; text-align: center; border-radius: 8px; padding: 10px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 10px; font-weight: bold; text-transform: none; line-height: 1.4; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-32 mb-8 invert" alt="Unico">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-8" alt="Unico Logo">
                <div id="sync-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] font-black text-green-600 uppercase">Tempo Real</span>
                </div>
            </div>
            <nav class="flex gap-8 h-full items-center text-[11px] font-black uppercase tracking-widest text-slate-400">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="h-full px-2 active-tab">Dashboard</button>
                <button onclick="switchTab('form')" id="tab-form" class="h-full px-2">Novo Projeto</button>
                <button onclick="switchTab('list')" id="tab-list" class="h-full px-2">Lista Geral</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 mt-4">
        
        <div id="view-dashboard" class="block">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-10">
                <div class="kpi-card border-l-4 border-slate-900"><p class="label-forte">Total</p><h2 id="kpi-total" class="text-2xl font-black">0</h2></div>
                <div class="kpi-card border-l-4 border-cyan-400"><p class="label-forte text-cyan-600">SLA</p><h2 id="kpi-sla" class="text-2xl font-black text-cyan-600">0%</h2></div>
                <div class="kpi-card border-l-4 border-green-500"><p class="label-forte text-green-600">No Prazo</p><h2 id="kpi-concluidos-prazo" class="text-2xl font-black text-green-600">0</h2></div>
                <div class="kpi-card border-l-4 border-red-500"><p class="label-forte text-red-600">Atraso</p><h2 id="kpi-concluidos-atraso" class="text-2xl font-black text-red-600">0</h2></div>
                <div class="kpi-card border-l-4 border-amber-400"><p class="label-forte text-amber-500">Bloqueios</p><h2 id="kpi-blockers" class="text-2xl font-black text-amber-600">0</h2></div>
                <div class="kpi-card border-l-4 border-pink-500"><p class="label-forte text-pink-600">Alta Prior.</p><h2 id="kpi-prioridade" class="text-2xl font-black text-pink-600">0</h2></div>
                <div class="kpi-card border-l-4 border-indigo-500"><p class="label-forte text-indigo-600">Saúde</p><h2 id="kpi-saude" class="text-2xl font-black text-indigo-600">0%</h2></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm h-72"><canvas id="chartStatus"></canvas></div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm h-72"><canvas id="chartTime"></canvas></div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm h-72"><canvas id="chartFrente"></canvas></div>
            </div>

            <div class="bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-sm mb-12">
                <span class="label-forte">Capacidade por Líder</span>
                <div class="h-80 w-full"><canvas id="chartCapacidade"></canvas></div>
            </div>

            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
        </div>

        <div id="view-form" class="hidden">
            <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl border-t-[12px] border-cyan-400">
                <form id="project-form" class="space-y-8">
                    <input type="hidden" id="edit-id" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="md:col-span-2">
                            <label class="label-forte">Nome da Iniciativa</label>
                            <input type="text" id="iniciativa" required class="input-premium uppercase" placeholder="Nome do Projeto">
                        </div>
                        <div>
                            <label class="label-forte">Prioridade</label>
                            <select id="prioridade" class="input-premium">
                                <option value="Baixa">Baixa</option>
                                <option value="Média">Média</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-forte flex items-center gap-2">
                                Esforço 
                                <span class="tooltip-container text-cyan-500 font-black">ⓘ
                                    <span class="tooltip-text">RÁPIDO: Execução rápida/individual.<br>INTERMEDIÁRIO: Envolve mais pessoas/áreas.<br>ESTRUTURANTE: Alta complexidade/Longo prazo.</span>
                                </span>
                            </label>
                            <select id="esforco" required class="input-premium">
                                <option value="Rápido">Rápido</option>
                                <option value="Intermediário">Intermediário</option>
                                <option value="Estruturante">Estruturante</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label class="label-forte">Área</label><select id="time" class="input-premium" required></select></div>
                        <div><label class="label-forte">Frente</label><select id="frente" class="input-premium" required></select></div>
                        <div><label class="label-forte">Status Atual</label><select id="status" class="input-premium font-black" onchange="window.updateInternalStatus(this.value)"><option value="Backlog">Backlog</option><option value="Em Andamento">Em Andamento</option><option value="Finalizado">Finalizado</option><option value="Despriorizado">Despriorizado</option></select></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                            <label class="label-forte">Datas</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[9px] font-black uppercase text-slate-400">Início</label><input type="date" id="data_criacao" class="input-premium !py-2"></div>
                                <div><label class="text-[9px] font-black uppercase text-slate-400">Target</label><input type="date" id="prazo" class="input-premium !py-2"></div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                            <label class="label-forte">Responsáveis</label>
                            <div id="responsaveis-grid" class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto pr-2"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <textarea id="nota_inicial" class="input-premium h-32" placeholder="Descrição da iniciativa..."></textarea>
                        <textarea id="impedimentos" class="input-premium h-32 border-red-100 bg-red-50/20" placeholder="Houve bloqueios?"></textarea>
                    </div>

                    <div id="closure-dates" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-slate-50 rounded-3xl border border-slate-200">
                        <div id="container-conclusao">
                            <label class="label-forte text-green-600">Data Conclusão</label>
                            <input type="date" id="data_conclusao" class="input-premium">
                            <textarea id="comentario_conclusao" class="input-premium mt-2 h-16" placeholder="Notas finais..."></textarea>
                        </div>
                        <div id="container-cancelamento">
                            <label class="label-forte text-red-600">Data Despriorização</label>
                            <input type="date" id="data_cancelamento" class="input-premium">
                            <textarea id="comentario_cancelamento" class="input-premium mt-2 h-16" placeholder="Motivo..."></textarea>
                        </div>
                    </div>

                    <div class="flex gap-4 pt-10 border-t">
                        <button type="submit" id="btn-submit" class="bg-slate-900 text-white px-10 py-5 rounded-2xl font-black uppercase text-xs tracking-widest flex-1">Salvar Iniciativa</button>
                        <button type="button" onclick="switchTab('dashboard')" class="bg-white border px-10 py-5 rounded-2xl font-black uppercase text-xs text-slate-400">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="view-list" class="hidden">
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b text-[9px] font-black uppercase text-slate-400 tracking-widest">
                        <tr><th class="p-6">Prioridade</th><th class="p-6">Iniciativa</th><th class="p-6">Área</th><th class="p-6">Status</th><th class="p-6 text-right">Ações</th></tr>
                    </thead>
                    <tbody id="detailed-table-body" class="divide-y"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'hub-unico-2026';

        let projects = [];
        let charts = {};
        const defaultTeam = ["Cauan Pereira Da Silva", "Diego Francisco Rocha", "Hudson Nestor Pereira Cortes", "Lucas Henrique Jantsch", "Luiz Gustavo Ribeiro", "Michael Gabriel Moraes Faria", "Otávio Augusto Oliveira", "Rodrigo Prinz De Paiva", "Simone Thomé de Andrade"];
        const defaultAreas = ["Análise", "CX", "Dados", "Processos", "Planejamento", "Comunicação"];
        const defaultFrentes = ["Performance", "Reestruturação", "Automação", "Simplificação"];

        // Funções de Proteção
        const safeSetText = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; };
        const safeSetValue = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };

        // Inicialização
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('sync-indicator').classList.remove('hidden');
                setupLists();
                setupRealtimeProjects();
            }
        });

        const setupLists = () => {
            const timeSel = document.getElementById('time');
            const frenteSel = document.getElementById('frente');
            const teamGrid = document.getElementById('responsaveis-grid');

            if(timeSel) timeSel.innerHTML = defaultAreas.map(a => `<option value="${a}">${a}</option>`).join('');
            if(frenteSel) frenteSel.innerHTML = defaultFrentes.map(f => `<option value="${f}">${f}</option>`).join('');
            if(teamGrid) teamGrid.innerHTML = defaultTeam.map(name => `<label class="flex items-center gap-2 text-[10px] font-bold"><input type="checkbox" name="resp" value="${name}" class="w-3 h-3"> ${name}</label>`).join('');
        };

        const setupRealtimeProjects = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('loading-overlay').style.display = 'none';
                refreshUI();
            });
        };

        window.refreshUI = () => {
            updateKPIs(projects);
            renderDashboard(projects);
            updateCharts(projects);
            renderList(projects);
        };

        const updateKPIs = (data) => {
            safeSetText('kpi-total', data.length);
            safeSetText('kpi-prioridade', data.filter(p => p.prioridade === 'Alta').length);
            safeSetText('kpi-blockers', data.filter(p => p.impedimentos?.trim()).length);
            const finished = data.filter(p => p.status === 'Finalizado');
            safeSetText('kpi-concluidos-prazo', finished.length);
            const saude = data.length ? Math.round(((data.length - data.filter(p => p.impedimentos?.trim()).length)/data.length)*100) : 100;
            safeSetText('kpi-saude', saude + '%');
        };

        window.renderDashboard = (data) => {
            const grid = document.getElementById('projects-grid');
            if(!grid) return;
            grid.innerHTML = data.map(p => `
                <div class="card-project p-8 flex flex-col h-full border-t-[10px]" style="border-top-color: ${p.prioridade === 'Alta' ? '#fb7185' : '#00e5ff'}">
                    <span class="text-[9px] font-black uppercase text-slate-300">${p.time} | ${p.esforco}</span>
                    <h3 class="text-lg font-black mt-2 uppercase">${p.iniciativa}</h3>
                    <div class="flex-grow mt-4 mb-6 text-[11px] text-slate-500 italic">"${p.nota_inicial || 'Sem descrição.'}"</div>
                    <div class="flex justify-between items-center">
                        <span class="status-pill status-${p.status?.toLowerCase().replace(/\s/g, '')}">${p.status}</span>
                        <button onclick="editProjectByID('${p.id}')" class="text-cyan-500 font-black text-[10px] hover:underline">ABRIR FICHA</button>
                    </div>
                </div>
            `).join('');
        };

        window.editProjectByID = (id) => {
            const p = projects.find(x => x.id === id);
            if(p) {
                safeSetValue('edit-id', p.id);
                safeSetValue('iniciativa', p.iniciativa || "");
                safeSetValue('prioridade', p.prioridade || "Baixa");
                safeSetValue('esforco', p.esforco || "Rápido");
                safeSetValue('time', p.time || "");
                safeSetValue('frente', p.frente || "");
                safeSetValue('status', p.status || "Backlog");
                safeSetValue('nota_inicial', p.nota_inicial || "");
                safeSetValue('impedimentos', p.impedimentos || "");
                
                document.querySelectorAll('input[name="resp"]').forEach(cb => {
                    cb.checked = Array.isArray(p.responsavel) && p.responsavel.includes(cb.value);
                });

                window.updateInternalStatus(p.status);
                switchTab('form');
            }
        };

        window.updateInternalStatus = (v) => {
            const section = document.getElementById('closure-dates');
            if(section) {
                section.classList.toggle('hidden', v !== 'Finalizado' && v !== 'Despriorizado');
                document.getElementById('container-conclusao')?.classList.toggle('hidden', v !== 'Finalizado');
                document.getElementById('container-cancelamento')?.classList.toggle('hidden', v !== 'Despriorizado');
            }
        };

        document.getElementById('project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "Sincronizando...";
            
            const editId = document.getElementById('edit-id').value;
            const resps = Array.from(document.querySelectorAll('input[name="resp"]:checked')).map(c => c.value);

            const data = {
                iniciativa: document.getElementById('iniciativa').value.toUpperCase(),
                prioridade: document.getElementById('prioridade').value,
                esforco: document.getElementById('esforco').value,
                time: document.getElementById('time').value,
                frente: document.getElementById('frente').value,
                status: document.getElementById('status').value,
                nota_inicial: document.getElementById('nota_inicial').value,
                impedimentos: document.getElementById('impedimentos').value,
                responsavel: resps,
                data_criacao: document.getElementById('data_criacao').value,
                prazo: document.getElementById('prazo').value
            };

            try {
                if(editId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', editId), data);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), data);
                switchTab('dashboard');
                document.getElementById('project-form').reset();
            } catch(err) { console.error(err); }
            finally { btn.innerText = "Salvar Iniciativa"; }
        });

        window.renderList = (data) => {
            const body = document.getElementById('detailed-table-body');
            if(body) body.innerHTML = data.map(p => `
                <tr class="text-xs font-bold hover:bg-slate-50 transition">
                    <td class="p-6 text-slate-400">${p.prioridade}</td>
                    <td class="p-6 uppercase">${p.iniciativa}</td>
                    <td class="p-6">${p.time}</td>
                    <td class="p-6"><span class="status-pill status-${p.status?.toLowerCase().replace(/\s/g, '')}">${p.status}</span></td>
                    <td class="p-6 text-right"><button onclick="editProjectByID('${p.id}')" class="text-cyan-500 hover:underline">EDITAR</button></td>
                </tr>
            `).join('');
        };

        window.updateCharts = (data) => {
            renderSimpleChart('chartStatus', 'pie', data, 'status', ['#e2e8f0', '#fef3c7', '#dcfce7', '#fee2e2']);
            renderSimpleChart('chartFrente', 'bar', data, 'frente', ['#000a28', '#00e5ff', '#fbbf24', '#cbd5e1']);
            renderCapacidade(data);
        };

        function renderSimpleChart(id, type, data, key, colors) {
            if(charts[id]) charts[id].destroy();
            const counts = data.reduce((acc, obj) => { acc[obj[key]] = (acc[obj[key]] || 0) + 1; return acc; }, {});
            const ctx = document.getElementById(id)?.getContext('2d');
            if(ctx) charts[id] = new Chart(ctx, { type: type, data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: colors }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function renderCapacidade(data) {
            const id = 'chartCapacidade'; if(charts[id]) charts[id].destroy();
            const datasets = [
                { label: 'Rápido', data: defaultTeam.map(l => data.filter(p => p.responsavel?.includes(l) && p.esforco === 'Rápido').length), backgroundColor: '#00e5ff' },
                { label: 'Estruturante', data: defaultTeam.map(l => data.filter(p => p.responsavel?.includes(l) && p.esforco === 'Estruturante').length), backgroundColor: '#000a28' }
            ];
            const ctx = document.getElementById(id)?.getContext('2d');
            if(ctx) charts[id] = new Chart(ctx, { type: 'bar', data: { labels: defaultTeam.map(n => n.split(' ')[0]), datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });
        }

        window.switchTab = (t) => {
            ['view-dashboard', 'view-form', 'view-list'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            ['tab-dashboard', 'tab-form', 'tab-list'].forEach(btn => document.getElementById(btn).classList.toggle('active-tab', btn==='tab-'+t));
            if(t === 'form' && !document.getElementById('edit-id').value) {
                document.getElementById('project-form').reset();
                safeSetValue('data_criacao', new Date().toISOString().split('T')[0]);
                safeSetValue('prazo', new Date().toISOString().split('T')[0]);
            }
        };

        signInAnonymously(auth).catch(console.error);
    </script>
</body>
</html>
